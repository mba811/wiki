<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Linux VPS Ubuntu 系统配置指南 - Wiki · Tsong khapa</title>
    <meta name="keywords" content="simiki, wiki, python, simple"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Linux">Linux</a>&nbsp;&#187;&nbsp;Linux VPS Ubuntu 系统配置指南
    <span class="updated">Page Updated&nbsp;
      2015-01-30 22:01
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Linux VPS Ubuntu 系统配置指南</div>

  <h2 id="_1">目录</h2>
<ul>
<li>1 拿到的帐号</li>
<li>2 如何远程访问</li>
<li>3 如何上传和下载文件</li>
<li>4 更新软件源 (不可跳过)</li>
<li>5 安装常用软件 (不可跳过)</li>
<li>6 使用 Apache 搭建站点<ul>
<li>6.1 安装 Apache2 Web 服务</li>
<li>6.2 开启 Apache2 的伪静态</li>
<li>6.3 安装 mysql 数据库服务</li>
<li>6.4 mysql 数据库管理</li>
<li>6.5 mysql 数据库优化</li>
<li>6.6 安装php环境</li>
<li>6.7 测试站点</li>
<li>6.7.1 安装 phpsysinfo</li>
<li>6.7.2 安装 php 探针</li>
<li>6.7.3 安装 phpmyadmin</li>
<li>6.8 配置虚拟站点</li>
<li>6.8.1 配置域名</li>
<li>6.8.2 上传程序</li>
<li>6.8.3 多域名配置</li>
<li>6.8.4 Apache2 伪静态</li>
<li>6.8.5 修改上传文件权限</li>
<li>6.8.6 安装配置</li>
<li>6.9 Apache2 301 跳转</li>
<li>6.10 Apache2 优化</li>
<li>6.11 查看 Apache2 日志</li>
</ul>
</li>
<li>7 使用 Nginx 搭建站点<ul>
<li>7.1 删除 apache2</li>
<li>7.2 安装 php5-fpm php5-cgi</li>
<li>7.3 安装 mysql</li>
<li>7.4 安装 nginx</li>
<li>7.5 测试站点</li>
<li>7.5.1 安装phpsysinfo</li>
<li>7.5.2 安装 php 探针</li>
<li>7.5.3 安装 phpmyadmin</li>
<li>7.6 配置虚拟站点</li>
<li>7.6.1 配置域名</li>
<li>7.6.2 上传程序</li>
<li>7.6.3 多域名配置</li>
<li>7.6.4 Nginx 伪静态</li>
<li>7.6.5 修改上传文件权限</li>
<li>7.6.6 安装配置</li>
<li>7.7 nginx 301 跳转</li>
<li>7.8 nginx 优化</li>
<li>7.9 nginx 限制同一IP的并发数和连接流量</li>
<li>7.10 查看 nginx 日志</li>
<li>7.11 配置CDN或反向代理</li>
</ul>
</li>
<li>8 安装邮件服务器</li>
<li>9 搭建临时的FTP服务<ul>
<li>9.1 下载 pyftpdlib 库</li>
<li>9.2 开启匿名ftp服务</li>
<li>9.3 开启允许写入ftp服务</li>
<li>9.4 登录ftp的账号</li>
<li>9.5 关闭ftp服务</li>
</ul>
</li>
<li>10 VPS 自我监控<ul>
<li>10.1 监控内存和负载</li>
<li>10.2 监控网站并发数</li>
</ul>
</li>
<li>11 安全相关事项<ul>
<li>11.1 防止扫描</li>
<li>11.2 防止php木马</li>
<li>11.3 木马基本检查和手工清除</li>
<li>11.4 根据访问日志批量封IP</li>
<li>11.5 关闭邮件服务</li>
</ul>
</li>
<li>12 备份站点<ul>
<li>12.1 备份站点配置文件</li>
<li>12.1.1 备份Apache配置文件</li>
<li>12.1.2 备份Nginx配置文件</li>
<li>12.1.3 备份Mysql配置文件</li>
<li>12.2 备份站点文件</li>
<li>12.3 备份数据库</li>
</ul>
</li>
<li>13 恢复站点<ul>
<li>13.1 恢复站点配置文件</li>
<li>13.1.1 恢复Apache配置文件</li>
<li>13.1.2 恢复Nginx配置文件</li>
<li>13.1.3 恢复Mysql配置文件</li>
<li>13.2 恢复站点文件</li>
<li>13.3 恢复数据库</li>
</ul>
</li>
<li>14 使用 Dropbox 每天自动备份<ul>
<li>14.1 注册 Dropbox</li>
<li>14.2 安装 Dropbox 客户端</li>
<li>14.3 设置帐号</li>
<li>14.4 开始使用</li>
<li>14.5 自动运行 Dropbox</li>
<li>14.6 自动每天备份数据库和站点</li>
</ul>
</li>
<li>15 使用 BitTorrent Sync 备份系统<ul>
<li>15.1 说明</li>
<li>15.2 安装</li>
<li>15.3 使用</li>
<li>15.4 客户端安装</li>
</ul>
</li>
<li>16 安装 Zend Guard Loader</li>
<li>17 关于Zend Optimizer<ul>
<li>17.1 php 降级</li>
<li>17.2 php 高级安装技巧</li>
<li>17.3 安装 Zend Optimizer</li>
<li>17.4 安装成功验证</li>
<li>17.5 重启 Web 服务</li>
</ul>
</li>
<li>18 VPN 和代理<ul>
<li>18.1 安装 OpenVPN</li>
<li>18.1.1 开启 Tun/Tap 支持</li>
<li>18.1.2 安装 openvpn</li>
<li>18.1.3 配置 openvpn</li>
<li>18.1.4 配置 防火墙</li>
<li>18.1.5 配置客户端</li>
<li>18.2 安装 PPTP VPN</li>
<li>18.2.1 开启 PPP 支持</li>
<li>18.2.2 安装 pptpd 服务</li>
<li>18.2.3 配置 pptpd</li>
<li>18.2.4 配置防火墙</li>
<li>18.2.5 检查日志</li>
<li>18.3 安装 L2TP VPN</li>
<li>18.3.1 安装 xl2tpd</li>
<li>18.3.2 配置 xl2tpd</li>
<li>18.3.3 配置防火墙</li>
<li>18.3.4 启动 xl2tpd</li>
<li>18.3.5 安装 IPSec</li>
<li>18.3.6 配置 IPSec</li>
<li>18.3.7 测试 ipsec</li>
<li>18.3.8 开启 xl2tpd 的 ipsec 支持</li>
<li>18.4 安装 IPSec VPN</li>
<li>18.4.1 安装编译环境</li>
<li>18.4.2 安装 strongswan</li>
<li>18.4.3 配置 strongswan</li>
<li>18.4.4 创建用户和密钥</li>
<li>18.4.5 配置防火墙</li>
<li>18.4.6 运行</li>
<li>18.4.7 客户端</li>
<li>18.5 安装 Shadowsocks</li>
<li>18.5.1 服务端</li>
<li>18.5.2 客户端</li>
<li>18.6 安装 ShadowVPN</li>
<li>18.6.1 服务端</li>
<li>18.6.2 客户端</li>
</ul>
</li>
<li>19 额外支持<ul>
<li>19.1 XEN VPS 增加交换分区大小</li>
<li>19.2 配置 php 加速器</li>
<li>19.3 安装 JAVA</li>
</ul>
</li>
<li>20 日常维护<ul>
<li>20.1 查看硬盘剩余空间大小</li>
<li>20.2 查看硬盘可用文件数</li>
<li>20.3 查看内存剩余大小</li>
<li>20.4 如何从其他网站上下载文件</li>
<li>20.5 常用服务重启</li>
<li>20.6 查看内存被什么消耗</li>
<li>20.7 动态显示系统程序情况</li>
<li>20.8 mysql 常用命令</li>
<li>20.9 在线解压缩</li>
<li>20.10 封掉某个IP或IP段</li>
<li>20.11 查看日志</li>
<li>20.12 查看网络流量</li>
<li>20.13 更多命令参考</li>
</ul>
</li>
<li>21 根据压力测试来调整最大并发数<ul>
<li>21.1 测试内存的使用情况</li>
<li>21.2 安装压力测试软件</li>
<li>21.3 开始压力测试</li>
<li>21.4 进一步压力测试</li>
<li>21.5 配置并发参数</li>
</ul>
</li>
<li>22 常见故障<ul>
<li>22.1 "Temporary failure resolving" 或 正在解析主机...失败，未知的名称或服务</li>
<li>22.2 "locale: Cannot set LC_ALL to default locale: No such file or directory"</li>
<li>22.3 修正时区</li>
<li>22.4 开启 GBK/GB2312 支持</li>
<li>22.5 修复cron问题</li>
<li>22.6 禁止执行的命令</li>
<li>22.7 使用 mtr 检测网络丢包</li>
<li>22.8 VPS之间备份、下载、上传需要限速</li>
<li>22.8.1 常用软件限速</li>
<li>22.8.2 采用 trickle 限速</li>
<li>22.9 快速安装配置lnmp的命令</li>
</ul>
</li>
<li>23 常用链接</li>
</ul>
<h2 id="_2">拿到的帐号</h2>
<p>VPS 开通后，你将收到如下的帐号： </p>
<div class="hlcode"><pre><span class="n">VPS</span> <span class="n">IP</span> <span class="n">Address</span><span class="o">:</span> <span class="mf">184.82.9.30</span>
<span class="n">SSH</span> <span class="n">Root</span> <span class="n">Password</span><span class="o">:</span> <span class="n">pass001</span>
</pre></div>


<p>面板地址在 <a href="http://vps.ubuntu.org.cn/vm/" title="http://vps.ubuntu.org.cn/vm/">http://vps.ubuntu.org.cn/vm/</a> 需要使用你的开通时留下的邮箱注册。 </p>
<p>以下的指南都是针对 ubuntu 的，请centos或其它Linux用户到面板reload到ubuntu 12.04 x86 然后继续。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Attention_niels_epting.svg&amp;variant=zh-cn" title="Attention niels epting.svg">![][2]</a> 注意：如果你安装 ubuntu 14.04 可能会无法登录，提示访问拒绝，这并不是密码输入错误了，而是因为 sshd 的默认配置里面禁止了 root 帐号登录，所以你需要使用面板的 临时通道 上去，逐行执行如下命令开启 root 登录权限： </p>
<div class="hlcode"><pre>   <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//wiki.ubuntu.org.cn/images/thumb/5/51/Attention_niels_epting.svg/18px-Attention_niels_epting.svg.png</span>
</pre></div>


<p>sed -i "s/PermitRootLogin.*$/PermitRootLogin yes/" /etc/ssh/sshd_config<br />
    service ssh restart</p>
<p>顺便提一句，如果你是老手，不用开启 root 登录，可以直接创建一个普通帐号，加入到 sudo 组，使用sudo 来执行命令，这样更安全。 </p>
<h2 id="_3">如何远程访问</h2>
<p>Linux VPS支持ssh远程访问，因此需要使用putty工具来访问。 </p>
<p>1 下载putty </p>
<p>下载地址： <a href="http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe" title="http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe">http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe</a></p>
<p>2 运行putty </p>
<p>这个程序不需要安装，下载后直接运行，后在Host地址输入VPS的IP如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty1.png&amp;variant=zh-cn" title="Image:Vps_putty1.png"><img alt="Image:Vps_putty1.png" src="http://wiki.ubuntu.org.cn/images/1/1a/Vps_putty1.png" /></a></p>
<p>3 登录vps </p>
<p>点击上图中的 Open 按钮，第一次登录会出现确认密钥的提示，如下图，请点击 “是” 按钮。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty2.png&amp;variant=zh-cn" title="Image:Vps_putty2.png"><img alt="Image:Vps_putty2.png" src="http://wiki.ubuntu.org.cn/images/e/e4/Vps_putty2.png" /></a></p>
<p>4 如下图输入登录用户名 root 回车，继续输入密码。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Attention_niels_epting.svg&amp;variant=zh-cn" title="Attention niels epting.svg"><img alt="" src="http://wiki.ubuntu.org.cn/images/thumb/5/51/Attention_niels_epting.svg/18px-Attention_niels_epting.svg.png" /></a> <strong>注意输入密码是不会显示 “*” 的，</strong>同时密码是区分大小写的。 </p>
<p>有个技巧，直接去复制密码后，鼠标点击 putty 的输入密码窗口，直接按下鼠标右键，然后回车即可登录。 在putty的窗口按下鼠标右键表示粘贴。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty3.png&amp;variant=zh-cn" title="Image:Vps_putty3.png"><img alt="Image:Vps_putty3.png" src="http://wiki.ubuntu.org.cn/images/8/80/Vps_putty3.png" /></a></p>
<p>5 如果显示下图则表示登录成功了。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty4.png&amp;variant=zh-cn" title="Image:Vps_putty4.png"><img alt="Image:Vps_putty4.png" src="http://wiki.ubuntu.org.cn/images/2/22/Vps_putty4.png" /></a></p>
<p>6 设置 putty 支持 vps 的中文文件名或中文文件内容显示，此步骤非必需，可以忽略： </p>
<p>在主窗口，点击左上角的图标，在弹出菜单中选择 Change Settings... 菜单，出现设置窗口。 </p>
<p>设置显示字体，左边窗口点击 Window -&gt; Appearance ，右边点击 Font settings -&gt; Change 如下图： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty5.png&amp;variant=zh-cn" title="Image:Vps_putty5.png"><img alt="Image:Vps_putty5.png" src="http://wiki.ubuntu.org.cn/images/0/03/Vps_putty5.png" /></a></p>
<p>字体选择 新宋体 字符集选择 CHINESE_GB2312 ，字体大小随你喜好设置。设置完毕后点确定 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty6.png&amp;variant=zh-cn" title="Image:Vps_putty6.png"><img alt="Image:Vps_putty6.png" src="http://wiki.ubuntu.org.cn/images/3/35/Vps_putty6.png" /></a></p>
<p>设置终端字符，左边窗口点 Window -&gt; Translation ,右边选择 Remote character set 的下拉框选择 UTF-8 ，如下图： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_putty7.png&amp;variant=zh-cn" title="Image:Vps_putty7.png"><img alt="Image:Vps_putty7.png" src="http://wiki.ubuntu.org.cn/images/8/8b/Vps_putty7.png" /></a></p>
<p>设置Socket5代理，左边窗口点 Connection -&gt; SSH -&gt; Tunnels，右边如下图选择 Dynamic ，Source port 输入 7070，然后点 Add 按钮，就启用了本机代理。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:PuttySocket5.png&amp;variant=zh-cn" title="Image:PuttySocket5.png"><img alt="Image:PuttySocket5.png" src="http://wiki.ubuntu.org.cn/images/1/1e/PuttySocket5.png" /></a></p>
<h2 id="_4">如何上传和下载文件</h2>
<p>VPS 直接支持ssh协议，因此不需要采用 ftp 方式上传，可以直接使用支持 sftp 协议的客户端上传文件，这里使用 FileZilla。 </p>
<p>1 下载FileZilla </p>
<p>官网下载地址： <a href="http://filezilla-project.org/download.php?type=client" title="http://filezilla-project.org/download.php?type=client">http://filezilla-project.org/download.php?type=client</a></p>
<p>或直接点击下载： <a href="http://sourceforge.net/projects/filezilla/files/FileZilla_Client/3.5.0/FileZilla_3.5.0_win32-setup.exe/download" title="http://sourceforge.net/projects/filezilla/files/FileZilla_Client/3.5.0/FileZilla_3.5.0_win32-setup.exe/download">http://sourceforge.net/projects/filezilla/files/FileZilla_Client/3.5.0/FileZilla_3.5.0_win32-setup.exe/download</a></p>
<p>2 下载完毕后安装 FileZilla </p>
<p>3 添加站点 </p>
<p>运行FileZilla，点击菜单 文件 -&gt; 站点管理器 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_FileZilla1.png&amp;variant=zh-cn" title="Image:Vps_FileZilla1.png"><img alt="Image:Vps_FileZilla1.png" src="http://wiki.ubuntu.org.cn/images/2/23/Vps_FileZilla1.png" /></a></p>
<p>点击后如下图： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_FileZilla2.png&amp;variant=zh-cn" title="Image:Vps_FileZilla2.png"><img alt="Image:Vps_FileZilla2.png" src="http://wiki.ubuntu.org.cn/images/9/90/Vps_FileZilla2.png" /></a></p>
<p>再点击面板的 "新站点" 按钮，在右边的输入地方，输入： </p>
<div class="hlcode"><pre><span class="err">主机：</span><span class="n">VPS</span><span class="err">的</span><span class="n">IP</span><span class="err">，本例输入</span> <span class="mf">184.82.9.30</span>
<span class="err">协议：选择</span> <span class="n">SFTP</span>
<span class="err">登录类型：选一般</span>
<span class="err">用户：输入</span><span class="n">root</span>
<span class="err">密码：输入</span><span class="n">ssh</span><span class="err">的登录密码，注意密码区分大小写。</span>
</pre></div>


<p>如下图： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_FileZilla3.png&amp;variant=zh-cn" title="Image:Vps_FileZilla3.png"><img alt="Image:Vps_FileZilla3.png" src="http://wiki.ubuntu.org.cn/images/5/5e/Vps_FileZilla3.png" /></a></p>
<p>输入完毕后，再切换到字符集，选择 "强制 UTF-8" ，如下图： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_FileZilla4.png&amp;variant=zh-cn" title="Image:Vps_FileZilla4.png"><img alt="Image:Vps_FileZilla4.png" src="http://wiki.ubuntu.org.cn/images/5/50/Vps_FileZilla4.png" /></a></p>
<p>输入完毕后直接点击 “连接” 按钮即可，连接完毕后如下图所示，你就可以直接上传和下载文件了。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_FileZilla5.png&amp;variant=zh-cn" title="Image:Vps_FileZilla5.png"><img alt="Image:Vps_FileZilla5.png" src="http://wiki.ubuntu.org.cn/images/e/ed/Vps_FileZilla5.png" /></a></p>
<p>下一次打开 FileZilla 时，直接到站点管理器，点击连接即可。 </p>
<h2 id="_5">更新软件源 (不可跳过)</h2>
<p>以下命令均需要使用 putty 登录到服务器远程执行命令操作，你可以直接复制下面的命令，然后点击 putty 窗口按鼠标右键，粘贴命令。 </p>
<p>本步骤不可跳过，需要先执行，后面才可以继续，建议每次安装新软件时，都执行一遍本步骤。 </p>
<p>输入如下命令更新软件源： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>


<p>下面的提示不同的Linux的版本存在不同的差异，但有如下类似的提示时，表示更新成功： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick Release.gpg [198B]</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/restricted Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/universe Translation-en</span>
<span class="nl">Get:</span><span class="mi">2</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-updates Release.gpg [198B]</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-updates/main Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-updates/restricted Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-updates/universe Translation-en</span>
<span class="nl">Get:</span><span class="mi">3</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-security Release.gpg [198B]</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-security/main Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-security/restricted Translation-en</span>
<span class="n">Ign</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-security/universe Translation-en</span>
<span class="nl">Get:</span><span class="mi">4</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick Release [39.8kB]</span>
<span class="nl">Get:</span><span class="mi">5</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-updates Release [31.4kB]</span>
<span class="nl">Get:</span><span class="mi">6</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-security Release [31.4kB]</span>
<span class="nl">Get:</span><span class="mi">7</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick/main i386 Packages [1492kB]</span>
<span class="nl">Get:</span><span class="mi">8</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick/restricted i386 Packages [5992B]</span>
<span class="nl">Get:</span><span class="mi">9</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick/universe i386 Packages [5791kB]</span>
<span class="nl">Get:</span><span class="mi">10</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-updates/main i386 Packages [380kB]</span>
<span class="nl">Get:</span><span class="mi">11</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-updates/restricted i386 Packages [1797B]</span>
<span class="nl">Get:</span><span class="mi">12</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-updates/universe i386 Packages [157kB]</span>
<span class="nl">Get:</span><span class="mi">13</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-security/main i386 Packages [157kB]</span>
<span class="nl">Get:</span><span class="mi">14</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-security/restricted i386 Packages [14B]</span>
<span class="nl">Get:</span><span class="mi">15</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com maverick-security/universe i386 Packages [77.9kB]</span>
<span class="n">Fetched</span> <span class="mi">8166</span><span class="n">kB</span> <span class="n">in</span> <span class="mi">4</span><span class="n">s</span> <span class="p">(</span><span class="mi">1724</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
</pre></div>


<p>如果VPS有启用IPv6，有可能长时间执行这个没有反应，请输入 Ctrl + C 中断上面的命令。先执行如下命令，使IPV4优先： </p>
<p>全部关闭 IPv6： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;precedence ::ffff:0:0/96  100&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">gai</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>仅仅针对 apt-get 关闭IPv6，仅 Ubuntu 14.04 以上版本有效： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;Acquire::ForceIPv4 true;&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">apt</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="mf">99f</span><span class="n">orce</span><span class="o">-</span><span class="n">ipv4</span>
</pre></div>


<p>执行完毕上面的命令后，重新运行 apt-get update 来更新软件源即可。 </p>
<h2 id="_6">安装常用软件 (不可跳过)</h2>
<p>VPS里面缺乏一些常用工具软件，一次安装好： </p>
<p>输入如下命令安装解压缩、下载和数据同步以及系统日志软件： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">unzip</span> <span class="n">zip</span> <span class="n">wget</span> <span class="n">rsync</span>
</pre></div>


<p>如果提示如下命令，表示之前已经安装好： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">unzip</span> <span class="n">zip</span> <span class="n">wget</span> <span class="n">rsync</span> 
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">unzip</span> <span class="n">is</span> <span class="n">already</span> <span class="n">the</span> <span class="n">newest</span> <span class="n">version</span><span class="p">.</span>
<span class="n">wget</span> <span class="n">is</span> <span class="n">already</span> <span class="n">the</span> <span class="n">newest</span> <span class="n">version</span><span class="p">.</span>
<span class="n">rsync</span> <span class="n">is</span> <span class="n">already</span> <span class="n">the</span> <span class="n">newest</span> <span class="n">version</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">0</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
</pre></div>


<p>如果之前没有安装会提示如下命令，表示已经安装好 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">unzip</span> <span class="n">zip</span> <span class="n">wget</span> <span class="n">rsync</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">rsync</span> <span class="n">unzip</span> <span class="n">wget</span> <span class="n">zip</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">4</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">319</span><span class="n">kB</span><span class="o">/</span><span class="mi">1125</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">2314</span><span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main zip i386 3.0-3 [319kB]</span>
<span class="n">Fetched</span> <span class="mi">319</span><span class="n">kB</span> <span class="n">in</span> <span class="mi">0</span><span class="n">s</span> <span class="p">(</span><span class="mi">417</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">wget</span><span class="p">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">22549</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">wget</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">wget_1</span><span class="mf">.12</span><span class="o">-</span><span class="mf">1.1</span><span class="n">ubuntu3_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">rsync</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">rsync</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">rsync_3</span><span class="mf">.0.7</span><span class="o">-</span><span class="mi">2u</span><span class="n">buntu1</span><span class="mf">.1</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">unzip</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">unzip</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">archives</span><span class="o">/</span><span class="n">unzip_6</span><span class="mf">.0</span><span class="o">-</span><span class="mi">4</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">zip</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">zip</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">archives</span><span class="o">/</span><span class="n">zip_3</span><span class="mf">.0</span><span class="o">-</span><span class="mi">3</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">wget</span> <span class="p">(</span><span class="mf">1.12</span><span class="o">-</span><span class="mf">1.1</span><span class="n">ubuntu3</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">rsync</span> <span class="p">(</span><span class="mf">3.0.7</span><span class="o">-</span><span class="mi">2u</span><span class="n">buntu1</span><span class="mf">.1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">unzip</span> <span class="p">(</span><span class="mf">6.0</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">zip</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">...</span>
</pre></div>


<h2 id="apache">使用 Apache 搭建站点</h2>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=Apache&amp;variant=zh-cn" title="Apache">Apache</a> 是最常见的 Web 服务器，功能强大。如果希望使用轻量级的 <a href="http://wiki.ubuntu.org.cn/index.php?title=Nginx&amp;variant=zh-cn" title="Nginx">Nginx</a> ,可以跳过此部分，直接转到指南的 nginx 部分来安装。 </p>
<h3 id="apache2-web">安装 Apache2 Web 服务</h3>
<p>VPS 默认有安装Apache2，但如果你删除了，就需要重新安装；如果没有删除，执行下面的命令会退出来，不会对系统产生任何影响。 </p>
<p>输入如下命令安装 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">apache2</span>
</pre></div>


<p>正常情况下会给出如下提示，说明Apache2默认已经安装好了： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">apache2</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">apache2</span> <span class="n">is</span> <span class="n">already</span> <span class="n">the</span> <span class="n">newest</span> <span class="n">version</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">0</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">0</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
</pre></div>


<h3 id="apache2">开启 Apache2 的伪静态</h3>
<p>如果希望开启Apache2 伪静态 rewrite 支持，输入如下命令安装 </p>
<div class="hlcode"><pre><span class="n">a2enmod</span> <span class="n">rewrite</span>
</pre></div>


<p>正常情况下会给出如下提示，说明已经安装成功： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">a2enmod</span> <span class="n">rewrite</span>
<span class="n">Module</span> <span class="n">rewrite</span> <span class="n">installed</span><span class="p">;</span> <span class="n">run</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">force</span><span class="o">-</span><span class="n">reload</span> <span class="n">to</span> <span class="n">enable</span><span class="p">.</span>
</pre></div>


<p>提示需要重新加载Apache2的配置，由于下一步是安装mysql，所以暂时不用重启。 </p>
<p>或出现如下提示，表示已经开启了 rewrite </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">a2enmod</span> <span class="n">rewrite</span>
<span class="n">Mudule</span> <span class="n">rewrite</span> <span class="n">already</span> <span class="n">enabled</span>
</pre></div>


<h3 id="mysql">安装 mysql 数据库服务</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=MySQL&amp;variant=zh-cn" title="MySQL">MySQL</a> 是 Linux 下最常用的开源数据库。 </p>
<p>输入如下命令安装mysql </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
</pre></div>


<p>如果输入正确，会提示如下信息， </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">extra</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">libdbd</span><span class="o">-</span><span class="n">mysql</span><span class="o">-</span><span class="n">perl</span> <span class="n">libdbi</span><span class="o">-</span><span class="n">perl</span> <span class="n">libhtml</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="n">perl</span> <span class="n">libmysqlclient16</span>
  <span class="n">libnet</span><span class="o">-</span><span class="n">daemon</span><span class="o">-</span><span class="n">perl</span> <span class="n">libplrpc</span><span class="o">-</span><span class="n">perl</span> <span class="n">mysql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="mf">5.1</span> <span class="n">mysql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.1</span>
  <span class="n">mysql</span><span class="o">-</span><span class="n">common</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.1</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.1</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">libipc</span><span class="o">-</span><span class="n">sharedcache</span><span class="o">-</span><span class="n">perl</span> <span class="n">libterm</span><span class="o">-</span><span class="n">readkey</span><span class="o">-</span><span class="n">perl</span> <span class="n">tinyca</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">libdbd</span><span class="o">-</span><span class="n">mysql</span><span class="o">-</span><span class="n">perl</span> <span class="n">libdbi</span><span class="o">-</span><span class="n">perl</span> <span class="n">libhtml</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="n">perl</span> <span class="n">libmysqlclient16</span>
  <span class="n">libnet</span><span class="o">-</span><span class="n">daemon</span><span class="o">-</span><span class="n">perl</span> <span class="n">libplrpc</span><span class="o">-</span><span class="n">perl</span> <span class="n">mysql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="mf">5.1</span> <span class="n">mysql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.1</span>
  <span class="n">mysql</span><span class="o">-</span><span class="n">common</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.1</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.1</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">12</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mf">22.9</span><span class="n">MB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mf">54.4</span><span class="n">MB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span>
</pre></div>


<p>输入 Y 回车，继续安装 会提示输入 mysql 的 root 用户密码，你可以输入密码后回车，也可以不输入任何密码直接回车。 （不输入密码不会影响到Mysql的安全性，因为Mysql仅仅用于本地监听，但不输入密码会导致后续phpmyadmin无法运行） </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_Mysql1.png&amp;variant=zh-cn" title="Image:Vps_Mysql1.png"><img alt="Image:Vps_Mysql1.png" src="http://wiki.ubuntu.org.cn/images/e/e6/Vps_Mysql1.png" /></a></p>
<p>需要重新输入一遍密码，如下图所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_Mysql2.png&amp;variant=zh-cn" title="Image:Vps_Mysql2.png"><img alt="Image:Vps_Mysql2.png" src="http://wiki.ubuntu.org.cn/images/7/76/Vps_Mysql2.png" /></a></p>
<p>最后提示如下界面，表示mysql安装成功。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_Mysql3.png&amp;variant=zh-cn" title="Image:Vps_Mysql3.png"><img alt="Image:Vps_Mysql3.png" src="http://wiki.ubuntu.org.cn/images/8/83/Vps_Mysql3.png" /></a></p>
<h3 id="mysql_1">mysql 数据库管理</h3>
<p>对于mysql数据库维护可以使用下面指南中安装的 phpmyadmin 进行维护，或直接在 putty 中输入 mysql -p 进行管理如图所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_mysql1.png&amp;variant=zh-cn" title="Image:Vps_mysql1.png"><img alt="Image:Vps_mysql1.png" src="http://wiki.ubuntu.org.cn/images/0/0e/Vps_mysql1.png" /></a></p>
<p>在 mysql&gt; 的提示符下输入 quit 回车，将退出 mysql 命令，返回到正常操作提示符。 </p>
<h3 id="mysql_2">mysql 数据库优化</h3>
<p>如果你的VPS的内存只有512M，请按如下步骤进行优化，如果是1G或以上可以忽略本步骤。执行本步骤可以将Mysql的占用内存由150M降到100M。 </p>
<p>输入如下命令配置 Mysql </p>
<div class="hlcode"><pre><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span><span class="p">.</span><span class="err">`</span><span class="n">date</span> <span class="o">+%</span><span class="n">s</span><span class="err">`</span>
<span class="n">find</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">mysql</span><span class="o">*</span> <span class="o">-</span><span class="n">name</span> <span class="n">my</span><span class="o">-</span><span class="n">small</span><span class="p">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">exec</span> <span class="n">cp</span> <span class="p">{}</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="err">\</span><span class="p">;</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">\</span><span class="p">[</span><span class="n">mysqld</span><span class="err">\</span><span class="p">]</span><span class="o">/&amp;</span><span class="err">\</span><span class="n">nuser</span>            <span class="o">=</span> <span class="n">mysql</span><span class="err">\</span><span class="n">n</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span><span class="p">.</span><span class="err">`</span><span class="n">date</span> <span class="o">+%</span><span class="n">s</span><span class="err">`</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">find</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">mysql</span><span class="o">*</span> <span class="o">-</span><span class="n">name</span> <span class="n">my</span><span class="o">-</span><span class="n">small</span><span class="p">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">exec</span> <span class="n">cp</span> <span class="p">{}</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="err">\</span><span class="p">;</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">\</span><span class="p">[</span><span class="n">mysqld</span><span class="err">\</span><span class="p">]</span><span class="o">/&amp;</span><span class="err">\</span><span class="n">nuser</span>            <span class="o">=</span> <span class="n">mysql</span><span class="err">\</span><span class="n">n</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<p>重启下 Mysql服务： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span> <span class="n">restart</span>
<span class="n">Rather</span> <span class="n">than</span> <span class="n">invoking</span> <span class="n">init</span> <span class="n">scripts</span> <span class="n">through</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">use</span> <span class="n">the</span> <span class="n">service</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">utility</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">restart</span>

<span class="n">Since</span> <span class="n">the</span> <span class="n">script</span> <span class="n">you</span> <span class="n">are</span> <span class="n">attempting</span> <span class="n">to</span> <span class="n">invoke</span> <span class="n">has</span> <span class="n">been</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">an</span>
<span class="n">Upstart</span> <span class="n">job</span><span class="p">,</span> <span class="n">you</span> <span class="n">may</span> <span class="n">also</span> <span class="n">use</span> <span class="n">the</span> <span class="n">restart</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="n">utility</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">restart</span> <span class="n">mysql</span>
<span class="n">mysql</span> <span class="n">start</span><span class="o">/</span><span class="n">running</span><span class="p">,</span> <span class="n">process</span> <span class="mi">9886</span>
</pre></div>


<h3 id="php">安装php环境</h3>
<p>执行如下命令安装apache2的php5扩展和php的mysql扩展 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">curl</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
</pre></div>


<p>如下提示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">extra</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">libgd2</span><span class="o">-</span><span class="n">xpm</span> <span class="n">libjpeg62</span> <span class="n">libt1</span><span class="o">-</span><span class="mi">5</span> <span class="n">libx11</span><span class="o">-</span><span class="mi">6</span> <span class="n">libx11</span><span class="o">-</span><span class="n">data</span> <span class="n">libxau6</span> <span class="n">libxcb1</span> <span class="n">libxdmcp6</span>
  <span class="n">libxpm4</span> <span class="n">php5</span><span class="o">-</span><span class="n">cli</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">php</span><span class="o">-</span><span class="n">pear</span> <span class="n">libgd</span><span class="o">-</span><span class="n">tools</span> 
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span> <span class="n">libgd2</span><span class="o">-</span><span class="n">xpm</span> <span class="n">libjpeg62</span> <span class="n">libt1</span><span class="o">-</span><span class="mi">5</span> <span class="n">libx11</span><span class="o">-</span><span class="mi">6</span> <span class="n">libx11</span><span class="o">-</span><span class="n">data</span>
  <span class="n">libxau6</span> <span class="n">libxcb1</span> <span class="n">libxdmcp6</span> <span class="n">libxpm4</span> <span class="n">php5</span><span class="o">-</span><span class="n">cli</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">15</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">8128</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mf">22.7</span><span class="n">MB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span>
</pre></div>


<p>输入 Y，回车继续，以下表示安装完成。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_php1.png&amp;variant=zh-cn" title="Image:Vps_php1.png"><img alt="Image:Vps_php1.png" src="http://wiki.ubuntu.org.cn/images/b/b0/Vps_php1.png" /></a></p>
<p>重新启动apache2, 输入如下命令： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>提示如下，表示启动成功： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
<span class="o">*</span> <span class="n">Restarting</span> <span class="n">web</span> <span class="n">server</span> <span class="n">apache2</span>                                                  <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.3.175.133</span> <span class="k">for</span> <span class="n">ServerName</span>
                                                                         <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<h3 id="_7">测试站点</h3>
<p>以上命令已经完整安装好一台Web服务器所具有的环境，以下来搭建一个最简单的站点。 </p>
<p>web 的根目录位于 /var/www 你可以将自己的程序直接放到此目录。 </p>
<h4 id="phpsysinfo">安装 phpsysinfo</h4>
<p>使用putty登录到服务器，依次执行如下命令安装phpsysinfo： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//sourceforge.net/projects/phpsysinfo/files/phpsysinfo/3.0.13/phpsysinfo-3.0.13.tar.gz/download -O phpsysinfo-3.0.13.tar.gz</span>
<span class="n">tar</span> <span class="n">xzvf</span> <span class="n">phpsysinfo</span><span class="o">-</span><span class="mf">3.0.13</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> 
<span class="n">cd</span> <span class="n">phpsysinfo</span>
<span class="n">mv</span> <span class="n">config</span><span class="p">.</span><span class="n">php</span><span class="p">.</span><span class="n">new</span> <span class="n">config</span><span class="p">.</span><span class="n">php</span>
</pre></div>


<p>执行完毕后，在浏览器的地址输入： <a href="http://184.82.9.30/phpsysinfo/" title="http://184.82.9.30/phpsysinfo/">http://184.82.9.30/phpsysinfo/</a> 查看，显示如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpsysinfo.png&amp;variant=zh-cn" title="Image:Vps_phpsysinfo.png"><img alt="Image:Vps_phpsysinfo.png" src="http://wiki.ubuntu.org.cn/images/a/a2/Vps_phpsysinfo.png" /></a></p>
<h4 id="php_1">安装 php 探针</h4>
<p>使用putty登录到服务器，依次执行如下命令安装： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.yahei.net/tz/tz.zip</span>
<span class="n">unzip</span> <span class="n">tz</span><span class="p">.</span><span class="n">zip</span>
</pre></div>


<p>运行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">#</span> <span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.yahei.net/tz/tz.zip</span>
<span class="o">--</span><span class="mi">2011</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">40</span><span class="o">--</span>  <span class="n">http</span><span class="o">:</span><span class="c1">//www.yahei.net/tz/tz.zip</span>
<span class="n">Resolving</span> <span class="n">www</span><span class="p">.</span><span class="n">yahei</span><span class="p">.</span><span class="n">net</span><span class="p">...</span> <span class="mf">110.34.192.14</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">www</span><span class="p">.</span><span class="n">yahei</span><span class="p">.</span><span class="n">net</span><span class="o">|</span><span class="mf">110.34.192.14</span><span class="o">|:</span><span class="mf">80.</span><span class="p">..</span> <span class="n">connected</span><span class="p">.</span>
<span class="n">HTTP</span> <span class="n">request</span> <span class="n">sent</span><span class="p">,</span> <span class="n">awaiting</span> <span class="n">response</span><span class="p">...</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Length:</span> <span class="mi">16087</span> <span class="p">(</span><span class="mi">16</span><span class="n">K</span><span class="p">)</span> <span class="p">[</span><span class="n">application</span><span class="o">/</span><span class="n">zip</span><span class="p">]</span>
<span class="n">Saving</span> <span class="n">to</span><span class="o">:</span> <span class="err">`</span><span class="n">tz</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span>

<span class="mi">100</span><span class="o">%</span><span class="p">[</span><span class="o">======================================&gt;</span><span class="p">]</span> <span class="mi">16</span><span class="p">,</span><span class="mi">087</span>      <span class="o">--</span><span class="p">.</span><span class="o">-</span><span class="n">K</span><span class="o">/</span><span class="n">s</span>   <span class="n">in</span> <span class="mf">0.07</span><span class="n">s</span>

<span class="mi">2011</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">41</span> <span class="p">(</span><span class="mi">152</span> <span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="err">`</span><span class="n">tz</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span> <span class="n">saved</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">087</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span><span class="mi">087</span><span class="p">]</span>

<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">#</span> <span class="n">unzip</span> <span class="n">tz</span><span class="p">.</span><span class="n">zip</span>
<span class="nl">Archive:</span>  <span class="n">tz</span><span class="p">.</span><span class="n">zip</span>
  <span class="nl">inflating:</span> <span class="n">tz</span><span class="p">.</span><span class="n">php</span>
</pre></div>


<p>执行完毕后，在浏览器的地址输入： <a href="http://184.82.9.30/tz.php" title="http://184.82.9.30/tz.php">http://184.82.9.30/tz.php</a> 查看，显示如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_tz1.png&amp;variant=zh-cn" title="Image:Vps_tz1.png"><img alt="Image:Vps_tz1.png" src="http://wiki.ubuntu.org.cn/images/0/05/Vps_tz1.png" /></a></p>
<h4 id="phpmyadmin">安装 phpmyadmin</h4>
<p>安装phpmyadmin，需要mysql事先配置好root的密码。 </p>
<p>使用putty登录到服务器，执行下面安装 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">phpmyadmin</span>
</pre></div>


<p>提示如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">phpmyadmin</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">extra</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">dbconfig</span><span class="o">-</span><span class="n">common</span> <span class="n">javascript</span><span class="o">-</span><span class="n">common</span> <span class="n">libjs</span><span class="o">-</span><span class="n">mootools</span> <span class="n">libmcrypt4</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span>
  <span class="n">wwwconfig</span><span class="o">-</span><span class="n">common</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">libmcrypt</span><span class="o">-</span><span class="n">dev</span> <span class="n">mcrypt</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">client</span> <span class="n">apache</span> <span class="n">apache</span><span class="o">-</span><span class="n">ssl</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">dbconfig</span><span class="o">-</span><span class="n">common</span> <span class="n">javascript</span><span class="o">-</span><span class="n">common</span> <span class="n">libjs</span><span class="o">-</span><span class="n">mootools</span> <span class="n">libmcrypt4</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span>
  <span class="n">phpmyadmin</span> <span class="n">wwwconfig</span><span class="o">-</span><span class="n">common</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">7</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">5184</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mf">21.3</span><span class="n">MB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span>
</pre></div>


<p>输入 Y， 回车继续。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Attention_niels_epting.svg&amp;variant=zh-cn" title="Attention niels epting.svg"><img alt="" src="http://wiki.ubuntu.org.cn/images/thumb/5/51/Attention_niels_epting.svg/18px-Attention_niels_epting.svg.png" /></a> <strong>按 空格键 选择 Apche2</strong> 如下图: </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin1.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin1.png"><img alt="Image:Vps_phpmyadmin1.png" src="http://wiki.ubuntu.org.cn/images/6/63/Vps_phpmyadmin1.png" /></a></p>
<p>选择完毕后，回车继续，提示如下图，是否需要创建phpmyadmin数据库， </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin2.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin2.png"><img alt="Image:Vps_phpmyadmin2.png" src="http://wiki.ubuntu.org.cn/images/1/1e/Vps_phpmyadmin2.png" /></a></p>
<p>直接回车继续，提示输入mysql的管理员密码，输入后如下所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin3.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin3.png"><img alt="Image:Vps_phpmyadmin3.png" src="http://wiki.ubuntu.org.cn/images/5/51/Vps_phpmyadmin3.png" /></a></p>
<p>回车继续后，如下图，提示输入phpmyadmin连接数据的密码，直接回车由系统随机产生一个即可。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin4.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin4.png"><img alt="Image:Vps_phpmyadmin4.png" src="http://wiki.ubuntu.org.cn/images/e/ec/Vps_phpmyadmin4.png" /></a></p>
<p>完成安装提示如下: </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin5.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin5.png"><img alt="Image:Vps_phpmyadmin5.png" src="http://wiki.ubuntu.org.cn/images/a/af/Vps_phpmyadmin5.png" /></a></p>
<p>现在访问如下地址测试： <a href="http://184.82.9.30/phpmyadmin/" title="http://184.82.9.30/phpmyadmin/">http://184.82.9.30/phpmyadmin/</a></p>
<p>如果打开提示 404 错误，即 Not Found ，在putty里面执行如下命令： </p>
<div class="hlcode"><pre><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">phpmyadmin</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</pre></div>


<p>然后再访问，如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin6.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin6.png"><img alt="Image:Vps_phpmyadmin6.png" src="http://wiki.ubuntu.org.cn/images/8/8a/Vps_phpmyadmin6.png" /></a></p>
<p>输入mysql的root帐号和mysql的密码，点击 执行 进行登录，进行正常访问如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_phpmyadmin7.png&amp;variant=zh-cn" title="Image:Vps_phpmyadmin7.png"><img alt="Image:Vps_phpmyadmin7.png" src="http://wiki.ubuntu.org.cn/images/3/32/Vps_phpmyadmin7.png" /></a></p>
<h3 id="_8">配置虚拟站点</h3>
<p>假设前提： 你有一个域名 test.com ，你希望搭建两个站点，第一个站点是 www.test.com 和 test.com 为主页，同时希望提供 bbs.test.com 为论坛。 </p>
<p>注意，下面的文档对多个不同的域名也是适用的。 </p>
<h4 id="_9">配置域名</h4>
<p>去域名商提供的面板将 test.com 域名的 A 记录修改为 VPS 的 IP. </p>
<h4 id="_10">上传程序</h4>
<p>约定两个站点的目录如下，为了方便备份，站点的目录最好集中存放在 /var/www 目录。 </p>
<div class="hlcode"><pre><span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">)</span> <span class="err">对应目录：</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">test</span>
<span class="n">bbs</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="err">对应目录：</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bbs</span>
</pre></div>


<p>假设主站点安装帝国的CMS程序，论坛采用DZ的论坛，程序需要下载UTF-8的版本。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite1.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite1.png"><img alt="Image:Vps_ApacheSite1.png" src="http://wiki.ubuntu.org.cn/images/7/74/Vps_ApacheSite1.png" /></a></p>
<p>使用前面提到的上传方法，利用 FileZilla 连接服务器，创建这两个目录。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite2.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite2.png"><img alt="Image:Vps_ApacheSite2.png" src="http://wiki.ubuntu.org.cn/images/9/9b/Vps_ApacheSite2.png" /></a></p>
<p>如果找不到如上图的目录，请点击 / 即可看到了。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSiteFile4.png&amp;variant=zh-cn" title="Image:Vps_ApacheSiteFile4.png"><img alt="Image:Vps_ApacheSiteFile4.png" src="http://wiki.ubuntu.org.cn/images/6/69/Vps_ApacheSiteFile4.png" /></a></p>
<p>创建目录后，分别上传程序，如下： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite3.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite3.png"><img alt="Image:Vps_ApacheSite3.png" src="http://wiki.ubuntu.org.cn/images/c/ca/Vps_ApacheSite3.png" /></a></p>
<h4 id="_11">多域名配置</h4>
<p>这里推荐编辑器直接使用记事本，不要使用其他的高级编辑器。 </p>
<p>注意下面的 <strong>DocumentRoot /var/www/test/</strong> 中的 <strong>/var/www/test/</strong> 应该修改为你上传站点的文件目录。 </p>
<p>编辑www.test.com的站点配置文件test.com.txt ，其中站点 [http://www.test.com][79] 和 <a href="http://test.com" title="http://test.com">http://test.com</a> 的网站目录为 /var/www/test/ </p>
<div class="hlcode"><pre>   <span class="p">[</span><span class="mi">79</span><span class="p">]</span><span class="o">:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.test.com (http://www.test.com)</span>
</pre></div>


<p><VirtualHost *:80><br />
        ServerName www.test.com<br />
        ServerAlias test.com<br />
        DocumentRoot /var/www/test/<br />
    </VirtualHost> </p>
<p>编辑bbs.test.com的站点配置文件 bbs.test.com.txt ， 其中站点 bbs.test.com 的网站目录为 /var/www/bbs/ </p>
<div class="hlcode"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName bbs.test.com
    DocumentRoot /var/www/bbs/
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>如图所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite4.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite4.png"><img alt="Image:Vps_ApacheSite4.png" src="http://wiki.ubuntu.org.cn/images/5/57/Vps_ApacheSite4.png" /></a></p>
<p>将这两个文件上传到 /etc/apache2/sites-enabled/ 目录 </p>
<p>如图所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite5.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite5.png"><img alt="Image:Vps_ApacheSite5.png" src="http://wiki.ubuntu.org.cn/images/6/6f/Vps_ApacheSite5.png" /></a></p>
<h4 id="apache2_1">Apache2 伪静态</h4>
<p>有两种方法做伪静态，一种是用 .htaccess 文件。 例如将上面的 bbs.test.com 的站点配置文件编辑为如下： </p>
<div class="hlcode"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName bbs.test.com
    DocumentRoot /var/www/bbs/
    <span class="nt">&lt;Directory</span> <span class="err">/var/www/bbs</span><span class="nt">/&gt;</span>
          AllowOverride AuthConfig
    <span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>重新上传，重启 apache2 后， 然后将准备好的 .htaccess 文件放到对应的 /var/www/bbs/ 网站根目录即可。 </p>
<p>另外一种是直接加入到配置文件，如下： </p>
<div class="hlcode"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName bbs.test.com
    DocumentRoot /var/www/bbs/
    #伪静态代码段开始    
    <span class="nt">&lt;Directory</span> <span class="err">/var/www/bbs</span><span class="nt">/&gt;</span>
       ...............................
    <span class="nt">&lt;/Directory&gt;</span>
    #伪静态代码段结束    
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>下面是常用的一些伪静态配置，复制出来，保存为 .htaccess 文件，或 插入到站点的配置文件最后一行 <Directory> 和 </Directory> 之间。 </p>
<p>Discuz!X 在 Apche2 下的伪静态配置如下： </p>
<div class="hlcode"><pre>          <span class="n">RewriteEngine</span> <span class="n">On</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="n">forum</span><span class="o">-</span><span class="p">(</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">forumdisplay</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="kr">thread</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">viewthread</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">extra</span><span class="o">=</span><span class="n">page</span><span class="err">\</span><span class="o">%</span><span class="mi">3</span><span class="n">D</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="n">topic</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">topic</span><span class="o">&amp;</span><span class="n">topic</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="n">article</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">article</span><span class="o">&amp;</span><span class="n">articleid</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="n">group</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">group</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="n">space</span><span class="o">-</span><span class="p">(</span><span class="n">username</span><span class="o">|</span><span class="n">uid</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="n">home</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">space</span><span class="o">&amp;</span><span class="err">$</span><span class="mi">1</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mf">1.</span><span class="n">php</span><span class="o">?</span><span class="n">rewrite</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>
</pre></div>


<p>将这一段代码加入到上面的站点配置文件中，如下： </p>
<div class="hlcode"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName bbs.test.com
    DocumentRoot /var/www/bbs/
    <span class="nt">&lt;Directory</span> <span class="err">/var/www/bbs</span><span class="nt">/&gt;</span>
          RewriteEngine On
          RewriteRule ^forum-(\w+)-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)\.html$ forum.php?mod=forumdisplay<span class="err">&amp;</span>fid=$1<span class="err">&amp;</span>page=$2
          RewriteRule ^thread-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)\.html$ forum.php?mod=viewthread<span class="err">&amp;</span>tid=$1<span class="err">&amp;</span>extra=page\%3D$3<span class="err">&amp;</span>page=$2
          RewriteRule ^topic-(.+)\.html$ portal.php?mod=topic<span class="err">&amp;</span>topic=$1
          RewriteRule ^article-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)\.html$ portal.php?mod=article<span class="err">&amp;</span>articleid=$1
          RewriteRule ^group-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)-(<span class="cp">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="cp">]</span>+)\.html$ forum.php?mod=group<span class="err">&amp;</span>fid=$1<span class="err">&amp;</span>page=$2
          RewriteRule ^space-(username|uid)-(.+)\.html$ home.php?mod=space<span class="err">&amp;</span>$1=$2
          RewriteRule ^(<span class="cp">[</span><span class="nx">a</span><span class="na">-z</span><span class="cp">]</span>+)-(.+)\.html$ $1.php?rewrite=$2
    <span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>WordPress 在 Apache2 下的伪静态配置如下： </p>
<div class="hlcode"><pre>    <span class="nt">&lt;Directory</span> <span class="nt">/&gt;</span>
          RewriteEngine On
          RewriteRule ^index\.php$ - <span class="cp">[</span><span class="nx">L</span><span class="cp">]</span>
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.php <span class="cp">[</span><span class="nx">L</span><span class="cp">]</span>
    <span class="nt">&lt;/Directory&gt;</span>
</pre></div>


<p>ECShop 在 Apache2 下的伪静态配置如下： </p>
<div class="hlcode"><pre>    <span class="o">&lt;</span><span class="n">Directory</span> <span class="o">/&gt;</span>
          <span class="n">RewriteEngine</span> <span class="n">On</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="err">\</span><span class="p">.</span><span class="n">php</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="err">\</span><span class="p">.</span><span class="n">php</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">feed</span><span class="o">-</span><span class="n">c</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">).</span><span class="n">xml</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">feed</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">feed</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">).</span><span class="n">xml</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">feed</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">feed</span><span class="o">-</span><span class="n">type</span><span class="p">([</span><span class="o">^-</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">xml</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">feed</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">type</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">feed</span><span class="p">.</span><span class="n">xml</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">feed</span><span class="err">\</span><span class="p">.</span><span class="n">php</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">min</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">attr</span><span class="p">([</span><span class="o">^-</span><span class="p">]</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">price_min</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">price_max</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">filter_attr</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">7</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">8</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">9</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">min</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">attr</span><span class="p">([</span><span class="o">^-</span><span class="p">]</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">price_min</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">price_max</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">filter_attr</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">category</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">category</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">goods</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">goods</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article_cat</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">article_cat</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article_cat</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">article_cat</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article_cat</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">article_cat</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">article</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">brand</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">brand</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">brand</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">brand</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">brand</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">brand</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">brand</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">brand</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">brand</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">brand</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">tag</span><span class="o">-</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">search</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">keywords</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">snatch</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">snatch</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">group_buy</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">group_buy</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">act</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">auction</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">auction</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">act</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">exchange</span><span class="o">-</span><span class="n">id</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">exchange</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">act</span><span class="o">=</span><span class="n">view</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">exchange</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">min</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">exchange</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">integral_min</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">integral_max</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">7</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">exchange</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">exchange</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">exchange</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">exchange</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
          <span class="n">RewriteRule</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">exchange</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)(.</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">exchange</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">\</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span>
    <span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>
</pre></div>


<h4 id="_12">修改上传文件权限</h4>
<p>由于上传的文件的所有者为 root ，Apache 无法正常写入，所以需要设置上传文件的宿主为 www-data。 </p>
<p>使用putty登录vps执行如下命令，设置 /var/www下的所有文件的宿主都是 www-data，这样apache2就可以正常读写： </p>
<div class="hlcode"><pre><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
 <span class="o">*</span> <span class="n">Restarting</span> <span class="n">web</span> <span class="n">server</span> <span class="n">apache2</span>                                                <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.3.175.133</span> <span class="k">for</span> <span class="n">ServerName</span>
 <span class="p">...</span> <span class="n">waiting</span> <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.3.175.133</span> <span class="k">for</span> <span class="n">ServerName</span>
                                                                        <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<h4 id="_13">安装配置</h4>
<p>主站点程序访问 <a href="http://www.test.com" title="http://www.test.com">http://www.test.com</a> 如下图所示，进一步安装： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite8.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite8.png"><img alt="Image:Vps_ApacheSite8.png" src="http://wiki.ubuntu.org.cn/images/0/07/Vps_ApacheSite8.png" /></a></p>
<p>论坛程序访问 <a href="http://bbs.test.com" title="http://bbs.test.com">http://bbs.test.com</a> 如下图所示，进一步安装： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_ApacheSite7.png&amp;variant=zh-cn" title="Image:Vps_ApacheSite7.png"><img alt="Image:Vps_ApacheSite7.png" src="http://wiki.ubuntu.org.cn/images/6/66/Vps_ApacheSite7.png" /></a></p>
<p>以上就是完成多域名的配置。 </p>
<h3 id="apache2-301">Apache2 301 跳转</h3>
<p>如果希望将 test.com 跳转到 www.test.com ，如下配置 test.com.txt 上传到 /etc/apache2/sites-enabled/ 目录即可。 </p>
<div class="hlcode"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerName test.com
    RewriteCond %{HTTP_HOST} ^test\.com <span class="cp">[</span><span class="nx">NC</span><span class="cp">]</span>
    RewriteRule ^(.*)$ http://www.test.com/$1 <span class="cp">[</span><span class="nx">L</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="mi">301</span><span class="cp">]</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>当然你也可以去 test.com 的域名那里设置 301 跳转。 </p>
<h3 id="apache2_2">Apache2 优化</h3>
<p>请一定要执行本步骤，不要认为小站，访问的人数少，有时候蜘蛛会按照超过20个以上的并发抓取数据，直接爆掉vps。表现为：可以ping，但网站打不开、数据库连不上或无法ssh。 </p>
<p>为了防止Vps被大的访问量爆掉，需要限制并发数，这里#1 VPS 调整为10， #2可以将下面的10修改为20，#3为30，以此类推。 </p>
<p>也可以根据指南最后的压力测试来确定最大并发数，确定后，将下面的命令中的 10 改为你确定的并发数即可，其它数值如 5 不要修改。 </p>
<p>请复制命令后到putty直接按鼠标右键粘贴执行： </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*StartServers[[:blank:]]*.*/StartServers       5/&quot;</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MinSpareServers[[:blank:]]*.*/MinSpareServers    5/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxSpareServers[[:blank:]]*.*/MaxSpareServers    10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*ServerLimit[[:blank:]]*.*/ServerLimit       10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxClients[[:blank:]]*.*/MaxClients        10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MinSpareThreads[[:blank:]]*.*/MinSpareThreads    5/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxSpareThreads[[:blank:]]*.*/MaxSpareThreads    10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>执行完毕后后，再执行以下命令，重启下apache2。 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*StartServers[[:blank:]]*.*/StartServers       5/&quot;</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MinSpareServers[[:blank:]]*.*/MinSpareServers    5/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxSpareServers[[:blank:]]*.*/MaxSpareServers    10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*ServerLimit[[:blank:]]*.*/ServerLimit       10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxClients[[:blank:]]*.*/MaxClients        10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MinSpareThreads[[:blank:]]*.*/MinSpareThreads    5/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/^[[:blank:]]*MaxSpareThreads[[:blank:]]*.*/MaxSpareThreads    10/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">apache2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
 <span class="o">*</span> <span class="n">Restarting</span> <span class="n">web</span> <span class="n">server</span> <span class="n">apache2</span>                                                <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.4.54.225</span> <span class="k">for</span> <span class="n">ServerName</span>
 <span class="p">...</span> <span class="n">waiting</span> <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.4.54.225</span> <span class="k">for</span> <span class="n">ServerName</span>
                                                                         <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<h3 id="apache2_3">查看 Apache2 日志</h3>
<p>Apache2的日志放在 /var/log/apache2/ 目录下，可以直接使用filezilla去下载下来看。 </p>
<h2 id="nginx">使用 Nginx 搭建站点</h2>
<p>为什要使用<a href="http://wiki.ubuntu.org.cn/index.php?title=Nginx&amp;variant=zh-cn" title="Nginx">nginx</a>？因为apache太耗内存了，使用nginx可以节约内存。 </p>
<p>采用 nginx + php-fpm + mysql 搭建。 </p>
<h3 id="apache2_4">删除 apache2</h3>
<p>使用putty登录vps，执行如下命令： </p>
<p>输入如下命令关闭 apache2 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">stop</span>
</pre></div>


<p>如果输入正确，会提示如下信息，表示apache2已经停止 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">stop</span>
 <span class="o">*</span> <span class="n">Stopping</span> <span class="n">web</span> <span class="n">server</span> <span class="n">apache2</span>                                                  <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.3.175.133</span> <span class="k">for</span> <span class="n">ServerName</span>
 <span class="p">...</span> <span class="n">waiting</span>                                                             <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<p>输入如下命令删除 apache2 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">apache2</span> <span class="n">apache2</span><span class="mf">.2</span><span class="o">-</span><span class="n">common</span>
</pre></div>


<p>出现类似如下提示时，输入 Y 并回车。 </p>
<div class="hlcode"><pre><span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">1</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">7</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">5837</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mf">14.5</span><span class="n">MB</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">freed</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span>
</pre></div>


<p>最后会出现如下提示，表示已经删除 apache2 </p>
<div class="hlcode"><pre><span class="n">Removing</span> <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span> <span class="p">...</span>
<span class="n">Module</span> <span class="n">php5</span> <span class="n">disabled</span><span class="p">.</span>
<span class="n">Run</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span><span class="err">&#39;</span> <span class="n">to</span> <span class="n">activate</span> <span class="n">new</span> <span class="n">configuration</span><span class="o">!</span>
<span class="n">Removing</span> <span class="n">apache2</span><span class="o">-</span><span class="n">mpm</span><span class="o">-</span><span class="n">prefork</span> <span class="p">...</span>
 <span class="o">*</span> <span class="n">Stopping</span> <span class="n">web</span> <span class="n">server</span> <span class="n">apache2</span>                                                  <span class="n">apache2</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span>  <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">fully</span> <span class="n">qualified</span> <span class="n">domain</span> <span class="n">name</span><span class="p">,</span> <span class="n">using</span> <span class="mf">0.3.175.133</span> <span class="k">for</span> <span class="n">ServerName</span>
 <span class="p">...</span> <span class="n">waiting</span>                                                             <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
<span class="n">Removing</span> <span class="n">apache2</span><span class="mf">.2</span><span class="o">-</span><span class="n">common</span> <span class="p">...</span>
<span class="n">Removing</span> <span class="n">apache2</span><span class="o">-</span><span class="n">utils</span> <span class="p">...</span>
<span class="n">Removing</span> <span class="n">apache2</span><span class="mf">.2</span><span class="o">-</span><span class="n">bin</span> <span class="p">...</span>
</pre></div>


<h3 id="php5-fpm-php5-cgi">安装 php5-fpm php5-cgi</h3>
<p>安装 php5-fpm 执行如下命令： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">curl</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
</pre></div>


<p>出现下面的提示表示安装成功 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="mi">@241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">is</span> <span class="n">already</span> <span class="n">the</span> <span class="n">newest</span> <span class="n">version</span><span class="p">.</span>
<span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">set</span> <span class="n">to</span> <span class="n">manually</span> <span class="n">installed</span><span class="p">.</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">php</span><span class="o">-</span><span class="n">pear</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">libevent</span><span class="o">-</span><span class="mf">1.4</span><span class="o">-</span><span class="mi">2</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">2</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">3002</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">7967</span><span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main libevent-1.4-2 i386 1.4.13-stable-1 [56.2kB]</span>
<span class="nl">Get:</span><span class="mi">2</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick-updates/universe php5-fpm i386 5.3.3-1ubuntu9.5 [2946kB]</span>
<span class="n">Fetched</span> <span class="mi">3002</span><span class="n">kB</span> <span class="k">in</span> <span class="mi">1</span><span class="n">s</span> <span class="p">(</span><span class="mi">2181</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">libevent</span><span class="o">-</span><span class="mf">1.4</span><span class="o">-</span><span class="mf">2.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">21902</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">libevent</span><span class="o">-</span><span class="mf">1.4</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">libevent</span><span class="o">-</span><span class="mf">1.4</span><span class="o">-</span><span class="mi">2</span><span class="n">_1</span><span class="mf">.4.13</span><span class="o">-</span><span class="n">stable</span><span class="o">-</span><span class="mi">1</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm_5</span><span class="mf">.3.3</span><span class="o">-</span><span class="mi">1u</span><span class="n">buntu9</span><span class="mf">.5</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">libevent</span><span class="o">-</span><span class="mf">1.4</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="mf">1.4.13</span><span class="o">-</span><span class="n">stable</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="p">(</span><span class="mf">5.3.3</span><span class="o">-</span><span class="mi">1u</span><span class="n">buntu9</span><span class="mf">.5</span><span class="p">)</span> <span class="p">...</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">stop</span> <span class="n">runlevel</span> <span class="n">arguments</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">6</span><span class="p">)</span> <span class="k">do</span> <span class="n">not</span> <span class="n">match</span> <span class="n">LSB</span> <span class="n">Default</span><span class="o">-</span><span class="n">Stop</span> <span class="n">values</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span>
 <span class="o">*</span> <span class="n">Starting</span> <span class="n">PHP5</span> <span class="n">FPM</span><span class="p">...</span>                                                         <span class="n">Aug</span> <span class="mi">13</span> <span class="mo">06</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">50.352643</span> <span class="p">[</span><span class="n">WARNING</span><span class="p">]</span> <span class="p">[</span><span class="n">pool</span>  <span class="n">www</span><span class="p">]</span> <span class="n">pm</span><span class="p">.</span><span class="n">start_servers</span> <span class="n">is</span> <span class="n">not</span> <span class="n">set</span><span class="p">.</span> <span class="n">It</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">been</span> <span class="n">set</span> <span class="n">to</span> <span class="mf">20.</span>
                                                                        <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>

<span class="n">Creating</span> <span class="n">config</span> <span class="n">file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">fpm</span><span class="o">/</span><span class="n">php</span><span class="p">.</span><span class="n">ini</span> <span class="n">with</span> <span class="n">new</span> <span class="n">version</span>
<span class="n">Processing</span> <span class="n">triggers</span> <span class="k">for</span> <span class="n">libc</span><span class="o">-</span><span class="n">bin</span> <span class="p">...</span>
<span class="n">ldconfig</span> <span class="n">deferred</span> <span class="n">processing</span> <span class="n">now</span> <span class="n">taking</span> <span class="n">place</span>
</pre></div>


<p>安装完毕后，重启下 php5-fpm，执行如下命令重启 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
</pre></div>


<p>出现如下提示，表示重启成功 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="mi">@241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
<span class="o">*</span> <span class="n">Stopping</span> <span class="n">PHP5</span> <span class="n">FPM</span><span class="p">...</span>                                                  <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
<span class="o">*</span> <span class="n">Starting</span> <span class="n">PHP5</span> <span class="n">FPM</span><span class="p">...</span>                                                  <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
<span class="n">Jun</span> <span class="mi">25</span> <span class="mi">19</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">58.592184</span> <span class="p">[</span><span class="n">WARNING</span><span class="p">]</span> <span class="p">[</span><span class="n">pool</span> <span class="n">www</span><span class="p">]</span> <span class="n">pm</span><span class="p">.</span><span class="n">start_servers</span> <span class="n">is</span> <span class="n">not</span> <span class="n">set</span><span class="p">.</span> <span class="n">It</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">been</span> <span class="n">set</span> <span class="n">to</span> <span class="mf">20.</span>
</pre></div>


<h3 id="mysql_3">安装 mysql</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=Vps&amp;variant=zh-cn#.E5.AE.89.E8.A3.85_mysql_.E6.95.B0.E6.8D.AE.E5.BA.93.E6.9C.8D.E5.8A.A1" title="Vps">见前面的安装 mysql 的步骤。</a></p>
<h3 id="nginx_1">安装 nginx</h3>
<p>使用putty登录vps，执行如下命令： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>
</pre></div>


<p>出现如下提示，表示已经安装完毕： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">ufw</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">nginx</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">1</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">341</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">827</span><span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/universe nginx i386 0.7.67-3ubuntu1 [341kB]</span>
<span class="n">Fetched</span> <span class="mi">341</span><span class="n">kB</span> <span class="n">in</span> <span class="mi">0</span><span class="n">s</span> <span class="p">(</span><span class="mi">437</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">nginx</span><span class="p">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">21918</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">nginx</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">nginx_0</span><span class="mf">.7.67</span><span class="o">-</span><span class="mi">3u</span><span class="n">buntu1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">nginx</span> <span class="p">(</span><span class="mf">0.7.67</span><span class="o">-</span><span class="mi">3u</span><span class="n">buntu1</span><span class="p">)</span> <span class="p">...</span>
</pre></div>


<p>再执行下面的命令启动nginx服务： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">start</span>
</pre></div>


<p>结果如下所示，表示nginx顺利启动： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">start</span>
<span class="n">Starting</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">nginx</span><span class="p">.</span>
</pre></div>


<h3 id="_14">测试站点</h3>
<p>由于nginx默认的站点不支持php，所以需要修改默认站点。 </p>
<p>编辑文件名为 default.txt ，注意下面的 server_name 修改为你的vps的ip地址，可以写一个IP，也可以都写上，IP和IP之间有空格。 </p>
<p>配置文件中的 root 就是站点的目录了，可以更改为你的站点的路径。 </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="mf">184.82.9.30</span> <span class="mf">184.82.9.31</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>将 default.txt 文件使用 filezilla 上传到 /etc/nginx/sites-enabled 目录下 </p>
<p>使用 putty 登录vps，输入如下命令重启 nginx 服务 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<p>重启结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
<span class="n">Restarting</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">nginx</span><span class="p">.</span>
</pre></div>


<h4 id="phpsysinfo_1">安装phpsysinfo</h4>
<p>按照前面apache2讲述的安装 </p>
<h4 id="php_2">安装 php 探针</h4>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=Vps&amp;variant=zh-cn#.E5.AE.89.E8.A3.85_php_.E6.8E.A2.E9.92.88" title="Vps">按照前面apache2讲述的安装</a></p>
<h4 id="phpmyadmin_1">安装 phpmyadmin</h4>
<p>照前面 Apache2 安装 phpmyadmin, 注意第二步不要再按空格选择 apache2 , 直接回车下一步。 </p>
<p>如果已经之前已经安装过 phpmyadmin ，不需要删除，继续使用。 </p>
<p>安装完毕 phpmyadmin 后， 继续在 putty 里面执行如下命令即可： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">phpmyadmin</span> <span class="p">.</span>
</pre></div>


<p>执行情况如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">#</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">phpmyadmin</span> <span class="p">.</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">#</span>
</pre></div>


<p>然后就可以在浏览器里面访问 phpmyadmin 了。 访问地址： <a href="http://184.82.9.30/phpmyadmin/" title="http://184.82.9.30/phpmyadmin/">http://184.82.9.30/phpmyadmin/</a></p>
<h3 id="_15">配置虚拟站点</h3>
<p>以上运行环境均已经安装完毕，下面讲如何配置 nginx 的多域名。 </p>
<p>假设前提： 你有一个域名 test.com ，你希望搭建两个站点，第一个站点是 www.test.com 和 test.com 为主页，同时希望提供 bbs.test.com 为论坛。 </p>
<p>下面的文档对多个不同的域名也是适用的。 </p>
<h4 id="_16">配置域名</h4>
<p>参考上面 apache2 的配置域名部分。 </p>
<h4 id="_17">上传程序</h4>
<p>参考上面 apache2 的上传程序部分。 </p>
<h4 id="_18">多域名配置</h4>
<p>这里推荐编辑器直接使用记事本，不要使用其他的高级编辑器。 </p>
<p>编辑www.test.com的站点配置文件 test.com.txt </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>编辑bbs.test.com的站点配置文件 bbs.test.com.txt </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">bbs</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bbs</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>将这两个文件使用 filezilla 上传到 /etc/nginx/sites-enabled/ 目录 </p>
<h4 id="nginx_2">Nginx 伪静态</h4>
<p>下面是常用的一些伪静态配置，复制出来，插入到站点的配置文件最后一个 } 号之前，如下： </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">bbs</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bbs</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
       <span class="err">#伪静态代码段开始</span>    
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="p">...............................</span>
                <span class="p">}</span>
       <span class="err">#伪静态代码段结束</span>    
        <span class="p">}</span>
</pre></div>


<p>Discuz!X 在 Nginx 下的伪静态配置如下： </p>
<div class="hlcode"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">topic</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">topic</span><span class="o">&amp;</span><span class="n">topic</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">aid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">forum</span><span class="o">-</span><span class="p">(</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">forumdisplay</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="kr">thread</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">viewthread</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">extra</span><span class="o">=</span><span class="n">page</span><span class="o">%</span><span class="mi">3</span><span class="n">D</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">group</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">group</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">space</span><span class="o">-</span><span class="p">(</span><span class="n">username</span><span class="o">|</span><span class="n">uid</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">home</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">space</span><span class="o">&amp;</span><span class="err">$</span><span class="mi">2</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">home</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">space</span><span class="o">&amp;</span><span class="n">uid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="k">do</span><span class="o">=</span><span class="n">blog</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">fid</span><span class="o">|</span><span class="n">tid</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">action</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">value</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>


<p>将这一段代码加入到上面的站点配置文件中，例如： </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">bbs</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bbs</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">topic</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">topic</span><span class="o">&amp;</span><span class="n">topic</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">article</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">portal</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">aid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">forum</span><span class="o">-</span><span class="p">(</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">forumdisplay</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="kr">thread</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">viewthread</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">extra</span><span class="o">=</span><span class="n">page</span><span class="o">%</span><span class="mi">3</span><span class="n">D</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">group</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">forum</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">group</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">space</span><span class="o">-</span><span class="p">(</span><span class="n">username</span><span class="o">|</span><span class="n">uid</span><span class="p">)</span><span class="o">-</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">home</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">space</span><span class="o">&amp;</span><span class="err">$</span><span class="mi">2</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">home</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">mod</span><span class="o">=</span><span class="n">space</span><span class="o">&amp;</span><span class="n">uid</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="k">do</span><span class="o">=</span><span class="n">blog</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="o">^</span><span class="p">([</span><span class="o">^</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">fid</span><span class="o">|</span><span class="n">tid</span><span class="p">)</span><span class="o">-</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">$</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">action</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">value</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>WordPress 在 Nginx 下的伪静态配置如下： </p>
<div class="hlcode"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="n">request_filename</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">){</span>
                <span class="n">rewrite</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="n">request_filename</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">){</span>
                <span class="n">rewrite</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!-</span><span class="n">f</span> <span class="err">$</span><span class="n">request_filename</span><span class="p">){</span>
                <span class="n">rewrite</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>ECShop 在 Nginx 下的伪静态配置如下： </p>
<div class="hlcode"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!-</span><span class="n">e</span> <span class="err">$</span><span class="n">request_filename</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/index\.html&quot;</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category$&quot;</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/feed-c([0-9]+)\.xml$&quot;</span> <span class="o">/</span><span class="n">feed</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/feed-b([0-9]+)\.xml$&quot;</span> <span class="o">/</span><span class="n">feed</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/feed\.xml$&quot;</span> <span class="o">/</span><span class="n">feed</span><span class="p">.</span><span class="n">php</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)-b([0-9]+)-min([0-9]+)-max([0-9]+)-attr([^-]*)-([0-9]+)-(.+)-([a-zA-Z]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">price_min</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">price_max</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">filter_attr</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">7</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">8</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)-b([0-9]+)-min([0-9]+)-max([0-9]+)-attr([^-]*)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">price_min</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">price_max</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">filter_attr</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)-b([0-9]+)-([0-9]+)-(.+)-([a-zA-Z]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)-b([0-9]+)-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)-b([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">brand</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/category-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">category</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/goods-([0-9]+)(.*)\.html&quot;</span> <span class="o">/</span><span class="n">goods</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/article_cat-([0-9]+)-([0-9]+)-(.+)-([a-zA-Z]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">article_cat</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/article_cat-([0-9]+)-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">article_cat</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/article_cat-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">article_cat</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/article-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">article</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/brand-([0-9]+)-c([0-9]+)-([0-9]+)-(.+)-([a-zA-Z]+)\.html&quot;</span> <span class="o">/</span><span class="n">brand</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/brand-([0-9]+)-c([0-9]+)-([0-9]+)(.*)\.html&quot;</span> <span class="o">/</span><span class="n">brand</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/brand-([0-9]+)-c([0-9]+)(.*)\.html&quot;</span> <span class="o">/</span><span class="n">brand</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">cat</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/brand-([0-9]+)(.*)\.html&quot;</span> <span class="o">/</span><span class="n">brand</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/tag-(.*)\.html&quot;</span> <span class="o">/</span><span class="n">search</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">keywords</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/snatch-([0-9]+)\.html$&quot;</span> <span class="o">/</span><span class="n">snatch</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/group_buy-([0-9]+)\.html$&quot;</span> <span class="o">/</span><span class="n">group_buy</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">act</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/auction-([0-9]+)\.html$&quot;</span> <span class="o">/</span><span class="n">auction</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">act</span><span class="o">=</span><span class="n">view</span><span class="o">&amp;</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/exchange-id([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">exchange</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">act</span><span class="o">=</span><span class="n">view</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/exchange-([0-9]+)-min([0-9]+)-max([0-9]+)-([0-9]+)-(.+)-([a-zA-Z]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">exchange</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">integral_min</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">integral_max</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">5</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">6</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/exchange-([0-9]+)-([0-9]+)-(.+)-([a-zA-Z]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">exchange</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">order</span><span class="o">=</span><span class="err">$</span><span class="mi">4</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/exchange-([0-9]+)-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">exchange</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span> <span class="n">last</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="s">&quot;^/exchange-([0-9]+)(.*)\.html$&quot;</span> <span class="o">/</span><span class="n">exchange</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">cat_id</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span> <span class="n">last</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<h4 id="_19">修改上传文件权限</h4>
<p>由于上传的文件的所有者为 root ，Nginx 无法正常写入，所以需要设置上传文件的宿主为 www-data。 </p>
<p>使用putty登录vps执行如下命令，设置 /var/www下的所有文件的宿主都是 www-data，这样nginx就可以正常读写： </p>
<div class="hlcode"><pre><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">root</span><span class="err">@</span><span class="mi">195669</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
<span class="n">Restarting</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">nginx</span><span class="p">.</span>
</pre></div>


<h4 id="_20">安装配置</h4>
<p>见 apache2 的安装配置部分 </p>
<h3 id="nginx-301">nginx 301 跳转</h3>
<p>如果希望将 test.com 跳转到 www.test.com ，如下配置 test.com.txt 上传到 /etc/nginx/sites-enabled/ 目录即可。 </p>
<div class="hlcode"><pre><span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="o">^/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.test.com/$1 permanent;</span>
<span class="p">}</span>
</pre></div>


<p>当然你也可以去 test.com 的域名那里设置 301 跳转。 </p>
<h3 id="nginx_3">nginx 优化</h3>
<p>请一定要执行本步骤，不要认为小站，访问的人数少，有时候蜘蛛会按照超过20个以上的并发抓取数据，直接爆掉vps。表现为：可以ping，但网站打不开、数据库连不上或无法ssh。 </p>
<p>为了防止Vps被大的访问量爆掉，需要限制并发数，这里#1 VPS 调整为10， #2可以将下面的10修改为20，#3为30，以此类推。 </p>
<p>也可以根据指南最后的压力测试来确定最大并发数，确定后，将下面的命令中的 10 改为你确定的并发数即可，其它数值如 5 不要修改。 </p>
<p>因为命令中包括了 ` 号，所以请复制命令后到putty直接按鼠标右键粘贴执行： </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">max_children</span> <span class="o">=</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">max_children</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="err">&#39;</span> <span class="err">`</span><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">l</span> <span class="n">pm</span><span class="p">.</span><span class="n">max_children</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">fpm</span><span class="err">`</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">start_servers</span> <span class="o">=</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">start_servers</span> <span class="o">=</span> <span class="mi">5</span><span class="o">/</span><span class="err">&#39;</span> <span class="err">`</span><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">l</span> <span class="n">pm</span><span class="p">.</span><span class="n">max_children</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">fpm</span><span class="err">`</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">max_spare_servers</span> <span class="o">=</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/</span><span class="n">pm</span><span class="p">.</span><span class="n">max_spare_servers</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="err">&#39;</span> <span class="err">`</span><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">l</span> <span class="n">pm</span><span class="p">.</span><span class="n">max_children</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">fpm</span><span class="err">`</span>
</pre></div>


<p>执行完毕后，重启下 php-fpm 服务： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
</pre></div>


<h3 id="nginx-ip">nginx 限制同一IP的并发数和连接流量</h3>
<p>在终端执行下面语句开启nginx并发支持： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;limit_conn_zone \$binary_remote_addr zone=one:10m;&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">limitconn</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>然后打开虚拟站点配置文件，如编辑上面例子中的 bbs.test.com 站点配置文件 bbs.test.com.txt， </p>
<p>在 server_name bbs.test.com; 这一行下面插入如下： </p>
<div class="hlcode"><pre> <span class="n">limit_conn</span> <span class="n">one</span> <span class="mi">20</span><span class="p">;</span>
 <span class="n">limit_rate</span> <span class="mi">200</span><span class="n">k</span><span class="p">;</span>
</pre></div>


<p>上面的20，标示同一IP的最大并发数为20。200k为连接的最大速度为200k。 </p>
<p>注意，这里控制的流量是针对单一连接的，并不是同一IP的最大速度，其最大速度为200k*20=4000k。 </p>
<p>最终修改后的结果如下所示： </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">bbs</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">limit_conn</span> <span class="n">one</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">limit_rate</span> <span class="mi">200</span><span class="n">k</span><span class="p">;</span>
        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">root</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bbs</span><span class="o">/</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
                <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
                <span class="n">fastcgi_param</span>  <span class="n">SCRIPT_FILENAME</span>    <span class="err">$</span><span class="n">document_root</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
                <span class="n">fastcgi_pass</span>  <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">9000</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>


<p>将上面的配置文件重新使用 filezilla 上传到 /etc/nginx/sites-enabled/ 目录，覆盖后，执行以下命令重启 nginx 使配置生效： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<h3 id="nginx_4">查看 nginx 日志</h3>
<p>Nginx的日志放在 /var/log/nginx/ 目录下，可以使用 filezilla 下载下来查看。 </p>
<h3 id="cdn">配置CDN或反向代理</h3>
<p>我们需要将 www.test.com 或 test.com 的访问反向代理到 192.168.1.1 地址上。 </p>
<p>1 执行如下命令来建立缓存目录和临时目录，这里默认为最大20g的缓存空间，可以根据你的实际情况增加或减小，修改地方为 max_size=20g; </p>
<div class="hlcode"><pre><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">cache</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">temp</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">echo</span> <span class="s">&quot;proxy_cache_path /var/www/cache levels=1:2 keys_zone=cache_one:500m inactive=7d max_size=20g;&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cdn</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s">&quot;proxy_temp_path /var/www/temp;&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cdn</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>2 编辑 www.test.com 站点的反向代理配置文件 test.com.txt 如下： </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span> 
                <span class="n">proxy_cache</span> <span class="n">cache_one</span><span class="p">;</span>
                <span class="n">proxy_cache_valid</span>  <span class="mi">200</span> <span class="mi">304</span> <span class="mi">30</span><span class="n">d</span><span class="p">;</span>
                <span class="n">proxy_cache_key</span> <span class="err">$</span><span class="n">host</span><span class="err">$</span><span class="n">uri</span><span class="err">$</span><span class="n">is_args</span><span class="err">$</span><span class="n">args</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">http_host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
                <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//192.168.1.1;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>上面的配置中缓存设置的为30天，你可以根据实际需求调整 proxy_cache_valid 200 304 30d; 行最后的 30d 为其它的值，如缓存1天为： proxy_cache_valid 200 304 1d; </p>
<p>如果不需要缓存，直接设置为如下： </p>
<div class="hlcode"><pre><span class="n">server</span>  <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span> 
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">http_host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
                <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//192.168.1.1;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>3 将这个文件使用 filezilla 上传到 /etc/nginx/sites-enabled/ 目录 </p>
<p>4 执行下面的重启 nginx 命令，使配置生效。 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<p>5 然后就可以去域名管理那里将 www.test.com test.com 的IP设置为VPS的IP即可。 </p>
<h2 id="_21">安装邮件服务器</h2>
<p>注意：官方对架设邮件服务器非常限制，担心对外发垃圾邮件，一旦被举报，就直接封VPS，所以下面的配置中，我们将邮件通过 Gmail 的账号转发出去。 </p>
<p>在 Putty 使用如下命令，安装 postfix，替换下面命令中的第一行 mydomain.com 为 你VPS上绑定的域名，如果有多个域名，选择其中一个即可。 </p>
<div class="hlcode"><pre><span class="n">hostname</span> <span class="n">mydomain</span><span class="p">.</span><span class="n">com</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">postfix</span> <span class="n">mailutils</span> <span class="n">libsasl2</span><span class="o">-</span><span class="mi">2</span> <span class="n">ca</span><span class="o">-</span><span class="n">certificates</span> <span class="n">libsasl2</span><span class="o">-</span><span class="n">modules</span>
</pre></div>


<p>在弹出的对话框中，如果你的邮件服务器仅仅为你本地的程序使用，可以直接选择 Local only ,否则请选择其它选项。 </p>
<p>安装完成后，请运行如下命令限制 postfix 为 10 个并发： </p>
<div class="hlcode"><pre><span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">default_process_limit</span><span class="o">=</span><span class="mi">10</span>
</pre></div>


<p>将邮件服务器采用gmail账号做邮件中转，首先你需要先有一个gmail的账号： USERNAME@gmail.com PASSWORD ,为了避免出现Gmail的图形验证登陆，你可以开启Gmail的账号的二次验证，然后创建一个应用密码，这样你可以采用应用密码来配置。 </p>
<div class="hlcode"><pre><span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">relayhost</span><span class="o">=</span><span class="n">smtp</span><span class="p">.</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">587</span>
<span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">smtp_sasl_auth_enable</span><span class="o">=</span><span class="n">yes</span>
<span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">smtp_sasl_password_maps</span><span class="o">=</span><span class="n">hash</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">sasl_passwd</span>
<span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">smtp_sasl_security_options</span><span class="o">=</span><span class="n">noanonymous</span>
<span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">smtp_tls_CAfile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="p">.</span><span class="n">crt</span>
<span class="n">postconf</span> <span class="o">-</span><span class="n">e</span> <span class="n">smtp_use_tls</span><span class="o">=</span><span class="n">yes</span>
</pre></div>


<p>下面的脚本中的 USERNAME 和 PASSWORD 单词请改为你正确的用户名和密码， </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;smtp.gmail.com:587    USERNAME@gmail.com:PASSWORD&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">sasl_passwd</span>
<span class="n">chmod</span> <span class="mi">400</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">sasl_passwd</span>
<span class="n">postmap</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">sasl_passwd</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">postfix</span> <span class="n">restart</span>
</pre></div>


<p>完成了本地邮件服务器的搭建。 </p>
<p>测试下: </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;Test mail&quot;</span> <span class="o">|</span> <span class="n">mail</span> <span class="o">-</span><span class="n">s</span> <span class="s">&quot;Test&quot;</span> <span class="n">you</span><span class="err">@</span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>查看邮件投递日志： </p>
<div class="hlcode"><pre><span class="n">tail</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mail</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>这样你的程序就可以直接使用本地的SMTP服务对外发邮件了。 </p>
<h2 id="ftp">搭建临时的FTP服务</h2>
<p>前面已经提到了可以直接使用 Sftp 来访问 Vps，如果需要临时的搭建Ftp，则按下面的指南进行。 </p>
<h3 id="pyftpdlib">下载 pyftpdlib 库</h3>
<p>在 Putty 使用如下命令，下载 pyftpdlib 库并解压缩。 </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">root</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//pyftpdlib.googlecode.com/files/pyftpdlib-0.7.0.tar.gz</span>
<span class="n">tar</span> <span class="n">xzvf</span> <span class="n">pyftpdlib</span><span class="o">-</span><span class="mf">0.7.0</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>解压缩完毕后，我们可以临时开启ftp了： </p>
<h3 id="ftp_1">开启匿名ftp服务</h3>
<p>开启匿名ftp服务，主目录为 /var/www ；默认是21端口；-d 是设置主目录。 </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">pyftpdlib</span><span class="o">-</span><span class="mf">0.7.0</span><span class="o">/</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyftpdlib</span><span class="p">.</span><span class="n">ftpserver</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</pre></div>


<p>运行该命令后，客户端就可以使用 anonymous 帐号登录，下载了。 </p>
<p>按 Ctrl+C 结束 Ftp 服务器。 </p>
<h3 id="ftp_2">开启允许写入ftp服务</h3>
<p>添加 -w 参数即可允许写入，不可以长时间开，小心被其它人删除数据。 </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">pyftpdlib</span><span class="o">-</span><span class="mf">0.7.0</span><span class="o">/</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyftpdlib</span><span class="p">.</span><span class="n">ftpserver</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</pre></div>


<p>运行该命令后，客户端就可以使用匿名帐号登录，下载和上传了。 </p>
<h3 id="ftp_3">登录ftp的账号</h3>
<p>IP： VPS服务器的IP 用户名： anonymous 密码：随便输入一个邮箱即可。 </p>
<h3 id="ftp_4">关闭ftp服务</h3>
<p>直接关闭终端就会退出ftp服务，如果不想关闭可以同时按下 ctrl+c 退出ftp服务。 </p>
<h2 id="vps">VPS 自我监控</h2>
<h3 id="_22">监控内存和负载</h3>
<p>为了防止VPS的内存超过，或系统负载过重，建议采用如下监控脚本： </p>
<p>规则：当剩余内存小于1M或当前负载大于3时，系统重启。 </p>
<p>在 Putty 里面执行下面的语句，创建 /usr/bin/vpscheck.sh 脚本， </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vpscheck</span><span class="p">.</span><span class="n">sh</span>
<span class="cp">#!/bin/bash</span>
<span class="n">free_mem</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">grep</span> <span class="n">MemFree</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">Free</span> <span class="n">Memory</span><span class="o">:</span><span class="err">&#39;$</span><span class="n">free_mem</span>
<span class="k">if</span> <span class="p">[</span> <span class="err">$</span><span class="n">free_mem</span> <span class="o">-</span><span class="n">lt</span> <span class="mi">1000</span> <span class="p">];</span><span class="n">then</span>
   <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
<span class="n">fi</span>
<span class="n">load</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">awk</span> <span class="err">&#39;$</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">1</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">loadavg</span><span class="p">)</span>
<span class="n">echo</span> <span class="s">&quot;Load:&quot;</span><span class="err">$</span><span class="n">load</span>
<span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">n</span> <span class="s">&quot;$load&quot;</span> <span class="p">];</span><span class="n">then</span>
   <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
<span class="n">fi</span>
<span class="n">EOF</span>
</pre></div>


<p>再配置定时器，让上面的脚本可以每5分钟运行一次检查，继续在putty里面执行如下命令： </p>
<div class="hlcode"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vpscheck</span><span class="p">.</span><span class="n">sh</span>
<span class="n">echo</span> <span class="s">&quot;*/5 * * * * root  /usr/bin/vpscheck.sh&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">vpscheck</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span> <span class="n">restart</span>
</pre></div>


<p>完成性能监控。 </p>
<h3 id="_23">监控网站并发数</h3>
<p>为了防止网站无法访问，做如下检测： </p>
<p>规则：当访问的并发数超过100，系统重启。 </p>
<p>在 Putty 里面执行下面的语句，创建 /usr/bin/wwwcheck.sh 脚本， </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wwwcheck</span><span class="p">.</span><span class="n">sh</span>
<span class="cp">#!/bin/bash</span>
<span class="n">count</span><span class="o">=</span><span class="err">`</span><span class="n">netstat</span> <span class="o">-</span><span class="n">na</span><span class="o">|</span><span class="n">grep</span> <span class="o">:</span><span class="mi">80</span><span class="o">|</span><span class="n">wc</span> <span class="o">-</span><span class="n">l</span><span class="err">`</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">Count</span><span class="o">:</span><span class="err">&#39;$</span><span class="n">count</span>
<span class="k">if</span> <span class="p">[</span> <span class="err">$</span><span class="n">count</span> <span class="o">-</span><span class="n">gt</span> <span class="mi">100</span> <span class="p">];</span><span class="n">then</span>
   <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
<span class="n">fi</span>
<span class="n">EOF</span>
</pre></div>


<p>再配置定时器，让上面的脚本可以每5分钟运行一次检查，继续在putty里面执行如下命令： </p>
<div class="hlcode"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wwwcheck</span><span class="p">.</span><span class="n">sh</span>
<span class="n">echo</span> <span class="s">&quot;*/5 * * * * root  /usr/bin/wwwcheck.sh&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">wwwcheck</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span> <span class="n">restart</span>
</pre></div>


<p>完成网站并发监控。 </p>
<h2 id="_24">安全相关事项</h2>
<h3 id="_25">防止扫描</h3>
<p>vps的root密码不要设置的太简单，这样很容易被攻破，你可以安装如下软件来降低vps被攻破的机会。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Attention_niels_epting.svg&amp;variant=zh-cn" title="Attention niels epting.svg"><img alt="" src="http://wiki.ubuntu.org.cn/images/thumb/5/51/Attention_niels_epting.svg/18px-Attention_niels_epting.svg.png" /></a> 请慎重考虑，已经发生了多起自己的IP被封的情况，如果你的本地互联网IP是固定的，请不要执行本段。 </p>
<p>输入如下命令： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">denyhosts</span>
</pre></div>


<p>提示如下表示安装完成： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">denyhosts</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">denyhosts</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">1</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">26</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mf">73.8</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">451</span><span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/universe denyhosts all 2.6-7 [73.8kB]</span>
<span class="n">Fetched</span> <span class="mf">73.8</span><span class="n">kB</span> <span class="n">in</span> <span class="mi">0</span><span class="n">s</span> <span class="p">(</span><span class="mi">131</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">denyhosts</span><span class="p">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">22621</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">denyhosts</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">denyhosts_2</span><span class="mf">.6</span><span class="o">-</span><span class="mi">7</span><span class="n">_all</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">denyhosts</span> <span class="p">(</span><span class="mf">2.6</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span> <span class="p">...</span>
 <span class="o">*</span> <span class="n">Starting</span> <span class="n">DenyHosts</span> <span class="n">denyhosts</span>                                          <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<p>这样如果用户5次密码输入错误，将会自动将其IP加到黑名单，不允许再登录。 </p>
<h3 id="php_3">防止php木马</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Attention_niels_epting.svg&amp;variant=zh-cn" title="Attention niels epting.svg"><img alt="" src="http://wiki.ubuntu.org.cn/images/thumb/5/51/Attention_niels_epting.svg/18px-Attention_niels_epting.svg.png" /></a> 通过设置限制php的 eval 函数来防止木马，可能会导致某些程序无法正常运行，目前在 Ubuntu 14.04 版本上测试通过。 </p>
<p>编辑 /etc/php5/conf.d/suhosin.ini 文件，如果找不到这个文件，执行如下命令安装 php5-suhosin 模块 </p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">suhosin</span>
</pre></div>


<p>打开此文件后，找到行： </p>
<div class="hlcode"><pre><span class="p">;</span><span class="n">suhosin</span><span class="p">.</span><span class="n">executor</span><span class="p">.</span><span class="n">eval</span><span class="p">.</span><span class="n">blacklist</span> <span class="o">=</span>
</pre></div>


<p>修改为： </p>
<div class="hlcode"><pre><span class="nx">suhosin</span><span class="p">.</span><span class="nx">executor</span><span class="p">.</span><span class="nb">eval</span><span class="p">.</span><span class="nx">blacklist</span> <span class="o">=</span> <span class="nx">include</span><span class="p">,</span><span class="nx">include_once</span><span class="p">,</span><span class="nx">require</span><span class="p">,</span><span class="nx">require_once</span><span class="p">,</span><span class="nx">curl_init</span><span class="p">,</span><span class="nx">fpassthru</span><span class="p">,</span><span class="nx">file</span><span class="p">,</span><span class="nx">base64_encode</span><span class="p">,</span><span class="nx">base64_decode</span><span class="p">,</span><span class="nx">mail</span><span class="p">,</span><span class="nx">exec</span><span class="p">,</span><span class="nx">system</span><span class="p">,</span><span class="nx">proc_open</span><span class="p">,</span><span class="nx">leak</span><span class="p">,</span><span class="nx">syslog</span><span class="p">,</span><span class="nx">pfsockopen</span><span class="p">,</span><span class="nx">shell_exec</span><span class="p">,</span><span class="nx">ini_restore</span><span class="p">,</span><span class="nx">symlink</span><span class="p">,</span><span class="nx">stream_socket_server</span><span class="p">,</span><span class="nx">proc_nice</span><span class="p">,</span><span class="nx">popen</span><span class="p">,</span><span class="nx">proc_get_status</span><span class="p">,</span><span class="nx">dl</span><span class="p">,</span> <span class="nx">pcntl_exec</span><span class="p">,</span> <span class="nx">pcntl_fork</span><span class="p">,</span> <span class="nx">pcntl_signal</span><span class="p">,</span><span class="nx">pcntl_waitpid</span><span class="p">,</span> <span class="nx">pcntl_wexitstatus</span><span class="p">,</span> <span class="nx">pcntl_wifexited</span><span class="p">,</span> <span class="nx">pcntl_wifsignaled</span><span class="p">,</span><span class="nx">pcntl_wifstopped</span><span class="p">,</span> <span class="nx">pcntl_wstopsig</span><span class="p">,</span> <span class="nx">pcntl_wtermsig</span><span class="p">,</span> <span class="nx">socket_accept</span><span class="p">,</span><span class="nx">socket_bind</span><span class="p">,</span> <span class="nx">socket_connect</span><span class="p">,</span> <span class="nx">socket_create</span><span class="p">,</span> <span class="nx">socket_create_listen</span><span class="p">,</span><span class="nx">socket_create_pair</span><span class="p">,</span><span class="nx">link</span><span class="p">,</span><span class="nx">register_shutdown_function</span><span class="p">,</span><span class="nx">register_tick_function</span>
</pre></div>


<p>然后重启下 apache2 或 php5-fpm 即可 </p>
<h3 id="_26">木马基本检查和手工清除</h3>
<p>一般采用如下命令去检查有危险文件： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
<span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="n">base64_decode</span> <span class="o">*|</span><span class="n">more</span>
</pre></div>


<p>如果看到类似这样的东西，就可以肯定中木马了： </p>
<div class="hlcode"><pre><span class="n">eval</span><span class="p">(</span><span class="n">base64_decode</span><span class="p">(</span><span class="s">&quot;一大串无意义字母</span>
<span class="err">或</span>
<span class="n">eval</span><span class="p">(</span><span class="n">base64_decode</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s">&quot;</span>
<span class="err">或</span>
<span class="n">eval</span><span class="p">(</span><span class="n">gzuncompress</span><span class="p">(</span><span class="n">base64_decode</span>
</pre></div>


<p>最佳方案，重装系统，重新配置过。 </p>
<p>也可以尝试使用下面的命令手工清除 </p>
<div class="hlcode"><pre><span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="err">&#39;</span><span class="o">*</span><span class="p">.</span><span class="n">php</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">exec</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">r</span> <span class="s">&quot;s/eval.{0,10}\(.{0,10}base64_decode.*?\);//g&quot;</span> <span class="p">{}</span> <span class="err">\</span><span class="p">;</span>
<span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="err">&#39;</span><span class="o">*</span><span class="p">.</span><span class="n">php</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">exec</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">r</span> <span class="s">&quot;s/eval.{0,10}\(.{0,10}gzuncompress.{0,10}\(.{0,10}base64_decode.*?\);//g&quot;</span> <span class="p">{}</span> <span class="err">\</span><span class="p">;</span>
<span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="err">&#39;</span><span class="o">*</span><span class="p">.</span><span class="n">php</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">exec</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">r</span> <span class="s">&quot;s/eval.{0,10}\(.{0,10}stripslashes.*?\);//g&quot;</span> <span class="p">{}</span> <span class="err">\</span><span class="p">;</span>
</pre></div>


<p>然后继续检查有没有群发邮件的木马： </p>
<div class="hlcode"><pre><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">E</span> <span class="err">&#39;</span><span class="n">POST</span><span class="p">.</span><span class="o">*</span><span class="n">pfsockopen</span><span class="p">.</span><span class="o">*</span><span class="n">EHLO</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
</pre></div>


<p>发现后，如果确定是木马，采用如下命令批量删除木马文件： </p>
<div class="hlcode"><pre><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">E</span> <span class="err">&#39;</span><span class="n">POST</span><span class="p">.</span><span class="o">*</span><span class="n">pfsockopen</span><span class="p">.</span><span class="o">*</span><span class="n">EHLO</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span>
</pre></div>


<p>查查 eval 和 fwrite 函数 </p>
<div class="hlcode"><pre><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">E</span> <span class="err">&#39;</span><span class="n">REQUEST</span><span class="p">.</span><span class="o">*</span><span class="n">eval</span><span class="p">.</span><span class="o">*</span><span class="n">fwrite</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
</pre></div>


<p>发现后，如果确认是木马，采用如下命令批量删除木马文件： </p>
<div class="hlcode"><pre><span class="n">grep</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">E</span> <span class="err">&#39;</span><span class="n">REQUEST</span><span class="p">.</span><span class="o">*</span><span class="n">eval</span><span class="p">.</span><span class="o">*</span><span class="n">fwrite</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>  <span class="o">|</span> <span class="n">xargs</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span>
</pre></div>


<p>最后重点检查 包含 eval 函数的 php 文件 </p>
<div class="hlcode"><pre> <span class="n">find</span> <span class="p">.</span> <span class="o">-</span><span class="n">name</span> <span class="s">&quot;*.php&quot;</span> <span class="o">-</span><span class="n">exec</span> <span class="n">grep</span> <span class="o">-</span><span class="n">l</span> <span class="n">eval</span> <span class="p">{}</span> <span class="err">\</span><span class="p">;</span>
</pre></div>


<p>如果发现有无意义的单词，多半也是中木马了，不过这种需要手工删除相关被感染代码。 </p>
<h3 id="ip">根据访问日志批量封IP</h3>
<p>有时候，我们可以去检查 HTTP 的访问日志发现异常，然后根据这些异常来封 IP。 </p>
<p>首先检查异常， 关键词：xmlrpc.php ，下面的命令可以根据你的需求来调整关键词，其中 access.log 为你的 HTTP 的访问日志文件，可以根据实际情况修改。 </p>
<p>执行下面的命令，可以显示所有的 IP 地址，来进行查看： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="n">access</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;xmlrpc.php&quot;</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">1</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span>
</pre></div>


<p>确认无误后，执行下面的命令进行封禁： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="n">access</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;xmlrpc.php&quot;</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">1</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">I</span> <span class="p">{}</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">s</span> <span class="p">{}</span><span class="o">/</span><span class="mi">32</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<p>执行完毕后，可以使用如下命令查看封禁结果： </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">L</span>
</pre></div>


<p>注意，上面只是临时封禁，如果重启VPS，将会清空规则。 </p>
<h3 id="_27">关闭邮件服务</h3>
<p>由于国外对发垃圾邮件的处罚很重，会导致 VPS 被终止，所以为了防止误发邮件或被木马、黑客利用，如果你不需要发送邮件，则关闭邮件服务： </p>
<p>1 删除邮件服务 执行如下命令删除服务器的邮件程序： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">postfix</span><span class="o">*</span> <span class="n">sendmail</span><span class="o">*</span> <span class="n">procmail</span><span class="o">*</span>
</pre></div>


<p>2 防火墙屏蔽邮件转发 执行如下命令屏蔽邮件端口转发: </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">25</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;$</span><span class="n">i</span><span class="err">\</span><span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">25</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="p">.</span><span class="n">local</span>
</pre></div>


<h2 id="_28">备份站点</h2>
<p>将 vps 成功安装好软件后，面临的第二大的事情是如何备份现有的东西？ </p>
<p>你需要备份 3 个方面的内容： 1 站点配置文件 2 站点文件 3 数据库， 分别讲解如下： </p>
<h3 id="_29">备份站点配置文件</h3>
<p>看前面的设置，一般情况，我们需要备份Apache或Nginx，如果你修改了Mysql的配置，则需要备份Mysql的配置。 </p>
<p>注意在使用 tar 备份时，推荐使用 “tar czf 备份文件名 需要备份的路径” 来备份，你也可以使用 “tar czvf ..." 来显示备份详细的进度；但当备份文件很多时，显示中间的备份过程会很花时间和带宽，所以并不建议使用。 </p>
<p>备份完毕后，就可以直接使用 filezilla 到 /root 目录去下载你备份的文件了。 </p>
<h4 id="apache_1">备份Apache配置文件</h4>
<p>执行如下命令备份Apache的配置到 /root 下 ： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">czf</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span>
</pre></div>


<p>备份的文件名叫 apache2.tar.gz ，执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">czf</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span>
<span class="nl">tar:</span> <span class="n">Removing</span> <span class="n">leading</span> <span class="err">`</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">from</span> <span class="n">member</span> <span class="n">names</span>
</pre></div>


<p>检查下备份的文件大小，输入 </p>
<div class="hlcode"><pre> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>结果显示如下，表示备份成功 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">31021</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">18</span><span class="o">:</span><span class="mi">32</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h4 id="nginx_5">备份Nginx配置文件</h4>
<p>执行如下命令备份Nginx的配置到 /root 下 ： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">czf</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span>
</pre></div>


<p>备份的文件名叫 nginx.tar.gz ，执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">czf</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span>
<span class="nl">tar:</span> <span class="n">Removing</span> <span class="n">leading</span> <span class="err">`</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">from</span> <span class="n">member</span> <span class="n">names</span>
</pre></div>


<p>检查下 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">5179</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">18</span><span class="o">:</span><span class="mi">21</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h4 id="mysql_4">备份Mysql配置文件</h4>
<p>执行如下命令备份Mysql的配置到 /root 下 ： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">czf</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span>
</pre></div>


<p>备份的文件名叫 mysql.tar.gz ，执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">czf</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span>
<span class="nl">tar:</span> <span class="n">Removing</span> <span class="n">leading</span> <span class="err">`</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">from</span> <span class="n">member</span> <span class="n">names</span>
</pre></div>


<p>检查下 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">2639</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">18</span><span class="o">:</span><span class="mi">25</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h3 id="_30">备份站点文件</h3>
<p>执行如下命令备份 /var/www 的配置到 /root 下 ： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">czf</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</pre></div>


<p>备份的文件名叫 www.tar.gz ，执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">czf</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="nl">tar:</span> <span class="n">Removing</span> <span class="n">leading</span> <span class="err">`</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">from</span> <span class="n">member</span> <span class="n">names</span>
</pre></div>


<p>检查如下 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">12042534</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">18</span><span class="o">:</span><span class="mi">43</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h3 id="_31">备份数据库</h3>
<p>由于数据库本身包含了帐号和权限信息，所以我们完整备份整个数据库。 </p>
<p>执行以下命令备份数据库到 /root 目录 </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">mysqldump</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span><span class="n">all</span><span class="o">-</span><span class="n">databases</span> <span class="o">|</span><span class="n">gzip</span> <span class="o">&gt;</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>会提示输入密码，输入mysql的密码后回车完成备份，如下所示。 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span><span class="n">all</span><span class="o">-</span><span class="n">databases</span> <span class="o">|</span><span class="n">gzip</span> <span class="o">&gt;</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span>
<span class="n">Enter</span> <span class="n">password</span><span class="o">:</span>
</pre></div>


<p>备份的文件名为 mysql.sql.gz ，检查一下备份的时间和大小 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">133351</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">19</span><span class="o">:</span><span class="mo">01</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h2 id="_32">恢复站点</h2>
<p>当 vps 出现故障后如何恢复？ </p>
<p>首先你需要重新去reload系统到原来的系统，然后再按照前面的指南，安装好和之前一样的运行环境。 </p>
<p>然后将你备份的所有文件使用 filezilla 上传到 vps 的 /root 目录下。 </p>
<p>最后需要恢复 3 个方面的内容： 1 站点配置文件 2 站点文件 3 数据库， 分别讲解如下： </p>
<h3 id="_33">恢复站点配置文件</h3>
<h4 id="apache_2">恢复Apache配置文件</h4>
<p>假设 apache 的备份文件名为 apache2.tar.gz ，使用 putty 登录 vps ，执行如下命令恢复： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">xzf</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">apache2</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span>
</pre></div>


<p>执行结果如下，不会有任何回应： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="n">apache2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">apache2</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span>
</pre></div>


<p>使用如下命令重启 Apache2 : </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<h4 id="nginx_6">恢复Nginx配置文件</h4>
<p>假设 nginx 的备份文件名为 nginx.tar.gz ，使用 putty 登录 vps ，执行如下命令恢复： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">xzf</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">nginx</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span>
</pre></div>


<p>执行结果如下，不会有任何回应： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="n">nginx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">nginx</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span>
</pre></div>


<p>使用如下命令重启 nginx : </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<h4 id="mysql_5">恢复Mysql配置文件</h4>
<p>假设 mysql 的备份文件名为 mysql.tar.gz ，使用 putty 登录 vps ，执行如下命令恢复： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">xzf</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span>
</pre></div>


<p>执行结果如下，不会有任何回应： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="n">mysql</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">etc</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span>
</pre></div>


<h3 id="_34">恢复站点文件</h3>
<p>由于站点占用的空间比较大，所有我们不复制过去，解压缩后直接移动过去。 </p>
<p>假设站点的备份文件名为 www.tar.gz ，使用 putty 登录 vps ，执行如下命令恢复： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">tar</span> <span class="n">xzf</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">fr</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/*</span>
<span class="n">mv</span> <span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/*</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
</pre></div>


<p>执行结果如下，不会有任何回应： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">rm</span> <span class="o">-</span><span class="n">fr</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/*</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">mv</span> <span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/*</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
</pre></div>


<h3 id="_35">恢复数据库</h3>
<p>假设 mysql 的备份文件名为 mysql.sql.gz ，使用 putty 登录 vps ，执行如下命令恢复： </p>
<div class="hlcode"><pre><span class="n">cd</span>
<span class="n">gunzip</span> <span class="o">&lt;</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span> <span class="o">|</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>会提示输入当前新安装的mysql密码，输入密码后回车继续。 </p>
<p>执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">gunzip</span> <span class="o">&lt;</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span> <span class="o">|</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">p</span>
<span class="n">Enter</span> <span class="n">password</span><span class="o">:</span>
</pre></div>


<h2 id="dropbox">使用 Dropbox 每天自动备份</h2>
<h3 id="dropbox_1">注册 Dropbox</h3>
<p>Dropbox 是一个美国的在线网盘，默认提供了2G的空间，同时可以通过邀请其他朋友使用的手段增加容量。 </p>
<p>为什么使用这个，主要是 VPS 到 Dropbox 备份可以到 1M 的真实传输速度，加上可以加容量，所以是非常理想的备份方式。 </p>
<p>点击 <a href="http://db.tt/EnmvJ8Ho" title="http://db.tt/EnmvJ8Ho">注册 Dropbox</a> 并登录到 Dropbox 网页。 </p>
<p>BTW：淘宝上也有人提供扩容到20G的服务，风险自行承担。 </p>
<p>Dropbox 将申请150M内存，实际消耗17M内存，所以请注意控制内存。 </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_dropbox.png&amp;variant=zh-cn" title="Image:Vps dropbox.png"><img alt="Image:Vps dropbox.png" src="http://wiki.ubuntu.org.cn/images/e/eb/Vps_dropbox.png" /></a></p>
<h3 id="dropbox_2">安装 Dropbox 客户端</h3>
<p>打开 putty 执行如下命令安装，如果是32位的系统，采用如下命令。执行完毕后，请不要再执行下面给64位系统执行的命令： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">~</span> <span class="o">&amp;&amp;</span> <span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/download?plat=lnx.x86 | tar xzf -</span>
</pre></div>


<p>64位系统的采用如下命令， </p>
<div class="hlcode"><pre> <span class="n">cd</span> <span class="o">~</span> <span class="o">&amp;&amp;</span> <span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="s">&quot;https://www.dropbox.com/download?plat=lnx.x86_64&quot;</span> <span class="o">|</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="o">-</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span> <span class="o">~</span> <span class="o">&amp;&amp;</span> <span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/download?plat=lnx.x86 | tar xzf -</span>
<span class="o">--</span><span class="mi">2012</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">06</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">40</span><span class="o">--</span>  <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/download?plat=lnx.x86</span>
<span class="n">Resolving</span> <span class="n">www</span><span class="p">.</span><span class="n">dropbox</span><span class="p">.</span><span class="n">com</span><span class="p">...</span> <span class="mf">199.47.217.171</span><span class="p">,</span> <span class="mf">199.47.216.170</span><span class="p">,</span> <span class="mf">199.47.216.171</span><span class="p">,</span> <span class="p">...</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">www</span><span class="p">.</span><span class="n">dropbox</span><span class="p">.</span><span class="n">com</span><span class="o">|</span><span class="mf">199.47.217.171</span><span class="o">|:</span><span class="mf">80.</span><span class="p">..</span> <span class="n">connected</span><span class="p">.</span>
<span class="n">HTTP</span> <span class="n">request</span> <span class="n">sent</span><span class="p">,</span> <span class="n">awaiting</span> <span class="n">response</span><span class="p">...</span> <span class="mi">302</span> <span class="n">FOUND</span>
<span class="nl">Location:</span> <span class="n">https</span><span class="o">:</span><span class="c1">//dl-web.dropbox.com/u/17/dropbox-lnx.x86-1.2.52.tar.gz [following]</span>
<span class="o">--</span><span class="mi">2012</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">06</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">40</span><span class="o">--</span>  <span class="n">https</span><span class="o">:</span><span class="c1">//dl-web.dropbox.com/u/17/dropbox-lnx.x86-1.2.52.tar.gz</span>
<span class="n">Resolving</span> <span class="n">dl</span><span class="o">-</span><span class="n">web</span><span class="p">.</span><span class="n">dropbox</span><span class="p">.</span><span class="n">com</span><span class="p">...</span> <span class="mf">107.20.132.92</span><span class="p">,</span> <span class="mf">107.20.138.135</span><span class="p">,</span> <span class="mf">107.20.170.126</span><span class="p">,</span> <span class="p">...</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">dl</span><span class="o">-</span><span class="n">web</span><span class="p">.</span><span class="n">dropbox</span><span class="p">.</span><span class="n">com</span><span class="o">|</span><span class="mf">107.20.132.92</span><span class="o">|:</span><span class="mf">80.</span><span class="p">..</span> <span class="n">connected</span><span class="p">.</span>
<span class="n">HTTP</span> <span class="n">request</span> <span class="n">sent</span><span class="p">,</span> <span class="n">awaiting</span> <span class="n">response</span><span class="p">...</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="nl">Length:</span> <span class="mi">15794278</span> <span class="p">(</span><span class="mi">15</span><span class="n">M</span><span class="p">)</span> <span class="p">[</span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">tar</span><span class="p">]</span>
<span class="n">Saving</span> <span class="n">to</span><span class="o">:</span> <span class="err">`</span><span class="n">STDOUT</span><span class="err">&#39;</span>

<span class="mi">100</span><span class="o">%</span><span class="p">[</span><span class="o">======================================&gt;</span><span class="p">]</span> <span class="mi">15</span><span class="p">,</span><span class="mi">794</span><span class="p">,</span><span class="mi">278</span>   <span class="mi">893</span><span class="n">K</span><span class="o">/</span><span class="n">s</span>   <span class="n">in</span> <span class="mi">15</span><span class="n">s</span>

<span class="mi">2012</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">06</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">57</span> <span class="p">(</span><span class="mf">1.01</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">written</span> <span class="n">to</span> <span class="n">stdout</span> <span class="p">[</span><span class="mi">15794278</span><span class="o">/</span><span class="mi">15794278</span><span class="p">]</span>
</pre></div>


<p>看到类似信息，表示安装完成。 </p>
<h3 id="_36">设置帐号</h3>
<p>执行如下命令开始设置帐号 </p>
<div class="hlcode"><pre><span class="o">~/</span><span class="p">.</span><span class="n">dropbox</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="n">dropboxd</span>
</pre></div>


<p>当看到 </p>
<div class="hlcode"><pre><span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/cli_link?host_id=xxx&amp;cl=en_US to link this machine.</span>
</pre></div>


<p>的提示时，复制里面https的链接地址使用浏览器打开，会出现Dropbox的密码框，输入你刚刚注册的密码，等到 putty 里面出现 </p>
<div class="hlcode"><pre><span class="n">Client</span> <span class="n">successfully</span> <span class="n">linked</span><span class="p">,</span> <span class="n">Welcome</span> <span class="n">xxx</span><span class="o">!</span>
</pre></div>


<p>的提示即可完成设置。完成后，使用 Ctrl+C 键中断运行。 </p>
<p>完整如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">~/</span><span class="p">.</span><span class="n">dropbox</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="n">dropboxd</span> 
<span class="n">This</span> <span class="n">client</span> <span class="n">is</span> <span class="n">not</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">any</span> <span class="n">account</span><span class="p">...</span>
<span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/cli_link?host_id=db0a5acabdf1fba62f360ffb8ebe910e&amp;cl=en_US to link this machine.</span>
<span class="n">This</span> <span class="n">client</span> <span class="n">is</span> <span class="n">not</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">any</span> <span class="n">account</span><span class="p">...</span>
<span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/cli_link?host_id=db0a5acabdf1fba62f360ffb8ebe910e&amp;cl=en_US to link this machine.</span>
<span class="n">This</span> <span class="n">client</span> <span class="n">is</span> <span class="n">not</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">any</span> <span class="n">account</span><span class="p">...</span>
<span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/cli_link?host_id=db0a5acabdf1fba62f360ffb8ebe910e&amp;cl=en_US to link this machine.</span>
<span class="n">This</span> <span class="n">client</span> <span class="n">is</span> <span class="n">not</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">any</span> <span class="n">account</span><span class="p">...</span>
<span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dropbox.com/cli_link?host_id=db0a5acabdf1fba62f360ffb8ebe910e&amp;cl=en_US to link this machine.</span>
<span class="n">Client</span> <span class="n">successfully</span> <span class="n">linked</span><span class="p">,</span> <span class="n">Welcome</span> <span class="n">guest</span><span class="o">!</span>
</pre></div>


<h3 id="_37">开始使用</h3>
<p>完成以上设置后，会在当然的目录下出现 Dropbox 目录，这个目录就是同步目录，当在这个目录下放置的任何文件都会同步到 Dropbox 网盘上。 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">ls</span>
<span class="n">Dropbox</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">cd</span> <span class="n">Dropbox</span><span class="o">/</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="n">ls</span>
<span class="n">Getting</span> <span class="n">Started</span><span class="p">.</span><span class="n">pdf</span>  <span class="n">Photos</span>  <span class="n">Public</span>
</pre></div>


<p>第一次测试： 在Dropbox目录下创建一个内容为 Hello 的 a.txt 文件。 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="n">echo</span> <span class="s">&quot;Hello&quot;</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>运行同步程序 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="o">~/</span><span class="p">.</span><span class="n">dropbox</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="n">dropboxd</span>
</pre></div>


<p>打开Dropbox网页的 Files ，就会看到你的文件了。 输入 Ctrl+C 中断同步，下面开始讲如何配置自动运行同步。 </p>
<h3 id="dropbox_3">自动运行 Dropbox</h3>
<p>512M内存的VPS请不要自动启动服务，需要时，手工运行即可，启动后会太占内存。 </p>
<p>直接复制下面的命令到Putty并执行，以下为创建 dropbox 的自动启动文件，命令内容如下： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
<span class="cp">#!/bin/bash</span>
<span class="cp"># dropbox service</span>
<span class="n">DAEMON</span><span class="o">=</span><span class="p">.</span><span class="n">dropbox</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="n">dropboxd</span>

<span class="n">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="s">&quot;Starting dropbox...&quot;</span>
    <span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="err">$</span><span class="n">DAEMON</span> <span class="p">];</span> <span class="n">then</span>
       <span class="n">HOME</span><span class="o">=</span><span class="s">&quot;/root&quot;</span> <span class="n">start</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="n">daemon</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span><span class="n">c</span> <span class="n">root</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="err">$</span><span class="n">DAEMON</span>
    <span class="n">fi</span>
<span class="p">}</span>

<span class="n">stop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="s">&quot;Stopping dropbox...&quot;</span>
    <span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="err">$</span><span class="n">DAEMON</span> <span class="p">];</span> <span class="n">then</span>
        <span class="n">start</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="n">daemon</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span><span class="n">c</span> <span class="n">root</span> <span class="o">-</span><span class="n">K</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="err">$</span><span class="n">DAEMON</span>
    <span class="n">fi</span>
<span class="p">}</span>

<span class="n">status</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">dbpid</span><span class="o">=</span><span class="err">`</span><span class="n">pgrep</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="n">dropboxd</span><span class="err">`</span>
    <span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">z</span> <span class="err">$</span><span class="n">dbpid</span> <span class="p">];</span> <span class="n">then</span>
        <span class="n">echo</span> <span class="s">&quot;dropboxd not running.&quot;</span>
    <span class="k">else</span>
        <span class="n">echo</span> <span class="s">&quot;dropboxd running (pid $dbpid)&quot;</span>
    <span class="n">fi</span>
<span class="p">}</span>


<span class="k">case</span> <span class="s">&quot;$1&quot;</span> <span class="n">in</span>
  <span class="n">start</span><span class="p">)</span>
    <span class="n">start</span>
    <span class="p">;;</span>

  <span class="n">stop</span><span class="p">)</span>
    <span class="n">stop</span>
    <span class="p">;;</span>

  <span class="n">restart</span><span class="o">|</span><span class="n">reload</span><span class="o">|</span><span class="n">force</span><span class="o">-</span><span class="n">reload</span><span class="p">)</span>
    <span class="n">stop</span>
    <span class="n">start</span>
    <span class="p">;;</span>

  <span class="n">status</span><span class="p">)</span>
    <span class="n">status</span>
    <span class="p">;;</span>

  <span class="o">*</span><span class="p">)</span>
    <span class="n">echo</span> <span class="s">&quot;Usage: /etc/init.d/dropbox {start|stop|reload|force-reload|restart|status}&quot;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="n">esac</span>

<span class="n">exit</span> <span class="mi">0</span>
<span class="n">EOF</span>
</pre></div>


<p>然后继续执行如下命令，设置自动启动 dropbox 同步服务： </p>
<div class="hlcode"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span> <span class="n">dropbox</span> <span class="n">defaults</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span> <span class="n">start</span>
</pre></div>


<p>执行命令的结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/</span><span class="se">\r</span><span class="s">//&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span> 
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span> <span class="n">dropbox</span> <span class="n">defaults</span>
<span class="nl">perl:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">locale</span> <span class="n">failed</span><span class="p">.</span>
<span class="nl">perl:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Please</span> <span class="n">check</span> <span class="n">that</span> <span class="n">your</span> <span class="n">locale</span> <span class="n">settings</span><span class="o">:</span>
        <span class="n">LANGUAGE</span> <span class="o">=</span> <span class="p">(</span><span class="n">unset</span><span class="p">),</span>
        <span class="n">LC_ALL</span> <span class="o">=</span> <span class="p">(</span><span class="n">unset</span><span class="p">),</span>
        <span class="n">LANG</span> <span class="o">=</span> <span class="s">&quot;zh_CN.UTF-8&quot;</span>
    <span class="n">are</span> <span class="n">supported</span> <span class="n">and</span> <span class="n">installed</span> <span class="n">on</span> <span class="n">your</span> <span class="n">system</span><span class="p">.</span>
<span class="nl">perl:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">locale</span> <span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">).</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span> <span class="n">missing</span> <span class="n">LSB</span> <span class="n">information</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="o">:</span> <span class="n">see</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//wiki.debian.org/LSBInitScripts&gt;</span>
 <span class="n">Adding</span> <span class="n">system</span> <span class="n">startup</span> <span class="k">for</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span> <span class="p">...</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc0</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">K20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc1</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">K20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc6</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">K20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc2</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">S20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc3</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">S20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc4</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">S20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc5</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">S20dropbox</span> <span class="o">-&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~/</span><span class="n">Dropbox</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">dropbox</span> <span class="n">start</span>
<span class="n">Starting</span> <span class="n">dropbox</span><span class="p">...</span>
</pre></div>


<p>现在你的VPS已经可以自动同步 /root/Dropbox 目录下的所有文件了。 </p>
<h3 id="_38">自动每天备份数据库和站点</h3>
<p>输入如下命令，创建自动备份脚本，注意脚本中的“数据库密码”需要换成你自己的Mysql数据库密码： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">tar</span> <span class="n">czf</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Dropbox</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">&#39;</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">mysqldump</span> <span class="o">-</span><span class="n">p</span><span class="err">数据库密码</span> <span class="o">--</span><span class="n">all</span><span class="o">-</span><span class="n">databases</span> <span class="o">|</span><span class="n">gzip</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Dropbox</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span><span class="err">&#39;</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">tar</span> <span class="n">czf</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Dropbox</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">&#39;</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">mysqldump</span> <span class="o">-</span><span class="n">p123456</span> <span class="o">--</span><span class="n">all</span><span class="o">-</span><span class="n">databases</span> <span class="o">|</span><span class="n">gzip</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Dropbox</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">gz</span><span class="err">&#39;</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">daily</span><span class="o">/</span><span class="n">dropboxbackup</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span> <span class="n">restart</span> 
<span class="n">Rather</span> <span class="n">than</span> <span class="n">invoking</span> <span class="n">init</span> <span class="n">scripts</span> <span class="n">through</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">use</span> <span class="n">the</span> <span class="n">service</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">utility</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">service</span> <span class="n">cron</span> <span class="n">restart</span>

<span class="n">Since</span> <span class="n">the</span> <span class="n">script</span> <span class="n">you</span> <span class="n">are</span> <span class="n">attempting</span> <span class="n">to</span> <span class="n">invoke</span> <span class="n">has</span> <span class="n">been</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">an</span>
<span class="n">Upstart</span> <span class="n">job</span><span class="p">,</span> <span class="n">you</span> <span class="n">may</span> <span class="n">also</span> <span class="n">use</span> <span class="n">the</span> <span class="n">restart</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="n">utility</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">restart</span> <span class="n">cron</span>
<span class="n">cron</span> <span class="n">start</span><span class="o">/</span><span class="n">running</span><span class="p">,</span> <span class="n">process</span> <span class="mi">3094</span>
</pre></div>


<p>看到上面的提示，表示自动备份设置完成，然后你可以手工执行下 /etc/cron.daily/dropboxbackup 看看效果。 </p>
<h2 id="bittorrent-sync">使用 BitTorrent Sync 备份系统</h2>
<h3 id="_39">说明</h3>
<p>这个是 BitTorrent 公司写的一个非开源备份系统，具体请自行 Google，这里直接讲如何安装和使用。 </p>
<p>使用这个好处有两点，第一：占用内存非常少，不到20M；第二：不限空间，可以直接备份到你的本地电脑。 </p>
<h3 id="_40">安装</h3>
<p>在 Putty 里面，依次执行如下命令安装，安装过程中在提示输入[Y]或[ENTER]的地方，直接回车即可： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">software</span><span class="o">-</span><span class="n">properties</span>
<span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="o">:</span><span class="n">tuxpoldo</span><span class="o">/</span><span class="n">btsync</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">btsync</span>
</pre></div>


<p>当出现 “The password for accessing the web interface:” 提示输入密码时，输入你的管理密码；其余默认，直接回车即可。 </p>
<p>安装完毕后，btsync 的配置文件在 /etc/btsync/debconf-default.conf ，你可以去修改这个文件，配置新的密码。 </p>
<p>修改密码后，需要重启 btsync 服务： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">btsync</span> <span class="n">restart</span>
</pre></div>


<h3 id="_41">使用</h3>
<p>打开浏览器访问 <a href="http://VPSIP:8888" title="http://VPSIP:8888">http://VPSIP:8888</a> ，在本例中如下： <a href="http://184.82.9.30:8888" title="http://184.82.9.30:8888">http://184.82.9.30:8888</a></p>
<p>登录默认账号： admin ，密码是你前面输入的。 </p>
<p>好了，然后 点击 Add Folder 按钮选择需要备份的目录（推荐备份 /var 目录），并产生一个随机安全 Secret 号。 </p>
<h3 id="_42">客户端安装</h3>
<p>访问 <a href="http://labs.bittorrent.com/experiments/sync.html" title="http://labs.bittorrent.com/experiments/sync.html">http://labs.bittorrent.com/experiments/sync.html</a> ，点击红色的 Download 按钮，再点击 Windows 按钮，下载并安装 </p>
<p>打开程序，输入前面得到的随机安全 Secret 号，选择一个下载的目录，你会看到，备份开始了。 </p>
<p>大功告成。 </p>
<h2 id="zend-guard-loader">安装 Zend Guard Loader</h2>
<p>一般情况我们推荐直接安装 Zend Guard Loader 来代替 Zend Optimizer，因为 Zend Optimizer 已经过时，并且不被支持。 </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">~</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//phpcj.googlecode.com/files/ZendGuardLoader.so</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zend</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">ZendGuardLoader</span><span class="p">.</span><span class="n">so</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zend</span><span class="o">/</span><span class="n">ZendGuardLoader</span><span class="p">.</span><span class="n">so</span>
<span class="n">echo</span> <span class="s">&quot;zend_extension=/usr/local/zend/ZendGuardLoader.so&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">zend</span><span class="p">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="s">&quot;zend_loader.enable=1&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">zend</span><span class="p">.</span><span class="n">ini</span>
</pre></div>


<p>然后重启下php即可。 </p>
<h2 id="zend-optimizer">关于Zend Optimizer</h2>
<p>如果已经安装了上面的 Zend Guard Loader，请忽略执行本段。 </p>
<p>关于Zend，我们推荐安装上面的 Zend Guard Loader ，Zend Optimizer 已经被官方放弃，如果一定需要，请看本段。 </p>
<p>由于Zend Optimizer 不支持 php 5.3.x ，如果必须要使用，则需要降级： </p>
<p>注意不要去尝试安装 ZendServer-CE 的 optimizerplus 或 Zend Guard Loader，因为，php 5.3.x 上的解密都不支持 php5.2.x 上的加密，除非你手头上的加密程序可以重新针对 php 5.3.x 重新加密，所以必须降级 php 的版本为 5.2.x 。 </p>
<p>并且仅仅支持 Apache , 不支持 Nginx （问题是降级后不再支持 php5-fpm，当然有能力者，可以采用 spawn-fcgi 来代替）。 </p>
<p>如果是Nginx用户，请还原到 Apache 环境，并且参考上面步骤事先安装好Apache和php，并测试php正常运行。 </p>
<h3 id="php_4">php 降级</h3>
<p>依次逐行输入如下命令： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">aptitude</span> <span class="n">lsb</span><span class="o">-</span><span class="n">release</span>
<span class="n">php_installed</span><span class="o">=</span><span class="err">`</span><span class="n">dpkg</span> <span class="o">-</span><span class="n">l</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">php</span><span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span><span class="n">tr</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="s">&quot; &quot;</span><span class="err">`</span>
<span class="n">aptitude</span> <span class="n">purge</span> <span class="err">$</span><span class="n">php_installed</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;Package: php5</span><span class="se">\n</span><span class="s">Pin: release a=karmic</span><span class="se">\n</span><span class="s">Pin-Priority: 991</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">preferences</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php</span> 
<span class="n">apt</span><span class="o">-</span><span class="n">cache</span> <span class="n">search</span> <span class="n">php5</span><span class="o">-|</span><span class="n">grep</span> <span class="n">php5</span><span class="o">-|</span><span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="s">&quot;Package:&quot;</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Pin: release a=karmic</span><span class="se">\n</span><span class="s">Pin-Priority: 991</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">}</span><span class="err">&#39;</span>  <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">preferences</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php</span> 
<span class="n">apt</span><span class="o">-</span><span class="n">cache</span> <span class="n">search</span> <span class="o">-</span><span class="n">n</span> <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span> <span class="o">|</span><span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="s">&quot;Package:&quot;</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Pin: release a=karmic</span><span class="se">\n</span><span class="s">Pin-Priority: 991</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">preferences</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php</span> 
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;Package: php-pear</span><span class="se">\n</span><span class="s">Pin: release a=karmic</span><span class="se">\n</span><span class="s">Pin-Priority: 991</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">preferences</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php</span> 
<span class="n">egrep</span> <span class="err">&#39;</span><span class="p">(</span><span class="n">main</span> <span class="k">restricted</span><span class="o">|</span><span class="n">universe</span><span class="o">|</span><span class="n">multiverse</span><span class="p">)</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;#&quot;</span><span class="o">|</span> <span class="n">sed</span> <span class="n">s</span><span class="o">/</span><span class="err">`</span><span class="n">lsb_release</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">c</span><span class="err">`</span><span class="o">/</span><span class="n">karmic</span><span class="o">/</span><span class="n">g</span> <span class="o">|</span> <span class="n">sed</span> <span class="n">s</span><span class="o">/</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="err">\</span><span class="o">/</span><span class="sc">&#39;/&#39;</span><span class="n">http</span><span class="o">:</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="n">old</span><span class="o">-</span><span class="n">releases</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="o">/</span><span class="err">&#39;</span><span class="o">/</span><span class="n">g</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">karmic</span><span class="p">.</span><span class="n">list</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="err">$</span><span class="n">php_installed</span>
<span class="n">aptitude</span> <span class="n">hold</span> <span class="err">`</span><span class="n">dpkg</span> <span class="o">-</span><span class="n">l</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">php5</span><span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span><span class="n">tr</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="s">&quot; &quot;</span><span class="err">`</span>
</pre></div>


<p>如果碰到如下： </p>
<div class="hlcode"><pre><span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span><span class="o">?</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="o">/?</span><span class="p">]</span>
</pre></div>


<p>请出入 y 回车继续 </p>
<h3 id="php_5">php 高级安装技巧</h3>
<p>如果需要支持nginx或采用fastcgi来运行php，在执行完毕上面的步骤后，参考如下命令安装（注意，Apache环境不需要执行）： </p>
<p>采用fastcgi，即用于spawn-fcgi: </p>
<div class="hlcode"><pre><span class="n">aptitude</span> <span class="n">install</span> <span class="o">-</span><span class="n">t</span> <span class="n">karmic</span> <span class="n">php5</span><span class="o">-</span><span class="n">cli</span> <span class="n">php5</span><span class="o">-</span><span class="n">cgi</span>
</pre></div>


<p>返回到Apache: </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">t</span> <span class="n">karmic</span>  <span class="n">libapache2</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">php5</span>
</pre></div>


<h3 id="zend-optimizer_1">安装 Zend Optimizer</h3>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">~</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//downloads.zend.com/optimizer/3.3.3/ZendOptimizer-3.3.3-linux-glibc23-i386.tar.gz</span>
<span class="n">tar</span> <span class="n">zxvf</span> <span class="n">ZendOptimizer</span><span class="o">-</span><span class="mf">3.3.3</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc23</span><span class="o">-</span><span class="n">i386</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zend</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">ZendOptimizer</span><span class="o">-</span><span class="mf">3.3.3</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc23</span><span class="o">-</span><span class="n">i386</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">5</span><span class="n">_2_x_comp</span><span class="o">/</span><span class="n">ZendOptimizer</span><span class="p">.</span><span class="n">so</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zend</span><span class="o">/</span>
<span class="n">echo</span> <span class="s">&quot;zend_extension=/usr/local/zend/ZendOptimizer.so&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">zend</span><span class="p">.</span><span class="n">ini</span>
</pre></div>


<h3 id="_43">安装成功验证</h3>
<p>运行： </p>
<div class="hlcode"><pre><span class="n">php</span> <span class="o">-</span><span class="n">v</span>
</pre></div>


<p>返回如下提示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">php</span> <span class="o">-</span><span class="n">v</span>
<span class="n">PHP</span> <span class="mf">5.2.10</span><span class="o">-</span><span class="mi">2u</span><span class="n">buntu6</span> <span class="n">with</span> <span class="n">Suhosin</span><span class="o">-</span><span class="n">Patch</span> <span class="mf">0.9.7</span> <span class="p">(</span><span class="n">cli</span><span class="p">)</span> <span class="p">(</span><span class="n">built</span><span class="o">:</span> <span class="n">Oct</span> <span class="mi">23</span> <span class="mi">2009</span> <span class="mi">16</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>

<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">1997</span><span class="o">-</span><span class="mi">2009</span> <span class="n">The</span> <span class="n">PHP</span> <span class="n">Group</span>
<span class="n">Zend</span> <span class="n">Engine</span> <span class="n">v2</span><span class="mf">.2.0</span><span class="p">,</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">1998</span><span class="o">-</span><span class="mi">2009</span> <span class="n">Zend</span> <span class="n">Technologies</span>
    <span class="n">with</span> <span class="n">Zend</span> <span class="n">Optimizer</span> <span class="n">v3</span><span class="mf">.3.3</span><span class="p">,</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">1998</span><span class="o">-</span><span class="mi">2007</span><span class="p">,</span> <span class="n">by</span> <span class="n">Zend</span> <span class="n">Technologies</span>
</pre></div>


<p>显示成功安装 Zend Optimizer。 </p>
<h3 id="web">重启 Web 服务</h3>
<p>如果是 apache : </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>如果是Nginx: </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
</pre></div>


<h2 id="vpn">VPN 和代理</h2>
<h3 id="openvpn">安装 OpenVPN</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=OpenVPN&amp;variant=zh-cn" title="OpenVPN">OpenVPN</a> 支持所有类型的VPS，需要系统支持 Tun/Tap 设备。 </p>
<h4 id="tuntap">开启 Tun/Tap 支持</h4>
<p>XEN VPS 无需开启 Tun/Tap，直接支持，跳过这一步。 </p>
<p>在 putty 里面运行如下命令，检查是否开启了tun设备： </p>
<div class="hlcode"><pre><span class="n">ls</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">net</span><span class="o">/</span>
</pre></div>


<p>如果出现如下提示，表示已经开启，否则需要开启 tun 支持。 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">net</span><span class="o">/</span>    
<span class="n">tun</span>
</pre></div>


<p>如果没有发现上面的提示，则需要按下面的办法处理。 </p>
<p>请先登录 <a href="http://http://vps.ubuntu.org.cn/vm" title="http://http://vps.ubuntu.org.cn/vm">管理面板</a>，打开 VPS 后，点击【设置】，然后再点击【激活TUN/TAP】 </p>
<p>然后重复上述测试，如果仍然无法找到 tun 设备，尝试手工创建，命令如下： </p>
<div class="hlcode"><pre><span class="n">mkdir</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">net</span> 
<span class="n">mknod</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">tun</span> <span class="n">c</span> <span class="mi">10</span> <span class="mi">200</span>
</pre></div>


<h4 id="openvpn_1">安装 openvpn</h4>
<p>在 putty 里面运行如下命令安装 openvpn，再提示输入 (Y/n) 时，输入 Y 回车继续: </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openvpn</span>
</pre></div>


<p>执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openvpn</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>       
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">extra</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">liblzo2</span><span class="o">-</span><span class="mi">2</span> <span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1</span> <span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist</span>
<span class="n">Suggested</span> <span class="n">packages</span><span class="o">:</span>
  <span class="n">resolvconf</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">liblzo2</span><span class="o">-</span><span class="mi">2</span> <span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1</span> <span class="n">openvpn</span> <span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">4</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">53</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">1601</span><span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">3760</span><span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span> 
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main liblzo2-2 i386 2.03-2 [63.4kB]</span>
<span class="nl">Get:</span><span class="mi">2</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main libpkcs11-helper1 i386 1.07-1build1 [43.8kB]</span>
<span class="nl">Get:</span><span class="mi">3</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main openvpn-blacklist all 0.4 [1068kB]</span>
<span class="nl">Get:</span><span class="mi">4</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ maverick/main openvpn i386 2.1.0-3ubuntu1 [425kB]</span>
<span class="n">Fetched</span> <span class="mi">1601</span><span class="n">kB</span> <span class="n">in</span> <span class="mi">2</span><span class="n">s</span> <span class="p">(</span><span class="mi">638</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>            
<span class="n">Preconfiguring</span> <span class="n">packages</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">liblzo2</span><span class="o">-</span><span class="mf">2.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">27146</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">liblzo2</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">liblzo2</span><span class="o">-</span><span class="mi">2</span><span class="n">_2</span><span class="mf">.03</span><span class="o">-</span><span class="mi">2</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1_1</span><span class="mf">.07</span><span class="o">-</span><span class="mi">1</span><span class="n">build1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist_0</span><span class="mf">.4</span><span class="n">_all</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">openvpn</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">openvpn</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">openvpn_2</span><span class="mf">.1.0</span><span class="o">-</span><span class="mi">3u</span><span class="n">buntu1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">liblzo2</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="mf">2.03</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">libpkcs11</span><span class="o">-</span><span class="n">helper1</span> <span class="p">(</span><span class="mf">1.07</span><span class="o">-</span><span class="mi">1</span><span class="n">build1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">openvpn</span><span class="o">-</span><span class="n">blacklist</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">openvpn</span> <span class="p">(</span><span class="mf">2.1.0</span><span class="o">-</span><span class="mi">3u</span><span class="n">buntu1</span><span class="p">)</span> <span class="p">...</span>
 <span class="o">*</span> <span class="n">Restarting</span> <span class="n">virtual</span> <span class="n">private</span> <span class="n">network</span> <span class="n">daemon</span><span class="p">(</span><span class="n">s</span><span class="p">)...</span>                               <span class="o">*</span>   <span class="n">No</span> <span class="n">VPN</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>
<span class="n">Processing</span> <span class="n">triggers</span> <span class="k">for</span> <span class="n">libc</span><span class="o">-</span><span class="n">bin</span> <span class="p">...</span>
<span class="n">ldconfig</span> <span class="n">deferred</span> <span class="n">processing</span> <span class="n">now</span> <span class="n">taking</span> <span class="n">place</span>
</pre></div>


<h4 id="openvpn_2">配置 openvpn</h4>
<p>在 Putty 执行依次逐行如下命令，遇到(y/n)的提示输入 y 回车，否则直接回车继续： </p>
<div class="hlcode"><pre><span class="n">gunzip</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">sample</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">gz</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">openssl</span><span class="o">-</span><span class="mf">1.0.0</span><span class="p">.</span><span class="n">cnf</span> <span class="n">openssl</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">source</span> <span class="n">vars</span>
<span class="p">.</span><span class="o">/</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span>
<span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">ca</span>
<span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">server</span> <span class="n">server</span>
<span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span> <span class="n">client</span>
<span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">dh</span>
</pre></div>


<p>执行上面的命令过程如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">gunzip</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">sample</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">gz</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="n">source</span> <span class="n">vars</span>
<span class="nl">NOTE:</span> <span class="n">If</span> <span class="n">you</span> <span class="n">run</span> <span class="p">.</span><span class="o">/</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span><span class="p">,</span> <span class="n">I</span> <span class="n">will</span> <span class="n">be</span> <span class="n">doing</span> <span class="n">a</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">on</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">ca</span>
<span class="n">Generating</span> <span class="n">a</span> <span class="mi">1024</span> <span class="n">bit</span> <span class="n">RSA</span> <span class="n">private</span> <span class="n">key</span>
<span class="p">.</span><span class="o">++++++</span>
<span class="p">........</span><span class="o">++++++</span>
<span class="n">writing</span> <span class="n">new</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">ca</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">be</span> <span class="n">asked</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">information</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">incorporated</span>
<span class="n">into</span> <span class="n">your</span> <span class="n">certificate</span> <span class="n">request</span><span class="p">.</span>
<span class="n">What</span> <span class="n">you</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">is</span> <span class="n">what</span> <span class="n">is</span> <span class="n">called</span> <span class="n">a</span> <span class="n">Distinguished</span> <span class="n">Name</span> <span class="n">or</span> <span class="n">a</span> <span class="n">DN</span><span class="p">.</span>
<span class="n">There</span> <span class="n">are</span> <span class="n">quite</span> <span class="n">a</span> <span class="n">few</span> <span class="n">fields</span> <span class="n">but</span> <span class="n">you</span> <span class="n">can</span> <span class="n">leave</span> <span class="n">some</span> <span class="n">blank</span>
<span class="n">For</span> <span class="n">some</span> <span class="n">fields</span> <span class="n">there</span> <span class="n">will</span> <span class="n">be</span> <span class="n">a</span> <span class="k">default</span> <span class="n">value</span><span class="p">,</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">enter</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">the</span> <span class="n">field</span> <span class="n">will</span> <span class="n">be</span> <span class="n">left</span> <span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span> <span class="n">Name</span> <span class="p">(</span><span class="mi">2</span> <span class="n">letter</span> <span class="n">code</span><span class="p">)</span> <span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span> <span class="n">or</span> <span class="n">Province</span> <span class="n">Name</span> <span class="p">(</span><span class="n">full</span> <span class="n">name</span><span class="p">)</span> <span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span> <span class="p">[</span><span class="n">SanFrancisco</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">company</span><span class="p">)</span> <span class="p">[</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span> <span class="n">Unit</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Common</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">your</span> <span class="n">name</span> <span class="n">or</span> <span class="n">your</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">hostname</span><span class="p">)</span> <span class="p">[</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span> <span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Name</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Email</span> <span class="n">Address</span> <span class="p">[</span><span class="n">me</span><span class="err">@</span><span class="n">myhost</span><span class="p">.</span><span class="n">mydomain</span><span class="p">]</span><span class="o">:</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">server</span> <span class="n">server</span>
<span class="n">Generating</span> <span class="n">a</span> <span class="mi">1024</span> <span class="n">bit</span> <span class="n">RSA</span> <span class="n">private</span> <span class="n">key</span>
<span class="p">......</span><span class="o">++++++</span>
<span class="p">............</span><span class="o">++++++</span>
<span class="n">writing</span> <span class="n">new</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">server</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">be</span> <span class="n">asked</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">information</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">incorporated</span>
<span class="n">into</span> <span class="n">your</span> <span class="n">certificate</span> <span class="n">request</span><span class="p">.</span>
<span class="n">What</span> <span class="n">you</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">is</span> <span class="n">what</span> <span class="n">is</span> <span class="n">called</span> <span class="n">a</span> <span class="n">Distinguished</span> <span class="n">Name</span> <span class="n">or</span> <span class="n">a</span> <span class="n">DN</span><span class="p">.</span>
<span class="n">There</span> <span class="n">are</span> <span class="n">quite</span> <span class="n">a</span> <span class="n">few</span> <span class="n">fields</span> <span class="n">but</span> <span class="n">you</span> <span class="n">can</span> <span class="n">leave</span> <span class="n">some</span> <span class="n">blank</span>
<span class="n">For</span> <span class="n">some</span> <span class="n">fields</span> <span class="n">there</span> <span class="n">will</span> <span class="n">be</span> <span class="n">a</span> <span class="k">default</span> <span class="n">value</span><span class="p">,</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">enter</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">the</span> <span class="n">field</span> <span class="n">will</span> <span class="n">be</span> <span class="n">left</span> <span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span> <span class="n">Name</span> <span class="p">(</span><span class="mi">2</span> <span class="n">letter</span> <span class="n">code</span><span class="p">)</span> <span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span> <span class="n">or</span> <span class="n">Province</span> <span class="n">Name</span> <span class="p">(</span><span class="n">full</span> <span class="n">name</span><span class="p">)</span> <span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span> <span class="p">[</span><span class="n">SanFrancisco</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">company</span><span class="p">)</span> <span class="p">[</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span> <span class="n">Unit</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Common</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">your</span> <span class="n">name</span> <span class="n">or</span> <span class="n">your</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">hostname</span><span class="p">)</span> <span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">:</span>
<span class="n">Name</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Email</span> <span class="n">Address</span> <span class="p">[</span><span class="n">me</span><span class="err">@</span><span class="n">myhost</span><span class="p">.</span><span class="n">mydomain</span><span class="p">]</span><span class="o">:</span>

<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">following</span> <span class="err">&#39;</span><span class="n">extra</span><span class="err">&#39;</span> <span class="n">attributes</span>
<span class="n">to</span> <span class="n">be</span> <span class="n">sent</span> <span class="n">with</span> <span class="n">your</span> <span class="n">certificate</span> <span class="n">request</span>
<span class="n">A</span> <span class="n">challenge</span> <span class="n">password</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">An</span> <span class="n">optional</span> <span class="n">company</span> <span class="n">name</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Using</span> <span class="n">configuration</span> <span class="n">from</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">openssl</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">Check</span> <span class="n">that</span> <span class="n">the</span> <span class="n">request</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">signature</span>
<span class="n">Signature</span> <span class="n">ok</span>
<span class="n">The</span> <span class="n">Subject</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Distinguished</span> <span class="n">Name</span> <span class="n">is</span> <span class="n">as</span> <span class="n">follows</span>
<span class="n">countryName</span>           <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">US</span><span class="err">&#39;</span>
<span class="n">stateOrProvinceName</span>   <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">CA</span><span class="err">&#39;</span>
<span class="n">localityName</span>          <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">SanFrancisco</span><span class="err">&#39;</span>
<span class="n">organizationName</span>      <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span><span class="err">&#39;</span>
<span class="n">commonName</span>            <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">server</span><span class="err">&#39;</span>
<span class="n">emailAddress</span>          <span class="o">:</span><span class="n">IA5STRING</span><span class="o">:</span><span class="err">&#39;</span><span class="n">me</span><span class="err">@</span><span class="n">myhost</span><span class="p">.</span><span class="n">mydomain</span><span class="err">&#39;</span>
<span class="n">Certificate</span> <span class="n">is</span> <span class="n">to</span> <span class="n">be</span> <span class="n">certified</span> <span class="n">until</span> <span class="n">Jul</span> <span class="mi">28</span> <span class="mi">09</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mi">30</span> <span class="mi">2022</span> <span class="n">GMT</span> <span class="p">(</span><span class="mi">3650</span> <span class="n">days</span><span class="p">)</span>
<span class="n">Sign</span> <span class="n">the</span> <span class="n">certificate</span><span class="o">?</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">:</span><span class="n">y</span>


<span class="mi">1</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">1</span> <span class="n">certificate</span> <span class="n">requests</span> <span class="n">certified</span><span class="p">,</span> <span class="n">commit</span><span class="o">?</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="n">y</span>
<span class="n">Write</span> <span class="n">out</span> <span class="n">database</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">new</span> <span class="n">entries</span>
<span class="n">Data</span> <span class="n">Base</span> <span class="n">Updated</span>

<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span> <span class="n">client</span>
<span class="n">Generating</span> <span class="n">a</span> <span class="mi">1024</span> <span class="n">bit</span> <span class="n">RSA</span> <span class="n">private</span> <span class="n">key</span>
<span class="p">..............</span><span class="o">++++++</span>
<span class="p">.......................</span><span class="o">++++++</span>
<span class="n">writing</span> <span class="n">new</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">client</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">be</span> <span class="n">asked</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">information</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">incorporated</span>
<span class="n">into</span> <span class="n">your</span> <span class="n">certificate</span> <span class="n">request</span><span class="p">.</span>
<span class="n">What</span> <span class="n">you</span> <span class="n">are</span> <span class="n">about</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">is</span> <span class="n">what</span> <span class="n">is</span> <span class="n">called</span> <span class="n">a</span> <span class="n">Distinguished</span> <span class="n">Name</span> <span class="n">or</span> <span class="n">a</span> <span class="n">DN</span><span class="p">.</span>
<span class="n">There</span> <span class="n">are</span> <span class="n">quite</span> <span class="n">a</span> <span class="n">few</span> <span class="n">fields</span> <span class="n">but</span> <span class="n">you</span> <span class="n">can</span> <span class="n">leave</span> <span class="n">some</span> <span class="n">blank</span>
<span class="n">For</span> <span class="n">some</span> <span class="n">fields</span> <span class="n">there</span> <span class="n">will</span> <span class="n">be</span> <span class="n">a</span> <span class="k">default</span> <span class="n">value</span><span class="p">,</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">enter</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">the</span> <span class="n">field</span> <span class="n">will</span> <span class="n">be</span> <span class="n">left</span> <span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span> <span class="n">Name</span> <span class="p">(</span><span class="mi">2</span> <span class="n">letter</span> <span class="n">code</span><span class="p">)</span> <span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span> <span class="n">or</span> <span class="n">Province</span> <span class="n">Name</span> <span class="p">(</span><span class="n">full</span> <span class="n">name</span><span class="p">)</span> <span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span> <span class="p">[</span><span class="n">SanFrancisco</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">company</span><span class="p">)</span> <span class="p">[</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span> <span class="n">Unit</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Common</span> <span class="n">Name</span> <span class="p">(</span><span class="n">eg</span><span class="p">,</span> <span class="n">your</span> <span class="n">name</span> <span class="n">or</span> <span class="n">your</span> <span class="n">server</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">hostname</span><span class="p">)</span> <span class="p">[</span><span class="n">client</span><span class="p">]</span><span class="o">:</span>
<span class="n">Name</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Email</span> <span class="n">Address</span> <span class="p">[</span><span class="n">me</span><span class="err">@</span><span class="n">myhost</span><span class="p">.</span><span class="n">mydomain</span><span class="p">]</span><span class="o">:</span>

<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">following</span> <span class="err">&#39;</span><span class="n">extra</span><span class="err">&#39;</span> <span class="n">attributes</span>
<span class="n">to</span> <span class="n">be</span> <span class="n">sent</span> <span class="n">with</span> <span class="n">your</span> <span class="n">certificate</span> <span class="n">request</span>
<span class="n">A</span> <span class="n">challenge</span> <span class="n">password</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">An</span> <span class="n">optional</span> <span class="n">company</span> <span class="n">name</span> <span class="p">[]</span><span class="o">:</span>
<span class="n">Using</span> <span class="n">configuration</span> <span class="n">from</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">openssl</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">Check</span> <span class="n">that</span> <span class="n">the</span> <span class="n">request</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">signature</span>
<span class="n">Signature</span> <span class="n">ok</span>
<span class="n">The</span> <span class="n">Subject</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Distinguished</span> <span class="n">Name</span> <span class="n">is</span> <span class="n">as</span> <span class="n">follows</span>
<span class="n">countryName</span>           <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">US</span><span class="err">&#39;</span>
<span class="n">stateOrProvinceName</span>   <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">CA</span><span class="err">&#39;</span>
<span class="n">localityName</span>          <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">SanFrancisco</span><span class="err">&#39;</span>
<span class="n">organizationName</span>      <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Fort</span><span class="o">-</span><span class="n">Funston</span><span class="err">&#39;</span>
<span class="n">commonName</span>            <span class="o">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">client</span><span class="err">&#39;</span>
<span class="n">emailAddress</span>          <span class="o">:</span><span class="n">IA5STRING</span><span class="o">:</span><span class="err">&#39;</span><span class="n">me</span><span class="err">@</span><span class="n">myhost</span><span class="p">.</span><span class="n">mydomain</span><span class="err">&#39;</span>
<span class="n">Certificate</span> <span class="n">is</span> <span class="n">to</span> <span class="n">be</span> <span class="n">certified</span> <span class="n">until</span> <span class="n">Jul</span> <span class="mi">28</span> <span class="mi">09</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">53</span> <span class="mi">2022</span> <span class="n">GMT</span> <span class="p">(</span><span class="mi">3650</span> <span class="n">days</span><span class="p">)</span>
<span class="n">Sign</span> <span class="n">the</span> <span class="n">certificate</span><span class="o">?</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">:</span><span class="n">y</span>


<span class="mi">1</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">1</span> <span class="n">certificate</span> <span class="n">requests</span> <span class="n">certified</span><span class="p">,</span> <span class="n">commit</span><span class="o">?</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="n">y</span>
<span class="n">Write</span> <span class="n">out</span> <span class="n">database</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">new</span> <span class="n">entries</span>
<span class="n">Data</span> <span class="n">Base</span> <span class="n">Updated</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">dh</span>
<span class="n">Generating</span> <span class="n">DH</span> <span class="n">parameters</span><span class="p">,</span> <span class="mi">1024</span> <span class="n">bit</span> <span class="kt">long</span> <span class="n">safe</span> <span class="n">prime</span><span class="p">,</span> <span class="n">generator</span> <span class="mi">2</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">going</span> <span class="n">to</span> <span class="n">take</span> <span class="n">a</span> <span class="kt">long</span> <span class="n">time</span>
<span class="p">...............</span><span class="o">+</span><span class="p">..........................................................................</span><span class="o">+</span><span class="p">.............</span><span class="o">+</span><span class="p">.....................</span><span class="o">+</span><span class="p">.....................................</span><span class="o">+</span><span class="p">....................................</span>
<span class="p">............................................................................</span><span class="o">+</span><span class="p">.........................................................</span><span class="o">+</span><span class="p">......................................................................</span>
<span class="p">..................................................</span><span class="o">+</span><span class="p">...........................................................................................................................................................</span>
<span class="p">...........................</span><span class="o">+</span><span class="p">...................................................</span><span class="o">+</span><span class="p">.......................................................................................................................</span><span class="o">+</span><span class="p">....</span>
<span class="p">..........................................</span><span class="o">+</span><span class="p">.......................................</span><span class="o">+</span><span class="p">..........................................................................................................................</span>
<span class="p">...........................................................</span><span class="o">+</span><span class="p">............................................................................................</span><span class="o">+</span><span class="p">....................................................</span>
<span class="p">.</span><span class="o">+</span><span class="p">.............</span><span class="o">+</span><span class="p">......................</span><span class="o">+</span><span class="p">.............................................................</span><span class="o">+</span><span class="p">..</span><span class="o">+</span><span class="p">.....................</span><span class="o">+</span><span class="p">....................................................................</span><span class="o">+</span><span class="p">....</span>
<span class="p">...........................</span><span class="o">+</span><span class="p">..</span><span class="o">+</span><span class="p">..</span><span class="o">+</span><span class="p">.....</span><span class="o">+</span><span class="p">...</span><span class="o">+</span><span class="p">...............</span><span class="o">++*++*++*</span>
</pre></div>


<p>将刚才创建的文件复制到配置目录，继续执行如下命令： </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="p">.</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">crt</span> <span class="p">.</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">key</span> <span class="p">.</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">dh1024</span><span class="p">.</span><span class="n">pem</span> <span class="p">.</span>
</pre></div>


<p>执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="p">.</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">crt</span> <span class="p">.</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">key</span> <span class="p">.</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">dh1024</span><span class="p">.</span><span class="n">pem</span> <span class="p">.</span>
</pre></div>


<p>为了更方便的使用openvpn，这里我们需要修改openvpn的协议和端口，我们将通讯协议改为 tcp，端口改为 https 的端口号 443。 </p>
<p>继续在 putty 里面执行如下命令： </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">port</span><span class="p">.</span><span class="err">*/</span><span class="n">port</span> <span class="mi">443</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">proto</span> <span class="n">tcp</span><span class="p">.</span><span class="err">*/</span><span class="n">proto</span> <span class="n">tcp</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="n">proto</span> <span class="n">udp</span><span class="p">.</span><span class="err">*/</span><span class="p">;</span><span class="n">proto</span> <span class="n">udp</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.222&quot;</span><span class="o">/</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.222&quot;</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.220.220&quot;</span><span class="o">/</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.220&quot;</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">keepalive</span> <span class="mi">10</span> <span class="mi">120</span><span class="o">/</span><span class="n">keepalive</span> <span class="mi">1000</span> <span class="mi">12000</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;redirect-gateway.*/push &quot;</span><span class="n">redirect</span><span class="o">-</span><span class="n">gateway</span> <span class="n">def1</span> <span class="n">bypass</span><span class="o">-</span><span class="n">dhcp</span><span class="s">&quot;/&#39; /etc/openvpn/server.conf</span>
</pre></div>


<p>执行结果如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">port</span><span class="p">.</span><span class="err">*/</span><span class="n">port</span> <span class="mi">443</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">proto</span> <span class="n">tcp</span><span class="p">.</span><span class="err">*/</span><span class="n">proto</span> <span class="n">tcp</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="n">proto</span> <span class="n">udp</span><span class="p">.</span><span class="err">*/</span><span class="p">;</span><span class="n">proto</span> <span class="n">udp</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.222&quot;</span><span class="o">/</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.222&quot;</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.220.220&quot;</span><span class="o">/</span><span class="n">push</span> <span class="s">&quot;dhcp-option DNS 208.67.222.220&quot;</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">keepalive</span> <span class="mi">10</span> <span class="mi">120</span><span class="o">/</span><span class="n">keepalive</span> <span class="mi">1000</span> <span class="mi">12000</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">;</span><span class="n">push</span> <span class="s">&quot;redirect-gateway.*/push &quot;</span><span class="n">redirect</span><span class="o">-</span><span class="n">gateway</span> <span class="n">def1</span> <span class="n">bypass</span><span class="o">-</span><span class="n">dhcp</span><span class="s">&quot;/&#39; /etc/openvpn/server.conf</span>
</pre></div>


<p>配置完成，执行如下命令重启 openvpn ： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">restart</span>
</pre></div>


<p>执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">restart</span>
<span class="o">*</span> <span class="n">Stopping</span> <span class="n">virtual</span> <span class="n">private</span> <span class="n">network</span> <span class="n">daemon</span><span class="p">(</span><span class="n">s</span><span class="p">)...</span>                                 <span class="o">*</span>   <span class="n">Stopping</span> <span class="n">VPN</span> <span class="err">&#39;</span><span class="n">server</span><span class="err">&#39;</span>                                               <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
<span class="o">*</span> <span class="n">Starting</span> <span class="n">virtual</span> <span class="n">private</span> <span class="n">network</span> <span class="n">daemon</span><span class="p">(</span><span class="n">s</span><span class="p">)...</span>                                 <span class="o">*</span>   <span class="n">Autostarting</span> <span class="n">VPN</span> <span class="err">&#39;</span><span class="n">server</span><span class="err">&#39;</span>                                           <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<h4 id="_44">配置 防火墙</h4>
<p>在Putty里面执行如下命令： </p>
<p>打开 IP 转发： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>执行如下命令配置防火墙： </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.8.0.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span>
<span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">exit</span> <span class="mi">0</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
</pre></div>


<p>大功告成，可以使用 OPEN VPN 了。 </p>
<h4 id="_45">配置客户端</h4>
<p>1 安装 openvpn 客户端 </p>
<p>请点击 <a href="http://openvpn.ustc.edu.cn/openvpn-2.1.3-install.exe" title="http://openvpn.ustc.edu.cn/openvpn-2.1.3-install.exe">openvpn 2.1.3</a> 下载并安装。 </p>
<p>2 复制配置文件 </p>
<p>将安装目录的 sample-config 目录下面的 client.ovpn 复制到 安装目录下的 config 目录 </p>
<p>如将 C:\Program Files\OpenVPN\sample-config\client.ovpn 复制到 C:\Program Files\OpenVPN\config 目录 </p>
<p>3 修改 client.ovpn 配置文件 </p>
<p>不要直接使用windows的记事本修改，请使用例如 Notepad++ 或 UltraEdit 等编辑器编辑 </p>
<p>修改传输协议，注意请使用半角编辑，即关闭输入法进行编辑。 </p>
<p>找到 </p>
<div class="hlcode"><pre><span class="p">;</span><span class="n">proto</span> <span class="n">tcp</span>
</pre></div>


<p>的行，删除前面的 ; 号，修改为 </p>
<div class="hlcode"><pre><span class="n">proto</span> <span class="n">tcp</span>
</pre></div>


<p>找到 </p>
<div class="hlcode"><pre><span class="n">proto</span> <span class="n">udp</span>
</pre></div>


<p>行，在前面加上 ; 号，修改为 </p>
<div class="hlcode"><pre><span class="p">;</span><span class="n">proto</span> <span class="n">udp</span>
</pre></div>


<p>修改，需要连接的远程地址和端口： </p>
<p>找到 </p>
<div class="hlcode"><pre><span class="n">remote</span> <span class="n">my</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mi">1</span> <span class="mi">1194</span>
</pre></div>


<p>行，修改为： </p>
<div class="hlcode"><pre><span class="n">remote</span> <span class="err">你的</span><span class="n">VPS</span><span class="err">的</span><span class="n">IP</span> <span class="mi">443</span>
</pre></div>


<p>例如，（不可以照抄，需要将 184.82.9.30 改为你自己的VPS的地址）： </p>
<div class="hlcode"><pre><span class="n">remote</span> <span class="mf">184.82.9.30</span> <span class="mi">443</span>
</pre></div>


<p>4 下载客户端证书文件 </p>
<p>使用 filezilla 连接到服务器，到 /etc/openvpn/easy-rsa/2.0/keys 目录，将服务器的 ca.crt client.crt client.csr client.key 下载到 本地 openvpn 安装目录下的 config 目录，如下图所示： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_openvpn_client.jpg&amp;variant=zh-cn" title="Image:Vps_openvpn_client.jpg"><img alt="Image:Vps_openvpn_client.jpg" src="http://wiki.ubuntu.org.cn/images/b/be/Vps_openvpn_client.jpg" /></a></p>
<p>5 运行菜单里面的 OpenVPN GUI，出现在系统右下角，点击红色网络图标，右键 选择 connect 点击，图标变为绿色，即连接上。 </p>
<h3 id="pptp-vpn">安装 PPTP VPN</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=PPTPServer&amp;variant=zh-cn" title="PPTPServer">PPTPServer</a> <a href="http://wiki.ubuntu.org.cn/index.php?title=VPN&amp;variant=zh-cn" title="VPN">VPN</a> 需要VPS支持 PPP 设备。 </p>
<h4 id="ppp">开启 PPP 支持</h4>
<p>XEN VPS 无需开启，直接支持，跳过这一步。 </p>
<p>在 putty 里面运行如下命令，检查是否开启了tun设备： </p>
<div class="hlcode"><pre><span class="n">ls</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ppp</span>
</pre></div>


<p>如果出现如下提示，表示已经开启，否则需要开启 ppp 支持。 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ppp</span>    
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ppp</span>
</pre></div>


<p>如果没有发现上面的提示，则需要按下面的办法处理。 </p>
<p>如果是OPENVZ 的VPS，请先登录 <a href="http://http://vps.ubuntu.org.cn/vm" title="http://http://vps.ubuntu.org.cn/vm">管理面板</a>，打开 VPS 后，点击【设置】，然后再点击【激活PPP】 </p>
<p>然后重复上述测试，如果还是无法找到 ppp 设备，尝试重启下 VPS 。 </p>
<h4 id="pptpd">安装 pptpd 服务</h4>
<p>执行如下命令安装，遇到提示输入 Y/n 时，输入 Y 回车即可： </p>
<div class="hlcode"><pre> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">pptpd</span>
</pre></div>


<p>执行结果如下： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">289085</span><span class="o">:~</span><span class="err">#</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">pptpd</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>       
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">extra</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">bcrelay</span> <span class="n">libpcap0</span><span class="mf">.8</span> <span class="n">ppp</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="o">:</span>
  <span class="n">bcrelay</span> <span class="n">libpcap0</span><span class="mf">.8</span> <span class="n">ppp</span> <span class="n">pptpd</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">4</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">and</span> <span class="mi">1</span> <span class="n">not</span> <span class="n">upgraded</span><span class="p">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">542</span> <span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="p">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">872</span> <span class="n">kB</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">?</span> 
<span class="nl">Get:</span><span class="mi">1</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ oneiric/main libpcap0.8 i386 1.1.1-8 [117 kB]</span>
<span class="nl">Get:</span><span class="mi">2</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ oneiric/main ppp i386 2.4.5-5ubuntu1 [334 kB]</span>
<span class="nl">Get:</span><span class="mi">3</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ oneiric/main bcrelay i386 1.3.4-5ubuntu1 [10.7 kB]</span>
<span class="nl">Get:</span><span class="mi">4</span> <span class="n">http</span><span class="o">:</span><span class="c1">//archive.ubuntu.com/ubuntu/ oneiric/main pptpd i386 1.3.4-5ubuntu1 [80.4 kB]</span>
<span class="n">Fetched</span> <span class="mi">542</span> <span class="n">kB</span> <span class="n">in</span> <span class="mi">2</span><span class="n">s</span> <span class="p">(</span><span class="mi">242</span> <span class="n">kB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">libpcap0</span><span class="mf">.8</span><span class="p">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">24582</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Unpacking</span> <span class="n">libpcap0</span><span class="mf">.8</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">libpcap0</span><span class="mf">.8</span><span class="n">_1</span><span class="mf">.1.1</span><span class="o">-</span><span class="mi">8</span><span class="n">_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">ppp</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">ppp</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">ppp_2</span><span class="mf">.4.5</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
 <span class="n">Removing</span> <span class="n">any</span> <span class="n">system</span> <span class="n">startup</span> <span class="n">links</span> <span class="k">for</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">ppp</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">bcrelay</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">bcrelay</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">bcrelay_1</span><span class="mf">.3.4</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">deselected</span> <span class="n">package</span> <span class="n">pptpd</span><span class="p">.</span>
<span class="n">Unpacking</span> <span class="n">pptpd</span> <span class="p">(</span><span class="n">from</span> <span class="p">...</span><span class="o">/</span><span class="n">pptpd_1</span><span class="mf">.3.4</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1_i386</span><span class="p">.</span><span class="n">deb</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Processing</span> <span class="n">triggers</span> <span class="k">for</span> <span class="n">man</span><span class="o">-</span><span class="n">db</span> <span class="p">...</span>
<span class="n">Processing</span> <span class="n">triggers</span> <span class="k">for</span> <span class="n">ureadahead</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">libpcap0</span><span class="mf">.8</span> <span class="p">(</span><span class="mf">1.1.1</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">ppp</span> <span class="p">(</span><span class="mf">2.4.5</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">bcrelay</span> <span class="p">(</span><span class="mf">1.3.4</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">pptpd</span> <span class="p">(</span><span class="mf">1.3.4</span><span class="o">-</span><span class="mi">5u</span><span class="n">buntu1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Starting</span> <span class="n">PPTP</span> <span class="n">Daemon</span><span class="o">:</span> <span class="n">pptpd</span><span class="p">.</span>
<span class="n">Processing</span> <span class="n">triggers</span> <span class="k">for</span> <span class="n">libc</span><span class="o">-</span><span class="n">bin</span> <span class="p">...</span>
<span class="n">ldconfig</span> <span class="n">deferred</span> <span class="n">processing</span> <span class="n">now</span> <span class="n">taking</span> <span class="n">place</span>
</pre></div>


<h4 id="pptpd_1">配置 pptpd</h4>
<p>为了避免和本地网络冲突，我们创建VPN的IP范围为 10.0.0.2-10.0.0.200 </p>
<p>执行如下命令： </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/#debug/debug/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pptpd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">localip</span> <span class="mf">10.0.0.1</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pptpd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">remoteip</span> <span class="mf">10.0.0.2</span><span class="o">-</span><span class="mi">200</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pptpd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">ms</span><span class="o">-</span><span class="n">dns</span> <span class="mf">8.8.8.8</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">pptpd</span><span class="o">-</span><span class="n">options</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">ms</span><span class="o">-</span><span class="n">dns</span> <span class="mf">8.8.4.4</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">pptpd</span><span class="o">-</span><span class="n">options</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">nopcomp</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">pptpd</span><span class="o">-</span><span class="n">options</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">noaccomp</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">pptpd</span><span class="o">-</span><span class="n">options</span>
</pre></div>


<p>继续增加 pptp 用户帐号： </p>
<p>格式为 [UserName] pptpd [Password] * ，我们增加一个 guest 密码 为 123456 的用户如下： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">guest</span> <span class="o">*</span> <span class="mi">123456</span> <span class="o">*</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">chap</span><span class="o">-</span><span class="n">secrets</span>
</pre></div>


<p>重启下pptpd: </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">pptpd</span> <span class="n">restart</span>
</pre></div>


<p>注意：如果需要在 iphone 上使用，请在 iphone 的 PPTP 设置页将 "加密级别" 设置为 "最高" ，否则将无法连接上。 </p>
<h4 id="_46">配置防火墙</h4>
<p>打开 IP 转发： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>配置防火墙： </p>
<div class="hlcode"><pre> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
 <span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span>
 <span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
 <span class="n">echo</span> <span class="err">&#39;</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
 <span class="n">echo</span> <span class="err">&#39;</span><span class="n">exit</span> <span class="mi">0</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
 <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
</pre></div>


<p>重启下pptpd: </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">pptpd</span> <span class="n">restart</span>
</pre></div>


<p>大功告成，可以使用 PPTP VPN 了。 </p>
<h4 id="_47">检查日志</h4>
<p>使用如下命令检查拨号日志： </p>
<div class="hlcode"><pre><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">syslog</span>
</pre></div>


<h3 id="l2tp-vpn">安装 L2TP VPN</h3>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=L2TPServer&amp;variant=zh-cn" title="L2TPServer">L2TPServer</a> 需要 VPS 支持 PPP 设备 </p>
<p>XEN 完全支持 L2TP + IPSec ，OpenVZ 支持 L2TP 但不支持 ipsec 加密。如果希望流量加密，需要更换为 XEN 的VPS。 </p>
<p>由于 OpenVZ 无法开启内核级的 IPSec ，所以默认 OSX/IOS 无法使用，可以创建或修改 /etc/ppp/options 文件，并添加 下面的内容： </p>
<div class="hlcode"><pre><span class="n">plugin</span> <span class="n">L2TP</span><span class="p">.</span><span class="n">ppp</span>
<span class="n">l2tpnoipsec</span>
</pre></div>


<p>注：IOS需要越狱后才可以修改或创建此文件。推荐安装下一个章节中的独立 IPSec VPN 服务，这样就Apple 用户就不需要越狱，直接支持。 </p>
<p>OpenVZ 的 Vps 安装 L2TP 前，请先参考上一节先确认 VPS 是否已经开启了 PPP 的支持。 </p>
<h4 id="xl2tpd">安装 xl2tpd</h4>
<p>执行如下命令安装 xl2tpd ，遇到提示输入 Y/n 时，输入 Y 回车即可： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">xl2tpd</span> <span class="n">ppp</span>
</pre></div>


<h4 id="xl2tpd_1">配置 xl2tpd</h4>
<p>执行完毕后，继续执行如下命令配置 xl2tpd , 为了避免和本地网络冲突，我们创建VPN的IP范围为 10.0.0.2-10.0.0.200： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">xl2tpd</span><span class="o">/</span><span class="n">xl2tpd</span><span class="p">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">global</span><span class="p">]</span>
<span class="n">ipsec</span> <span class="n">saref</span> <span class="o">=</span> <span class="n">no</span>

<span class="p">[</span><span class="n">lns</span> <span class="k">default</span><span class="p">]</span>
<span class="n">ip</span> <span class="n">range</span> <span class="o">=</span> <span class="mf">10.0.0.2</span><span class="o">-</span><span class="mf">10.0.0.200</span>
<span class="n">local</span> <span class="n">ip</span> <span class="o">=</span> <span class="mf">10.0.0.1</span>
<span class="n">refuse</span> <span class="n">chap</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">refuse</span> <span class="n">pap</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">require</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">ppp</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">pppoptfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">xl2tpd</span><span class="o">-</span><span class="n">options</span>
<span class="n">length</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">yes</span>    
<span class="n">EOF</span>
</pre></div>


<p>继续执行下面的命令配置拨号属性： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">xl2tpd</span><span class="o">-</span><span class="n">options</span>
<span class="n">require</span><span class="o">-</span><span class="n">mppe</span>
<span class="n">require</span><span class="o">-</span><span class="n">mschap</span><span class="o">-</span><span class="n">v2</span>
<span class="n">asyncmap</span> <span class="mi">0</span>
<span class="n">auth</span>
<span class="n">crtscts</span>
<span class="n">lock</span>
<span class="n">hide</span><span class="o">-</span><span class="n">password</span>
<span class="n">modem</span>
<span class="n">name</span> <span class="n">l2tpd</span>
<span class="n">proxyarp</span>
<span class="n">lcp</span><span class="o">-</span><span class="n">echo</span><span class="o">-</span><span class="n">interval</span> <span class="mi">30</span>
<span class="n">lcp</span><span class="o">-</span><span class="n">echo</span><span class="o">-</span><span class="n">failure</span> <span class="mi">4</span>
<span class="n">ms</span><span class="o">-</span><span class="n">dns</span> <span class="mf">8.8.8.8</span>
<span class="n">ms</span><span class="o">-</span><span class="n">dns</span> <span class="mf">8.8.4.4</span>  
<span class="n">EOF</span>
</pre></div>


<p>继续增加 l2tpd 用户帐号： </p>
<p>格式为 [UserName] l2tpd [Password] * ，我们增加一个 guest 密码 为 123456 的用户如下： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">guest</span> <span class="o">*</span> <span class="mi">123456</span> <span class="o">*</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ppp</span><span class="o">/</span><span class="n">chap</span><span class="o">-</span><span class="n">secrets</span>
</pre></div>


<h4 id="_48">配置防火墙</h4>
<p>打开 IP 转发： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>配置防火墙： </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span>
<span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">exit</span> <span class="mi">0</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
</pre></div>


<h4 id="xl2tpd_2">启动 xl2tpd</h4>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">xl2tpd</span> <span class="n">restart</span>
</pre></div>


<p>可以采用不加密的方式来使用 L2TP VPN 了。 注意：拨号的选项中的安全设置为可选加密（没有加密也可以连接） </p>
<h4 id="ipsec">安装 IPSec</h4>
<p>如果你的 VPS 是 XEN 的，我们继续配置开启 ipsec 加密支持。 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openswan</span>
</pre></div>


<p>安装过程中，会弹出2个配置选择界面，直接回车即可。 </p>
<h4 id="ipsec_1">配置 IPSec</h4>
<p>执行如下命令配置 ipsec，这里拨号的秘钥设置为 psk ，你也可以修改本段最后一步的 "psk" 为其他秘钥： </p>
<div class="hlcode"><pre><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">l2tp</span><span class="o">-</span><span class="n">psk</span><span class="p">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">l2tp</span><span class="o">-</span><span class="n">psk</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/left=.*/left=`ifconfig eth0 |awk &#39;/inet/ {split($2,x,&quot;</span><span class="o">:</span><span class="s">&quot;);print x[2]}&#39;`/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">l2tp</span><span class="o">-</span><span class="n">psk</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/leftnexthop=.*/leftnexthop=`ip route show|grep &#39;default&#39;|awk &#39;{print $3}&#39;`/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">l2tp</span><span class="o">-</span><span class="n">psk</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/protostack=.*/protostack=netkey/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/include.*//&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s">&quot;include /etc/ipsec.d/l2tp-psk.conf&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s">&quot;`ifconfig eth0 |awk &#39;/inet/ {split($2,x,&quot;</span><span class="o">:</span><span class="s">&quot;);print x[2]}&#39;` %any: </span><span class="se">\&quot;</span><span class="s">psk</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">openswan</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">secrets</span><span class="p">.</span><span class="n">inc</span>
</pre></div>


<p>启动 ipsec 服务： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">ipsec</span> <span class="n">restart</span>
</pre></div>


<h4 id="ipsec_2">测试 ipsec</h4>
<p>执行以下命令测试： </p>
<div class="hlcode"><pre><span class="n">ipsec</span> <span class="n">verify</span>
</pre></div>


<p>如果提示中出现任何红色的 [FAILED] 的结果，表示 ipsec 有问题，无法使用。 </p>
<h4 id="xl2tpd-ipsec">开启 xl2tpd 的 ipsec 支持</h4>
<p>如果以上 ipsec 测试通过，执行以下命令开启 xl2tpd 的 ipsec 支持： </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/ipsec saref.*/ipsec saref = yes/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">xl2tpd</span><span class="o">/</span><span class="n">xl2tpd</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>重启下l2tpd : </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">xl2tpd</span> <span class="n">restart</span>
</pre></div>


<p>好了可以采用加密方式来使用 L2TP VPN 了。 </p>
<h3 id="ipsec-vpn">安装 IPSec VPN</h3>
<p>由于最新的 <a href="http://wiki.ubuntu.org.cn/index.php?title=Strongswan&amp;variant=zh-cn" title="Strongswan">strongswan</a> 可以不依赖内核，仅仅需要 Tun/Tap ，对于 OpenVZ 或 XEN 而言，也可以搭建一个独立的 IPSec VPN。 OSX/IOS/安卓 默认支持。 </p>
<p>以下指南在 Ubuntu 14.04 上测试通过，其它版本请自行参考。 </p>
<p>OpenVZ 首先去面板开启 Tun/Tap ，具体验证参考前面 OpenVPN 的安装指南。 </p>
<h4 id="_49">安装编译环境</h4>
<p>执行下面的命令增加 deb-src 源，并安装编译环境。 </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span> <span class="o">|</span> <span class="n">sed</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">deb</span> <span class="o">/</span><span class="n">deb</span><span class="o">-</span><span class="n">src</span> <span class="o">/</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">sources</span><span class="o">-</span><span class="n">src</span><span class="p">.</span><span class="n">list</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">build</span><span class="o">-</span><span class="n">dep</span> <span class="n">strongswan</span>
</pre></div>


<h4 id="strongswan">安装 strongswan</h4>
<p>执行下面的命令，下载并安装 strongswan。 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">strongswan</span> <span class="n">strongswan</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">libipsec</span> <span class="n">strongswan</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">xauth</span><span class="o">-</span><span class="n">generic</span>
</pre></div>


<p>OpenVZ 用户需要给 strongswan 打补丁，执行以下命令，XEN 用户请忽略本段。 </p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">root</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">source</span> <span class="n">strongswan</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">libipsec</span>
<span class="n">cd</span> <span class="n">strongswan</span><span class="o">*</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">libipsec</span> 
<span class="n">make</span>
<span class="n">cp</span> <span class="n">src</span><span class="o">/</span><span class="n">libcharon</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">kernel_libipsec</span><span class="o">/</span><span class="p">.</span><span class="n">libs</span><span class="o">/</span><span class="n">libstrongswan</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">libipsec</span><span class="p">.</span><span class="n">so</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ipsec</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span>
</pre></div>


<h4 id="strongswan_1">配置 strongswan</h4>
<p>配置 /etc/ipsec.conf </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">conf</span>
<span class="n">config</span> <span class="n">setup</span>
    <span class="n">uniqueids</span><span class="o">=</span><span class="n">no</span>

<span class="n">conn</span> <span class="o">%</span><span class="k">default</span>
    <span class="err">#</span><span class="n">rekey</span><span class="o">=</span><span class="n">yes</span>
    <span class="n">left</span><span class="o">=%</span><span class="n">defaultroute</span>
    <span class="n">leftsubnet</span><span class="o">=</span><span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>
    <span class="n">right</span><span class="o">=%</span><span class="n">any</span>
    <span class="n">dpddelay</span><span class="o">=</span><span class="mi">300</span><span class="n">s</span>
    <span class="n">dpdtimeout</span><span class="o">=</span><span class="mi">1</span><span class="n">h</span>
    <span class="n">dpdaction</span><span class="o">=</span><span class="n">clear</span>
    <span class="k">auto</span><span class="o">=</span><span class="n">add</span>

<span class="n">conn</span> <span class="n">ikecommon</span>
    <span class="n">rightsourceip</span><span class="o">=</span><span class="mf">10.0.0.0</span><span class="o">/</span><span class="mi">24</span>
    <span class="err">#</span><span class="n">modeconfig</span><span class="o">=</span><span class="n">push</span>
    <span class="err">#</span><span class="n">esp</span><span class="o">=</span><span class="n">aes128</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="n">modp2048</span>
    <span class="n">compress</span><span class="o">=</span><span class="n">yes</span>

<span class="n">conn</span> <span class="n">ikev1pskaggressive</span>
    <span class="n">aggressive</span><span class="o">=</span><span class="n">yes</span>
    <span class="err">#</span><span class="n">type</span><span class="o">=</span><span class="n">tunnel</span>
    <span class="n">also</span><span class="o">=</span><span class="n">ikev1psk</span>

<span class="n">conn</span> <span class="n">ikev1psk</span>
    <span class="err">#</span><span class="n">authby</span><span class="o">=</span><span class="n">xauthpsk</span>
    <span class="n">leftauth</span><span class="o">=</span><span class="n">psk</span>
    <span class="n">rightauth</span><span class="o">=</span><span class="n">psk</span>
    <span class="n">rightauth2</span><span class="o">=</span><span class="n">xauth</span>
    <span class="err">#</span><span class="n">xauth</span><span class="o">=</span><span class="n">server</span>
    <span class="n">also</span><span class="o">=</span><span class="n">ikev1</span>

<span class="n">conn</span> <span class="n">ikev1</span>
    <span class="n">keyexchange</span><span class="o">=</span><span class="n">ikev1</span>
    <span class="err">#</span><span class="n">ikelifetime</span><span class="o">=</span><span class="mi">60</span><span class="n">m</span>
    <span class="err">#</span><span class="n">keylife</span><span class="o">=</span><span class="mi">20</span><span class="n">m</span>
    <span class="err">#</span><span class="n">rekeymargin</span><span class="o">=</span><span class="mi">3</span><span class="n">m</span>
    <span class="err">#</span><span class="n">keyingtries</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">also</span><span class="o">=</span><span class="n">ikecommon</span>

<span class="n">conn</span> <span class="n">L2TP</span><span class="o">-</span><span class="n">PSK</span><span class="o">-</span><span class="n">NAT</span>
    <span class="n">leftfirewall</span><span class="o">=</span><span class="n">yes</span>
    <span class="n">rightfirewall</span><span class="o">=</span><span class="n">yes</span>
    <span class="n">also</span><span class="o">=</span><span class="n">L2TP</span><span class="o">-</span><span class="n">PSK</span><span class="o">-</span><span class="n">noNAT</span>

<span class="n">conn</span> <span class="n">L2TP</span><span class="o">-</span><span class="n">PSK</span><span class="o">-</span><span class="n">noNAT</span>
    <span class="n">keyexchange</span><span class="o">=</span><span class="n">ikev1</span>
    <span class="n">type</span><span class="o">=</span><span class="n">transport</span>
    <span class="n">authby</span><span class="o">=</span><span class="n">psk</span>
    <span class="n">keyingtries</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">rekey</span><span class="o">=</span><span class="n">no</span>
    <span class="n">leftprotoport</span><span class="o">=</span><span class="mi">17</span><span class="o">/</span><span class="mi">1701</span>
    <span class="n">rightprotoport</span><span class="o">=</span><span class="mi">17</span><span class="o">/%</span><span class="n">any</span>
    <span class="n">ike</span><span class="o">=</span><span class="s">&quot;aes256-sha1-modp2048!&quot;</span>
    <span class="n">esp</span><span class="o">=</span><span class="s">&quot;aes-sha1!&quot;</span>
<span class="n">EOF</span>
</pre></div>


<p>编辑 /etc/strongswan.conf </p>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">load_modular</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/&amp;</span><span class="err">\</span><span class="n">n</span>        <span class="n">dns2</span> <span class="o">=</span> <span class="mf">8.8.4.4</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">strongswan</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">load_modular</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/&amp;</span><span class="err">\</span><span class="n">n</span>        <span class="n">dns1</span> <span class="o">=</span> <span class="mf">8.8.8.8</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">strongswan</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<h4 id="_50">创建用户和密钥</h4>
<p>运行以下命令创建一个密钥为 psk ，用户名、密码分别为 guest 和 123456 的登录帐号，你可以修改命令设置为其它。 </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="o">:</span> <span class="n">PSK</span> <span class="s">&quot;psk&quot;</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">secrets</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">guest</span> <span class="o">:</span> <span class="n">XAUTH</span> <span class="s">&quot;123456&quot;</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ipsec</span><span class="p">.</span><span class="n">secrets</span>
</pre></div>


<h4 id="_51">配置防火墙</h4>
<p>打开 IP 转发： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">&#39;</span><span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>配置防火墙： </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span>
<span class="n">echo</span> <span class="err">&#39;#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">rules</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">exit</span> <span class="mi">0</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="k">if</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptablesload</span>
</pre></div>


<h4 id="_52">运行</h4>
<div class="hlcode"><pre><span class="n">service</span> <span class="n">strongswan</span> <span class="n">restart</span>
</pre></div>


<h4 id="_53">客户端</h4>
<p>安卓或iphone上自带，直接配置连接即可。 </p>
<p>Windows 端： <a href="https://www.shrew.net/download/vpn/vpn-client-2.2.2-release.exe" title="https://www.shrew.net/download/vpn/vpn-client-2.2.2-release.exe">https://www.shrew.net/download/vpn/vpn-client-2.2.2-release.exe</a></p>
<p>安装时选择 Standard 版本，这个是免费的。 </p>
<p>安装后运行 VPN Access Manager ，选“Add”： </p>
<ul>
<li>“General” 选项下，在 “Host Name or IP address” 填写VPS的IP地址</li>
<li>“Authorization”选项下：<ul>
<li>“Authorization Method”选“Mutual PSK + XAuth”</li>
<li>“Local Identity”的“Identification Type”选“IP Address”</li>
<li>“Credentials”下面“Pre Shared Key”里输入直接配置的密码 psk</li>
</ul>
</li>
<li>“Phrase 1” 选项下，“Exchange Type”选“Main”</li>
<li>“Phrase 2” 选项下， “PFS Exchange”选“auto”</li>
</ul>
<p>保存。 点击 Connect 进行连接，连接用户名是 guest 密码是 123456 ，连接时会有一个警告，忽略即可。 </p>
<h3 id="shadowsocks">安装 Shadowsocks</h3>
<h4 id="_54">服务端</h4>
<p>运行如下命令安装： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">gevent</span> <span class="n">python</span><span class="o">-</span><span class="n">pip</span> <span class="n">python</span><span class="o">-</span><span class="n">m2crypto</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">shadowsocks</span>
</pre></div>


<p>运行如下命令建立配置文件，密码是 123456，端口为443，你也可以替换为你自己的配置。 </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowsocks</span><span class="p">.</span><span class="n">json</span>
<span class="p">{</span>
   <span class="s">&quot;server&quot;</span><span class="o">:</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span>
   <span class="s">&quot;server_port&quot;</span><span class="o">:</span><span class="mi">443</span><span class="p">,</span>
   <span class="s">&quot;local_port&quot;</span><span class="o">:</span><span class="mi">1080</span><span class="p">,</span>
   <span class="s">&quot;password&quot;</span><span class="o">:</span><span class="s">&quot;123456&quot;</span><span class="p">,</span>
   <span class="s">&quot;timeout&quot;</span><span class="o">:</span><span class="mi">600</span><span class="p">,</span>
   <span class="s">&quot;method&quot;</span><span class="o">:</span><span class="s">&quot;aes-256-cfb&quot;</span>
<span class="p">}</span>
<span class="n">EOF</span>
</pre></div>


<p>配置服务： </p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shadowsocks</span> 
<span class="cp">#!/bin/sh</span>
<span class="n">NAME</span><span class="o">=</span><span class="n">shadowsocks</span>
<span class="n">PIDFILE</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="err">$</span><span class="n">NAME</span><span class="p">.</span><span class="n">pid</span>
<span class="n">DAEMON</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ssserver</span>
<span class="n">DAEMON_OPTS</span><span class="o">=</span><span class="s">&quot;-c /etc/shadowsocks.json&quot;</span>
<span class="n">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s">&quot;Starting daemon: &quot;</span><span class="err">$</span><span class="n">NAME</span>
    <span class="n">touch</span> <span class="err">$</span><span class="n">PIDFILE</span>
    <span class="n">chown</span> <span class="n">root</span><span class="o">:</span><span class="n">root</span> <span class="err">$</span><span class="n">PIDFILE</span>
    <span class="n">start</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="n">daemon</span> <span class="o">--</span><span class="n">make</span><span class="o">-</span><span class="n">pidfile</span> <span class="o">--</span><span class="n">background</span> <span class="o">--</span><span class="n">start</span> <span class="o">--</span><span class="n">quiet</span> <span class="o">--</span><span class="n">pidfile</span> <span class="err">$</span><span class="n">PIDFILE</span>  <span class="o">--</span><span class="n">chuid</span> <span class="n">root</span><span class="o">:</span><span class="n">root</span> <span class="o">--</span><span class="n">exec</span> <span class="err">$</span><span class="n">DAEMON</span> <span class="o">--</span> <span class="err">$</span><span class="n">DAEMON_OPTS</span> <span class="o">||</span> <span class="nb">true</span>
    <span class="n">echo</span> <span class="s">&quot;.&quot;</span>
<span class="p">}</span>

<span class="n">stop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s">&quot;Stopping daemon: &quot;</span><span class="err">$</span><span class="n">NAME</span>
    <span class="n">start</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="n">daemon</span> <span class="o">--</span><span class="n">stop</span> <span class="o">--</span><span class="n">quiet</span> <span class="o">--</span><span class="n">oknodo</span> <span class="o">--</span><span class="n">pidfile</span> <span class="err">$</span><span class="n">PIDFILE</span> <span class="o">||</span> <span class="nb">true</span>
    <span class="n">echo</span> <span class="s">&quot;.&quot;</span>
<span class="p">}</span>

<span class="k">case</span> <span class="s">&quot;$1&quot;</span> <span class="n">in</span>
    <span class="n">start</span><span class="p">)</span>
        <span class="n">start</span>
        <span class="p">;;</span>
    <span class="n">stop</span><span class="p">)</span>
        <span class="n">stop</span>
        <span class="p">;;</span>
    <span class="n">restart</span><span class="p">)</span>
        <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s">&quot;Restarting daemon: &quot;</span><span class="err">$</span><span class="n">NAME</span>
        <span class="n">stop</span>
        <span class="n">sleep</span> <span class="mi">1</span>
        <span class="n">start</span>
        <span class="p">;;</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">echo</span> <span class="s">&quot;Usage: &quot;</span><span class="err">$</span><span class="mi">1</span><span class="s">&quot; {start|stop|restart}&quot;</span>
    <span class="n">exit</span> <span class="mi">1</span>
<span class="n">esac</span>
<span class="n">exit</span> <span class="mi">0</span>
<span class="n">EOF</span>
</pre></div>


<p>然后继续运行下面命令配置和启动服务端： </p>
<div class="hlcode"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shadowsocks</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span> <span class="n">shadowsocks</span> <span class="n">defaults</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shadowsocks</span> <span class="n">start</span>
</pre></div>


<h4 id="_55">客户端</h4>
<p>访问 <a href="http://sourceforge.net/projects/shadowsocksgui/files/dist/" title="http://sourceforge.net/projects/shadowsocksgui/files/dist/">下载地址</a> 找到 shadowsocks-gui-xxx-win- 开头的文件下载解压缩运行，设置好服务器的IP、端口为443、访问密码为上面的123456，即可在浏览器采用 socks5 1080 来使用了。 </p>
<h3 id="shadowvpn">安装 ShadowVPN</h3>
<h4 id="_56">服务端</h4>
<p>使用如下命令安装，碰到需要输入[y/N]的提示时，输入y回车： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;deb http://shadowvpn.org/debian wheezy main&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shadowvpn</span><span class="p">.</span><span class="n">list</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">shadowvpn</span>
<span class="n">service</span> <span class="n">shadowvpn</span> <span class="n">restart</span>
</pre></div>


<h4 id="_57">客户端</h4>
<p>Ubuntu Linux下安装，执行如下命令，执行前修改命令里面的 VPS_IP 为你服务端的IP地址： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;deb http://shadowvpn.org/debian wheezy main&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shadowvpn</span><span class="p">.</span><span class="n">list</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">shadowvpn</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/127.0.0.1/VPS_IP/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowvpn</span><span class="o">/</span><span class="n">client</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;s/server.conf/client.conf/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">shadowvpn</span> 
<span class="n">service</span> <span class="n">shadowvpn</span> <span class="n">restart</span>
</pre></div>


<p>Windows 或路由器下安装请自行百度。 </p>
<h2 id="_58">额外支持</h2>
<h3 id="xen-vps">XEN VPS 增加交换分区大小</h3>
<p>XEN VPS 专用，OPEN VZ的请忽略。 </p>
<p>增加之前： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">289085</span><span class="o">:~</span><span class="err">#</span> <span class="n">free</span>
             <span class="n">total</span>       <span class="n">used</span>       <span class="n">free</span>     <span class="n">shared</span>    <span class="n">buffers</span>     <span class="n">cached</span>
<span class="nl">Mem:</span>        <span class="mi">506088</span>      <span class="mi">46008</span>     <span class="mi">460080</span>          <span class="mi">0</span>       <span class="mi">3624</span>      <span class="mi">21944</span>
<span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="n">cache</span><span class="o">:</span>      <span class="mi">20440</span>     <span class="mi">485648</span>
<span class="nl">Swap:</span>       <span class="mi">262140</span>          <span class="mi">0</span>     <span class="mi">262140</span>
</pre></div>


<p>运行如下命令增加256M交换内存 </p>
<div class="hlcode"><pre><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="mi">256</span><span class="n">M</span><span class="p">.</span><span class="n">swap</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="n">M</span> <span class="n">count</span><span class="o">=</span><span class="mi">256</span>
<span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="mi">256</span><span class="n">M</span><span class="p">.</span><span class="n">swap</span>
<span class="n">mkswap</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="mi">256</span><span class="n">M</span><span class="p">.</span><span class="n">swap</span>
<span class="n">swapon</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="mi">256</span><span class="n">M</span><span class="p">.</span><span class="n">swap</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="mi">256</span><span class="n">M</span><span class="p">.</span><span class="n">swap</span>  <span class="n">none</span>  <span class="n">swap</span>  <span class="n">sw</span>  <span class="mi">0</span> <span class="mi">0</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>


<p>增加之后： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">289085</span><span class="o">:~</span><span class="err">#</span> <span class="n">free</span>
             <span class="n">total</span>       <span class="n">used</span>       <span class="n">free</span>     <span class="n">shared</span>    <span class="n">buffers</span>     <span class="n">cached</span>
<span class="nl">Mem:</span>        <span class="mi">506088</span>     <span class="mi">312740</span>     <span class="mi">193348</span>          <span class="mi">0</span>       <span class="mi">3952</span>     <span class="mi">284180</span>
<span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="n">cache</span><span class="o">:</span>      <span class="mi">24608</span>     <span class="mi">481480</span>
<span class="nl">Swap:</span>       <span class="mi">524280</span>          <span class="mi">0</span>     <span class="mi">524280</span>
</pre></div>


<h3 id="php_6">配置 php 加速器</h3>
<p>如果你 VPS 的内存大于或等于 1G，可以考虑开启 php 的 apc 加速，否则请忽略本步骤。 </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;extension=apc.so&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apc</span><span class="p">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="s">&quot;apc.enabled=1&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apc</span><span class="p">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="s">&quot;apc.shm_size=64M&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apc</span><span class="p">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="s">&quot;apc.ttl=7200&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php5</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apc</span><span class="p">.</span><span class="n">ini</span>
</pre></div>


<p>如果你安装的是apache2，执行下面命令重启下： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>如果你安装的是nginx，执行下面命令重启下： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
</pre></div>


<h3 id="java">安装 JAVA</h3>
<p>由于 java 非常消耗内存，1G以下的 VPS 请不要考虑使用 java，java 理想的内存在2G以上。 </p>
<p>采用如下命令安装JAVA JDK 1.7： </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openjdk</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="n">jdk</span>
</pre></div>


<p>验证如下： </p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">java</span> <span class="o">-</span><span class="n">version</span>
<span class="n">java</span> <span class="n">version</span> <span class="s">&quot;1.7.0_25&quot;</span> 
<span class="n">OpenJDK</span> <span class="n">Runtime</span> <span class="n">Environment</span> <span class="p">(</span><span class="n">IcedTea</span> <span class="mf">2.3.12</span><span class="p">)</span> <span class="p">(</span><span class="mi">7u25</span><span class="o">-</span><span class="mf">2.3.12</span><span class="o">-</span><span class="mi">4u</span><span class="n">buntu3</span><span class="p">)</span>
<span class="n">OpenJDK</span> <span class="n">Client</span> <span class="n">VM</span> <span class="p">(</span><span class="n">build</span> <span class="mf">23.7</span><span class="o">-</span><span class="n">b01</span><span class="p">,</span> <span class="n">mixed</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sharing</span><span class="p">)</span>
</pre></div>


<p>如果你安装了多个版本的JDK，需要配置默认的JDK，采用如下命令： </p>
<div class="hlcode"><pre><span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">java</span>
</pre></div>


<h2 id="_59">日常维护</h2>
<h3 id="_60">查看硬盘剩余空间大小</h3>
<div class="hlcode"><pre><span class="n">df</span>
</pre></div>


<p>显示 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="err">#</span> <span class="n">df</span>
<span class="n">Filesystem</span>           <span class="mi">1</span><span class="n">K</span><span class="o">-</span><span class="n">blocks</span>      <span class="n">Used</span> <span class="n">Available</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">simfs</span>            <span class="mi">20971520</span>    <span class="mi">583508</span>  <span class="mi">20388012</span>   <span class="mi">3</span><span class="o">%</span> <span class="o">/</span>
</pre></div>


<h3 id="_61">查看硬盘可用文件数</h3>
<div class="hlcode"><pre><span class="n">df</span> <span class="o">-</span><span class="n">i</span>
</pre></div>


<p>显示 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="err">#</span> <span class="n">df</span> <span class="o">-</span><span class="n">i</span>
<span class="n">Filesystem</span>            <span class="n">Inodes</span>   <span class="n">IUsed</span>   <span class="n">IFree</span> <span class="n">IUse</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">simfs</span>            <span class="mi">400000</span>   <span class="mi">26568</span>  <span class="mi">373432</span>    <span class="mi">7</span><span class="o">%</span> <span class="o">/</span>
</pre></div>


<h3 id="_62">查看内存剩余大小</h3>
<div class="hlcode"><pre><span class="n">free</span>
</pre></div>


<p>显示 </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:/</span><span class="err">#</span> <span class="n">free</span>
             <span class="n">total</span>       <span class="n">used</span>       <span class="n">free</span>     <span class="n">shared</span>    <span class="n">buffers</span>     <span class="n">cached</span>
<span class="nl">Mem:</span>        <span class="mi">524800</span>     <span class="mi">245240</span>     <span class="mi">279560</span>          <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">0</span>
<span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="n">cache</span><span class="o">:</span>     <span class="mi">245240</span>     <span class="mi">279560</span>
<span class="nl">Swap:</span>            <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">0</span>
</pre></div>


<h3 id="_63">如何从其他网站上下载文件</h3>
<div class="hlcode"><pre><span class="n">wget</span> <span class="s">&quot;下载文件的链接地址&quot;</span>
</pre></div>


<p>如下所示下载 DZ 论坛的最新版： </p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//download.comsenz.com/DiscuzX/2.0/Discuz_X2_SC_UTF8.zip</span>
</pre></div>


<p>你也可以指定需要保存的文件名为 dz.zip 如下： </p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//download.comsenz.com/DiscuzX/2.0/Discuz_X2_SC_UTF8.zip -O dz.zip</span>
</pre></div>


<p>如果对方有防盗链可以这样下： </p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//download.comsenz.com/DiscuzX/2.0/Discuz_X2_SC_UTF8.zip --referer=http://download.comsenz.com/</span>
</pre></div>


<h3 id="_64">常用服务重启</h3>
<p>重启 Apache2 </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>重启 Mysql </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span> <span class="n">restart</span>
</pre></div>


<p>重启 Nginx </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>


<p>重启 php </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
</pre></div>


<h3 id="_65">查看内存被什么消耗</h3>
<div class="hlcode"><pre><span class="n">ps</span> <span class="o">-</span><span class="n">eo</span> <span class="n">vsz</span><span class="p">,</span><span class="n">rss</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">cmd</span> <span class="o">--</span><span class="n">sort</span> <span class="o">-</span><span class="n">vsz</span><span class="o">|</span><span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">20</span>
</pre></div>


<p>显示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span>  <span class="n">ps</span> <span class="o">-</span><span class="n">eo</span> <span class="n">vsz</span><span class="p">,</span><span class="n">rss</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">cmd</span> <span class="o">--</span><span class="n">sort</span> <span class="o">-</span><span class="n">vsz</span><span class="o">|</span><span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">20</span>
   <span class="n">VSZ</span>   <span class="n">RSS</span>   <span class="n">PID</span> <span class="n">CMD</span>
<span class="mi">146384</span> <span class="mi">36860</span>  <span class="mi">1629</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">mysqld</span> <span class="o">--</span><span class="n">basedir</span><span class="o">=/</span><span class="n">usr</span> <span class="o">--</span><span class="n">datadir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">mysql</span> <span class="o">--</span><span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mysqld</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">pid</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">external</span><span class="o">-</span><span class="n">locking</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">3306</span> <span class="o">--</span><span class="n">socket</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mysqld</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">sock</span>
 <span class="mi">62908</span>  <span class="mi">3676</span>  <span class="mi">8026</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">worker</span> <span class="n">process</span>
 <span class="mi">62660</span>  <span class="mi">2884</span>  <span class="mi">8027</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">cache</span> <span class="n">manager</span> <span class="n">process</span>
 <span class="mi">62660</span>  <span class="mi">3404</span> <span class="mi">17440</span> <span class="n">nginx</span><span class="o">:</span> <span class="n">master</span> <span class="n">process</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span>
 <span class="mi">50380</span> <span class="mi">11160</span>  <span class="mi">1517</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">named</span> <span class="o">-</span><span class="n">u</span> <span class="n">bind</span>
 <span class="mi">33948</span> <span class="mi">13076</span> <span class="mi">32345</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">33796</span> <span class="mi">12912</span> <span class="mi">32344</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">33764</span> <span class="mi">12828</span> <span class="mi">32351</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">33684</span> <span class="mi">12804</span> <span class="mi">32350</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">32892</span> <span class="mi">12012</span> <span class="mi">32346</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">32892</span> <span class="mi">11984</span> <span class="mi">32349</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">28864</span>  <span class="mi">7952</span> <span class="mi">32347</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">28864</span>  <span class="mi">7956</span> <span class="mi">32348</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
 <span class="mi">27708</span>  <span class="mi">5624</span> <span class="mi">32342</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
  <span class="mi">8688</span>  <span class="mi">1924</span>  <span class="mi">3089</span> <span class="n">sendmail</span><span class="o">:</span> <span class="n">MTA</span><span class="o">:</span> <span class="n">accepting</span> <span class="n">connections</span>          
  <span class="mi">8136</span>  <span class="mi">2924</span> <span class="mi">32338</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">sendmail</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">FCronDaemon</span> <span class="o">-</span><span class="n">oem</span> <span class="n">root</span>
  <span class="mi">8096</span>  <span class="mi">2804</span> <span class="mi">20387</span> <span class="n">sshd</span><span class="o">:</span> <span class="n">root</span><span class="err">@</span><span class="n">pts</span><span class="o">/</span><span class="mi">0</span> 
  <span class="mi">8096</span>  <span class="mi">2756</span> <span class="mi">23759</span> <span class="n">sshd</span><span class="o">:</span> <span class="n">root</span><span class="err">@</span><span class="n">pts</span><span class="o">/</span><span class="mi">1</span> 
  <span class="mi">5304</span>  <span class="mi">1084</span>  <span class="mi">1547</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">sshd</span>
</pre></div>


<h3 id="_66">动态显示系统程序情况</h3>
<div class="hlcode"><pre><span class="n">top</span>
</pre></div>


<p>显示 <a href="http://wiki.ubuntu.org.cn/index.php?title=File:Vps_top.png&amp;variant=zh-cn" title="Image:Vps_top.png"><img alt="Image:Vps_top.png" src="http://wiki.ubuntu.org.cn/images/f/f6/Vps_top.png" /></a></p>
<h3 id="mysql_6">mysql 常用命令</h3>
<p>mysql 创建数据库 </p>
<div class="hlcode"><pre><span class="n">mysqladmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="n">create</span> <span class="err">数据库名</span>
</pre></div>


<p>mysql 删除数据库 </p>
<div class="hlcode"><pre><span class="n">mysqladmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="n">drop</span> <span class="err">数据库名</span>
</pre></div>


<p>mysql 创建用户 </p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="err">数据库名</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;用户名</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;密码&#39;</span> <span class="n">WITH</span> <span class="n">GRANT</span> <span class="n">OPTION</span><span class="p">;</span>
</pre></div>


<p>mysql 修复表 </p>
<div class="hlcode"><pre><span class="n">mysqlcheck</span> <span class="o">-</span><span class="n">A</span> <span class="o">--</span><span class="k">auto</span><span class="o">-</span><span class="n">repair</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p>mysql 手工恢复 phpmyadmin 备份的 sql 文件 xxxx.sql 是你备份的sql文件名。 </p>
<div class="hlcode"><pre> <span class="n">mysql</span> <span class="o">-</span><span class="n">p</span> <span class="err">数据库名</span> <span class="o">&lt;</span> <span class="n">xxxx</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>手工备份单个 mysql 数据库 xxxx.sql 是你备份的sql文件名。 </p>
<div class="hlcode"><pre><span class="n">mysqldump</span> <span class="o">-</span><span class="n">p</span> <span class="err">数据库名</span> <span class="o">&gt;</span> <span class="n">xxxx</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>修改mysql的root的密码 </p>
<div class="hlcode"><pre><span class="n">mysqladmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="n">password</span> <span class="err">&#39;新密码&#39;</span>
</pre></div>


<p>mysql 无法启动的处理 </p>
<p>运行 mysqld_safe --user=mysql </p>
<p>然后 tail -n 50 /var/log/syslog 看日志，根据错误来判断 </p>
<p>如果提示日志不存在，运行： apt-get install rsyslog 安装日志服务。 </p>
<h3 id="_67">在线解压缩</h3>
<p>解压缩 xxx.zip </p>
<div class="hlcode"><pre><span class="n">unzip</span> <span class="n">xxx</span><span class="p">.</span><span class="n">zip</span>
</pre></div>


<p>解压缩 xxx.tar.gz </p>
<div class="hlcode"><pre><span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">xxx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>解压缩 xxx.tar.bz2 </p>
<div class="hlcode"><pre><span class="n">tar</span> <span class="o">-</span><span class="n">xjvf</span> <span class="n">xxx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">bz2</span>
</pre></div>


<p>压缩aaa bbb目录为xxx.tar.gz </p>
<div class="hlcode"><pre><span class="n">tar</span> <span class="o">-</span><span class="n">zcvf</span> <span class="n">xxx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="n">aaa</span> <span class="n">bbb</span>
</pre></div>


<p>压缩aaa bbb目录为xxx.tar.bz2 </p>
<div class="hlcode"><pre><span class="n">tar</span> <span class="o">-</span><span class="n">jcvf</span> <span class="n">xxx</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">bz2</span> <span class="n">aaa</span> <span class="n">bbb</span>
</pre></div>


<h3 id="ipip">封掉某个IP或IP段</h3>
<p>只是运行后封掉，由于未保存所以重启后失效，对 192.168.2.0 或 192.168.2.23 进行封掉： </p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">filter</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168.2.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">filter</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168.2.23</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<h3 id="_68">查看日志</h3>
<p>如果需要查看访问日志，请查看 /var/log/ 文件夹，所有的日志都在这个目录下。 </p>
<h3 id="_69">查看网络流量</h3>
<p>执行如下命令安装nload </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nload</span>
</pre></div>


<p>安装完毕后，xen的直接运行nload，即可查看，openvz的运行 nload venet0 查看带宽。 </p>
<h3 id="_70">更多命令参考</h3>
<div class="hlcode"><pre><span class="err">点击查看</span> <span class="p">[</span><span class="n">Ubuntu</span> <span class="err">技巧</span><span class="p">][</span><span class="mi">119</span><span class="p">]</span>
</pre></div>


<h2 id="_71">根据压力测试来调整最大并发数</h2>
<p>因为VPS的内存是有限的，如果不限制最大并发数，会照成内存爆掉或负载过高。内存爆掉，对于openvz的管理会kill掉最耗内存的程序，这样很可能杀掉web服务和sshd服务，表现形式为，vps可以ping通，但网站打不开，也无法登录，需要到面板重启vps才正常；如果负载大于3则会导致VPS由于滥用被官方冻结。如果已经发生了上述现象，请尽快按如下步骤进行调整。 </p>
<h3 id="_72">测试内存的使用情况</h3>
<p>使用 putty 登录到到 vps 输入命令 free 即可看到当前内存的使用情况，如下所示： </p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">241541</span><span class="o">:~</span><span class="err">#</span> <span class="n">free</span>
            <span class="n">total</span>       <span class="n">used</span>       <span class="n">free</span>     <span class="n">shared</span>    <span class="n">buffers</span>     <span class="n">cached</span>
<span class="nl">Mem:</span>        <span class="mi">524800</span>     <span class="mi">296004</span>     <span class="mi">228796</span>          <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">0</span>
<span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="n">cache</span><span class="o">:</span>     <span class="mi">296004</span>     <span class="mi">228796</span>
<span class="nl">Swap:</span>            <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">0</span>
</pre></div>


<p>全部内存为 524800 K，已经使用 296004 K 剩余 228796 K，也就是还剩余 228 M的内存。 </p>
<p>如果需要长时间监控，使用如下命令： </p>
<div class="hlcode"><pre><span class="n">watch</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="n">free</span>
</pre></div>


<h3 id="_73">安装压力测试软件</h3>
<p>我们这里使用 ab 软件，作为我们的压力测试软件。 </p>
<p>使用 apache2的 vps 已经自带了，如果使用nginx的vps，需要安装 apache2-utils 包，使用如下命令安装。 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">apache2</span><span class="o">-</span><span class="n">utils</span>
</pre></div>


<h3 id="_74">开始压力测试</h3>
<p>你的站点都已经配置完整，需要找一个动态页面，最好内容多一点的，这里采用 <a href="http://www.test.com/index.php" title="http://www.test.com/index.php">http://www.test.com/index.php</a> 作为测试页面。 </p>
<p>在 putty 里面输入如下，将每秒刷新一次显示内存情况： </p>
<div class="hlcode"><pre><span class="n">watch</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="n">free</span>
</pre></div>


<p>重点在于观察位于 free 单词下面的数字。 </p>
<p>再开一个putty，输入我们要进行的压力测试命令如下，其中测试网址修改为你自己的测试网址： </p>
<div class="hlcode"><pre><span class="n">ab</span> <span class="o">-</span><span class="n">n</span> <span class="mi">100</span> <span class="o">-</span><span class="n">c</span> <span class="mi">5</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.test.com/index.php</span>
</pre></div>


<p>这个命令是按 5 个并发，做100次请求 ，注意看内存情况，如果出现内存小于50M的情况，表示非常危险了。 </p>
<p>执行完毕的结果如下： </p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="mi">241541</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ab</span> <span class="o">-</span><span class="n">n</span> <span class="mi">100</span> <span class="o">-</span><span class="n">c</span> <span class="mi">5</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.test.com/index.php</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">ApacheBench</span><span class="p">,</span> <span class="n">Version</span> <span class="mf">2.0.40</span><span class="o">-</span><span class="n">dev</span> <span class="o">&lt;</span><span class="err">$</span><span class="n">Revision</span><span class="o">:</span> <span class="mf">1.146</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">apache</span><span class="o">-</span><span class="mf">2.0</span>
<span class="n">Copyright</span> <span class="mi">1996</span> <span class="n">Adam</span> <span class="n">Twiss</span><span class="p">,</span> <span class="n">Zeus</span> <span class="n">Technology</span> <span class="n">Ltd</span><span class="p">,</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.zeustech.net/</span>
<span class="n">Copyright</span> <span class="mi">2006</span> <span class="n">The</span> <span class="n">Apache</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">,</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.apache.org/</span>

<span class="n">Benchmarking</span> <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="p">(</span><span class="n">be</span> <span class="n">patient</span><span class="p">).....</span><span class="n">done</span>


<span class="n">Server</span> <span class="n">Software</span><span class="o">:</span>        <span class="n">Apache</span><span class="o">/</span><span class="mf">2.2.16</span>
<span class="n">Server</span> <span class="n">Hostname</span><span class="o">:</span>        <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span>
<span class="n">Server</span> <span class="n">Port</span><span class="o">:</span>            <span class="mi">80</span>

<span class="n">Document</span> <span class="n">Path</span><span class="o">:</span>          <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span>
<span class="n">Document</span> <span class="n">Length</span><span class="o">:</span>        <span class="mi">56446</span> <span class="n">bytes</span>

<span class="n">Concurrency</span> <span class="n">Level</span><span class="o">:</span>      <span class="mi">5</span>
<span class="n">Time</span> <span class="n">taken</span> <span class="k">for</span> <span class="n">tests</span><span class="o">:</span>   <span class="mf">53.147069</span> <span class="n">seconds</span>
<span class="n">Complete</span> <span class="n">requests</span><span class="o">:</span>      <span class="mi">100</span>
<span class="n">Failed</span> <span class="n">requests</span><span class="o">:</span>        <span class="mi">0</span>
<span class="n">Write</span> <span class="n">errors</span><span class="o">:</span>           <span class="mi">0</span>
<span class="n">Total</span> <span class="n">transferred</span><span class="o">:</span>      <span class="mi">5721547</span> <span class="n">bytes</span>
<span class="n">HTML</span> <span class="n">transferred</span><span class="o">:</span>       <span class="mi">5695792</span> <span class="n">bytes</span>
<span class="n">Requests</span> <span class="n">per</span> <span class="n">second</span><span class="o">:</span>    <span class="mf">1.88</span> <span class="p">[</span><span class="err">#</span><span class="o">/</span><span class="n">sec</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<span class="n">Time</span> <span class="n">per</span> <span class="n">request</span><span class="o">:</span>       <span class="mf">2657.354</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<span class="n">Time</span> <span class="n">per</span> <span class="n">request</span><span class="o">:</span>       <span class="mf">531.471</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">across</span> <span class="n">all</span> <span class="n">concurrent</span> <span class="n">requests</span><span class="p">)</span>
<span class="n">Transfer</span> <span class="n">rate</span><span class="o">:</span>          <span class="mf">105.12</span> <span class="p">[</span><span class="n">Kbytes</span><span class="o">/</span><span class="n">sec</span><span class="p">]</span> <span class="n">received</span>

<span class="n">Connection</span> <span class="n">Times</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>
              <span class="n">min</span>  <span class="n">mean</span><span class="p">[</span><span class="o">+/-</span><span class="n">sd</span><span class="p">]</span> <span class="n">median</span>   <span class="n">max</span>
<span class="nl">Connect:</span>      <span class="mi">218</span>  <span class="mi">219</span>   <span class="mf">2.9</span>    <span class="mi">218</span>     <span class="mi">230</span>
<span class="nl">Processing:</span>  <span class="mi">1463</span> <span class="mi">2407</span> <span class="mf">258.5</span>   <span class="mi">2429</span>    <span class="mi">3126</span>
<span class="nl">Waiting:</span>      <span class="mi">450</span> <span class="mi">1280</span> <span class="mf">217.7</span>   <span class="mi">1291</span>    <span class="mi">1832</span>
<span class="nl">Total:</span>       <span class="mi">1681</span> <span class="mi">2627</span> <span class="mf">258.6</span>   <span class="mi">2648</span>    <span class="mi">3344</span>

<span class="n">Percentage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">requests</span> <span class="n">served</span> <span class="n">within</span> <span class="n">a</span> <span class="n">certain</span> <span class="n">time</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">%</span>   <span class="mi">2648</span>
  <span class="mi">66</span><span class="o">%</span>   <span class="mi">2691</span>
  <span class="mi">75</span><span class="o">%</span>   <span class="mi">2759</span>
  <span class="mi">80</span><span class="o">%</span>   <span class="mi">2818</span>
  <span class="mi">90</span><span class="o">%</span>   <span class="mi">2885</span>
  <span class="mi">95</span><span class="o">%</span>   <span class="mi">3093</span>
  <span class="mi">98</span><span class="o">%</span>   <span class="mi">3339</span>
  <span class="mi">99</span><span class="o">%</span>   <span class="mi">3344</span>
 <span class="mi">100</span><span class="o">%</span>   <span class="mi">3344</span> <span class="p">(</span><span class="n">longest</span> <span class="n">request</span><span class="p">)</span>
</pre></div>


<p>这个结果中需要掌握的有： </p>
<p>成功完成的请求数： Complete requests: 100 </p>
<p>失败的请求数： Failed requests: 0 </p>
<p>每秒完成的请求数： Requests per second: 1.88 [#/sec] (mean) </p>
<p>执行每个请求需要的时间(也就是用户打开这个页面的最快时间)： Time per request: 2657.354 [ms] (mean) </p>
<h3 id="_75">进一步压力测试</h3>
<p>在内存还有剩余的情况下，我们继续增加压力测试的并发数，可以慢慢增加， </p>
<p>当这边的内存监控窗口出现低于50M的时候，就表示这个数值为这个vps可以承受的最大并发数。 </p>
<p>出现低于50M可以内存的情况如下，表示这个站只能支撑8个并发访问不会挂掉： </p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="mi">241541</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ab</span> <span class="o">-</span><span class="n">n</span> <span class="mi">100</span> <span class="o">-</span><span class="n">c</span> <span class="mi">8</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.test.com/index.php</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">ApacheBench</span><span class="p">,</span> <span class="n">Version</span> <span class="mf">2.0.40</span><span class="o">-</span><span class="n">dev</span> <span class="o">&lt;</span><span class="err">$</span><span class="n">Revision</span><span class="o">:</span> <span class="mf">1.146</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">apache</span><span class="o">-</span><span class="mf">2.0</span>
<span class="n">Copyright</span> <span class="mi">1996</span> <span class="n">Adam</span> <span class="n">Twiss</span><span class="p">,</span> <span class="n">Zeus</span> <span class="n">Technology</span> <span class="n">Ltd</span><span class="p">,</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.zeustech.net/</span>
<span class="n">Copyright</span> <span class="mi">2006</span> <span class="n">The</span> <span class="n">Apache</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">,</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.apache.org/</span>

<span class="n">Benchmarking</span> <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span> <span class="p">(</span><span class="n">be</span> <span class="n">patient</span><span class="p">).....</span><span class="n">done</span>


<span class="n">Server</span> <span class="n">Software</span><span class="o">:</span>        <span class="n">Apache</span><span class="o">/</span><span class="mf">2.2.16</span>
<span class="n">Server</span> <span class="n">Hostname</span><span class="o">:</span>        <span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span>
<span class="n">Server</span> <span class="n">Port</span><span class="o">:</span>            <span class="mi">80</span>

<span class="n">Document</span> <span class="n">Path</span><span class="o">:</span>          <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span>
<span class="n">Document</span> <span class="n">Length</span><span class="o">:</span>        <span class="mi">56446</span> <span class="n">bytes</span>

<span class="n">Concurrency</span> <span class="n">Level</span><span class="o">:</span>      <span class="mi">8</span>
<span class="n">Time</span> <span class="n">taken</span> <span class="k">for</span> <span class="n">tests</span><span class="o">:</span>   <span class="mf">41.779898</span> <span class="n">seconds</span>
<span class="n">Complete</span> <span class="n">requests</span><span class="o">:</span>      <span class="mi">100</span>
<span class="n">Failed</span> <span class="n">requests</span><span class="o">:</span>        <span class="mi">0</span>
<span class="n">Write</span> <span class="n">errors</span><span class="o">:</span>           <span class="mi">0</span>
<span class="n">Total</span> <span class="n">transferred</span><span class="o">:</span>      <span class="mi">5670100</span> <span class="n">bytes</span>
<span class="n">HTML</span> <span class="n">transferred</span><span class="o">:</span>       <span class="mi">5644600</span> <span class="n">bytes</span>
<span class="n">Requests</span> <span class="n">per</span> <span class="n">second</span><span class="o">:</span>    <span class="mf">2.39</span> <span class="p">[</span><span class="err">#</span><span class="o">/</span><span class="n">sec</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<span class="n">Time</span> <span class="n">per</span> <span class="n">request</span><span class="o">:</span>       <span class="mf">3342.392</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<span class="n">Time</span> <span class="n">per</span> <span class="n">request</span><span class="o">:</span>       <span class="mf">417.799</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">across</span> <span class="n">all</span> <span class="n">concurrent</span> <span class="n">requests</span><span class="p">)</span>
<span class="n">Transfer</span> <span class="n">rate</span><span class="o">:</span>          <span class="mf">132.53</span> <span class="p">[</span><span class="n">Kbytes</span><span class="o">/</span><span class="n">sec</span><span class="p">]</span> <span class="n">received</span>

<span class="n">Connection</span> <span class="n">Times</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>
              <span class="n">min</span>  <span class="n">mean</span><span class="p">[</span><span class="o">+/-</span><span class="n">sd</span><span class="p">]</span> <span class="n">median</span>   <span class="n">max</span>
<span class="nl">Connect:</span>      <span class="mi">218</span>  <span class="mi">218</span>   <span class="mf">0.9</span>    <span class="mi">218</span>     <span class="mi">223</span>
<span class="nl">Processing:</span>  <span class="mi">1684</span> <span class="mi">3021</span> <span class="mf">461.5</span>   <span class="mi">3087</span>    <span class="mi">4525</span>
<span class="nl">Waiting:</span>      <span class="mi">495</span> <span class="mi">1820</span> <span class="mf">418.3</span>   <span class="mi">1927</span>    <span class="mi">3165</span>
<span class="nl">Total:</span>       <span class="mi">1903</span> <span class="mi">3239</span> <span class="mf">461.6</span>   <span class="mi">3307</span>    <span class="mi">4744</span>

<span class="n">Percentage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">requests</span> <span class="n">served</span> <span class="n">within</span> <span class="n">a</span> <span class="n">certain</span> <span class="n">time</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">%</span>   <span class="mi">3307</span>
  <span class="mi">66</span><span class="o">%</span>   <span class="mi">3384</span>
  <span class="mi">75</span><span class="o">%</span>   <span class="mi">3452</span>
  <span class="mi">80</span><span class="o">%</span>   <span class="mi">3521</span>
  <span class="mi">90</span><span class="o">%</span>   <span class="mi">3654</span>
  <span class="mi">95</span><span class="o">%</span>   <span class="mi">3763</span>
  <span class="mi">98</span><span class="o">%</span>   <span class="mi">4695</span>
  <span class="mi">99</span><span class="o">%</span>   <span class="mi">4744</span>
 <span class="mi">100</span><span class="o">%</span>   <span class="mi">4744</span> <span class="p">(</span><span class="n">longest</span> <span class="n">request</span><span class="p">)</span>
</pre></div>


<p>在8个并发的情况下，用户打开这个网页最快也需要3.3秒。 </p>
<h3 id="_76">配置并发参数</h3>
<p>根据上面的压力测试情况去配置相应最大的并发为当前测试的值，上例中，我们测试出的最大并发为 8. </p>
<p>Apache2 参考： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=Vps&amp;variant=zh-cn#Apache2_.E4.BC.98.E5.8C.96" title="Vps">Apache2 的优化</a></p>
<p>Nginx 参考： </p>
<p><a href="http://wiki.ubuntu.org.cn/index.php?title=Vps&amp;variant=zh-cn#nginx_.E4.BC.98.E5.8C.96" title="Vps">Nginx 的优化</a></p>
<h2 id="_77">常见故障</h2>
<h3 id="temporary-failure-resolving">"Temporary failure resolving" 或 正在解析主机...失败，未知的名称或服务</h3>
<p>使用 wget 或 apt-get 时出现上面的提示，是官方的dns服务器出现故障了，采用如下命令修复： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="n">nameserver</span> <span class="mf">8.8.8.8</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">resolv</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>或者 </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="n">dns</span><span class="o">-</span><span class="n">nameservers</span> <span class="mf">8.8.8.8</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">interfaces</span>
</pre></div>


<h3 id="locale-cannot-set-lc_all-to-default-locale-no-such-file-or-directory">"locale: Cannot set LC_ALL to default locale: No such file or directory"</h3>
<p>如果出现如下故障提示： </p>
<div class="hlcode"><pre><span class="n">perl</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">locale</span> <span class="n">failed</span><span class="o">.</span>
<span class="n">perl</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Please</span> <span class="n">check</span> <span class="n">that</span> <span class="n">your</span> <span class="n">locale</span> <span class="n">settings</span><span class="o">:</span>
        <span class="n">LANGUAGE</span> <span class="o">=</span> <span class="o">(</span><span class="n">unset</span><span class="o">),</span>
        <span class="n">LC_ALL</span> <span class="o">=</span> <span class="o">(</span><span class="n">unset</span><span class="o">),</span>
        <span class="n">LANG</span> <span class="o">=</span> <span class="s2">&quot;zh_CN.UTF-8&quot;</span>
    <span class="n">are</span> <span class="n">supported</span> <span class="n">and</span> <span class="n">installed</span> <span class="n">on</span> <span class="n">your</span> <span class="n">system</span><span class="o">.</span>
<span class="n">perl</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">Falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">locale</span> <span class="o">(</span><span class="s2">&quot;C&quot;</span><span class="o">).</span>
<span class="n">locale</span><span class="o">:</span> <span class="n">Cannot</span> <span class="kd">set</span> <span class="n">LC_CTYPE</span> <span class="n">to</span> <span class="k">default</span> <span class="n">locale</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="n">locale</span><span class="o">:</span> <span class="n">Cannot</span> <span class="kd">set</span> <span class="n">LC_MESSAGES</span> <span class="n">to</span> <span class="k">default</span> <span class="n">locale</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="n">locale</span><span class="o">:</span> <span class="n">Cannot</span> <span class="kd">set</span> <span class="n">LC_ALL</span> <span class="n">to</span> <span class="k">default</span> <span class="n">locale</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
</pre></div>


<p>虽然不影响使用，可以使用下面的命令解决： </p>
<div class="hlcode"><pre><span class="n">locale</span><span class="o">-</span><span class="n">gen</span> <span class="o">--</span><span class="n">lang</span> <span class="n">zh_CN</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">locales</span>
</pre></div>


<h3 id="_78">修正时区</h3>
<p>使用如下命令调整本地的系统的时区为上海。 </p>
<div class="hlcode"><pre><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>
</pre></div>


<h3 id="gbkgb2312">开启 GBK/GB2312 支持</h3>
<p>使用如下命令在 local 文件中增加 GBK/GB2312： </p>
<div class="hlcode"><pre><span class="n">echo</span> <span class="s">&quot;zh_CN.GBK GBK&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locales</span><span class="o">/</span><span class="n">supported</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">local</span> 
<span class="n">echo</span> <span class="s">&quot;zh_CN.GB2312 GB2312&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locales</span><span class="o">/</span><span class="n">supported</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">local</span>
</pre></div>


<p>然后运行： </p>
<div class="hlcode"><pre><span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="o">--</span><span class="n">force</span> <span class="n">locales</span>
</pre></div>


<p>即可支持了。 </p>
<h3 id="cron">修复cron问题</h3>
<div class="hlcode"><pre><span class="cp">#检查cron的任务文件名是否包括 . ，如果有扩展名会导致无法运行，</span>
<span class="cp">#可以使用如下命令检查 run-parts --test /etc/cron.daily</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">anacron</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span> <span class="n">restart</span>
</pre></div>


<h3 id="_79">禁止执行的命令</h3>
<p>以下命令是严格禁止的，运行后直接导致数据丢失或vps无法正常启动，如果遇到有人建议你运行如下命令，请停止。 </p>
<p>系统所有文件被删除 </p>
<div class="hlcode"><pre><span class="n">rm</span> <span class="o">-</span><span class="n">fr</span> <span class="o">/</span>
</pre></div>


<p>系统权限混乱，启动错误，无法ssh连接 </p>
<div class="hlcode"><pre><span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="mi">777</span> <span class="o">/</span>
</pre></div>


<p>系统损坏，数据丢失 </p>
<div class="hlcode"><pre><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">xxx</span>
</pre></div>


<p>如果遇到有人建议你，运行包括 rm 、 chmod 、 dd 等命令，请慎重。 </p>
<h3 id="mtr">使用 mtr 检测网络丢包</h3>
<p>有时我们发现 ping 丢包，因此需要通过 mtr 来定位故障的位置，使用 mtr 需要双向运行，才可以比较准确的发现故障点。 </p>
<p>VPS上安装 mtr ： </p>
<ul>
<li>
<p>Ubuntu Linux</p>
<p>apt-get install mtr</p>
</li>
<li>
<p>Centos Linux</p>
<p>yum install mtr</p>
</li>
</ul>
<p>访问 [http://ip.cn][123] 获得本地的公网地址，从VPS执行如下命令： </p>
<div class="hlcode"><pre>   <span class="p">[</span><span class="mi">123</span><span class="p">]</span><span class="o">:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//ip.cn (http://ip.cn)</span>
</pre></div>


<p>mtr -n --report 本地公网地址</p>
<p>获得路由的丢包位置。 </p>
<p>然后本地 Windows 上安装 mtr: </p>
<p>下载地址： <a href="http://winmtr.net/download-winmtr/" title="http://winmtr.net/download-winmtr/">http://winmtr.net/download-winmtr/</a></p>
<p>下载运行后，直接输入VPS的IP进行测试。 </p>
<p>最后两边对比结果，就可以准确的找到出问题的路由地址。 </p>
<p>找到丢包路由器的IP后，通过 <a href="http://ip.cn" title="http://ip.cn">http://ip.cn</a> 去查询该路由器IP的所在地。如果该IP在国内，只能等待了；如果在国外，可以尝试去报障，要求官方协调解决。 </p>
<h3 id="vps_1">VPS之间备份、下载、上传需要限速</h3>
<p>由于美国VPS之间的速度是200M共享，所以很容易达到满速，这样会导致带宽滥用封掉，所以必须限速，以下按1M限速： </p>
<h4 id="_80">常用软件限速</h4>
<p>wget/scp/rsync/lftp 等常用客户端下载限速如下。 </p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="o">--</span><span class="n">limit</span><span class="o">-</span><span class="n">rate</span><span class="o">=</span><span class="mi">1024</span><span class="n">k</span> <span class="p">......</span>
<span class="n">scp</span> <span class="o">-</span><span class="n">l</span>  <span class="mi">8196</span> <span class="p">......</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">auvzP</span> <span class="o">--</span><span class="n">bwlimit</span><span class="o">=</span><span class="mi">1024</span> <span class="o">--</span><span class="n">size</span><span class="o">-</span><span class="n">only</span> <span class="p">......</span>
<span class="n">lftp</span> <span class="o">:~&gt;</span> <span class="n">set</span> <span class="n">net</span><span class="o">:</span><span class="n">limit</span><span class="o">-</span><span class="n">rate</span> <span class="mi">1024000</span><span class="p">,</span><span class="mi">1024000</span>
</pre></div>


<h4 id="trickle">采用 trickle 限速</h4>
<p>也可以使用 trickle 来限速，安装 trickle 使用如下命令 </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">trickle</span>
</pre></div>


<p>运行如下命令，限制 wget 的上传速度和下载速度为1M，其中 -d 后面是下载速度，-u 后面是上传速度，以K为单位： </p>
<div class="hlcode"><pre><span class="n">trickle</span> <span class="o">-</span><span class="n">d</span> <span class="mi">1024</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1024</span> <span class="n">wget</span> <span class="p">....</span>
</pre></div>


<p>Dropbox 限速： </p>
<div class="hlcode"><pre><span class="n">trickle</span> <span class="o">-</span><span class="n">d</span> <span class="mi">1024</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1024</span> <span class="o">~/</span><span class="p">.</span><span class="n">dropbox</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="n">dropboxd</span>
</pre></div>


<h3 id="lnmp">快速安装配置lnmp的命令</h3>
<p>删除Apache2： </p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">stop</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">remove</span> <span class="n">apache2</span> <span class="n">apache2</span><span class="mf">.2</span><span class="o">-</span><span class="n">common</span>
</pre></div>


<p>安装 php nginx </p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">curl</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="n">nginx</span>
</pre></div>


<p>配置 nginx： </p>
<div class="hlcode"><pre><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">chown</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="n">usr</span><span class="err">\</span><span class="o">/</span><span class="n">share</span><span class="err">\</span><span class="o">/</span><span class="n">nginx</span><span class="err">\</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="n">var</span><span class="err">\</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">#\</span><span class="p">(</span><span class="n">location</span><span class="p">.</span><span class="o">*</span><span class="n">php</span><span class="err">\</span><span class="p">)</span><span class="o">/</span><span class="err">\</span><span class="mi">1</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span> 
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">#\</span><span class="p">(.</span><span class="o">*</span><span class="n">fastcgi_split_path_info</span><span class="err">\</span><span class="p">)</span><span class="o">/</span><span class="err">\</span><span class="mi">1</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">#\</span><span class="p">(.</span><span class="o">*</span><span class="n">fastcgi_pass</span><span class="p">.</span><span class="o">*</span><span class="mi">9000</span><span class="err">\</span><span class="p">)</span><span class="o">/</span><span class="err">\</span><span class="mi">1</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">#\</span><span class="p">(.</span><span class="o">*</span><span class="n">fastcgi_index</span><span class="err">\</span><span class="p">)</span><span class="o">/</span><span class="err">\</span><span class="mi">1</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">#\</span><span class="p">(.</span><span class="o">*</span><span class="n">fastcgi_params</span><span class="err">\</span><span class="p">)</span><span class="o">/</span><span class="err">\</span><span class="mi">1</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="o">/</span><span class="p">{</span> <span class="n">n</span><span class="p">;</span> <span class="n">s</span><span class="o">/</span><span class="err">#</span><span class="p">}</span><span class="o">/</span><span class="p">}</span><span class="o">/</span><span class="p">;</span> <span class="p">}</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="k">default</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">restart</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">restart</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Tsong khapa.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-10-02 22:54:23</p>
      </span>
    </div>

    
    
  </body>
</html>